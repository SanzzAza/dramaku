<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>DramaCin</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&family=Poppins:wght@400;500;600;700;900&display=swap" rel="stylesheet">
<style>
:root {
  --primary: #F5A623;
  --primary-dark: #E0911A;
  --primary-light: #FFF3DC;
  --bg: #F7F8FA;
  --card: #FFFFFF;
  --text: #1A1A2E;
  --muted: #8A8FAB;
  --border: #ECEEF5;
  --nav: 62px;
  --radius: 16px;
  --sh: 0 4px 20px rgba(0,0,0,0.08);
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%;overflow:hidden;font-family:'Nunito',sans-serif;background:var(--bg);color:var(--text)}

/* â”€â”€ SCREENS â”€â”€ */
.screen{position:absolute;inset:0;display:none;flex-direction:column;background:var(--bg)}
.screen.active{display:flex}
.scroll{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none;padding-bottom:calc(var(--nav) + 8px)}
.scroll::-webkit-scrollbar{display:none}

/* â”€â”€ TOP BAR â”€â”€ */
.topbar{height:54px;background:#fff;display:flex;align-items:center;padding:0 16px;gap:10px;border-bottom:1px solid var(--border);flex-shrink:0;z-index:10}
.logo{font-family:'Poppins',sans-serif;font-weight:900;font-size:20px;color:var(--primary);letter-spacing:-0.5px}
.logo b{color:var(--text)}
.topbar-right{margin-left:auto;display:flex;gap:8px}
.icon-btn{width:34px;height:34px;background:var(--bg);border-radius:50%;border:none;font-size:17px;display:flex;align-items:center;justify-content:center;cursor:pointer}

/* â”€â”€ BOTTOM NAV â”€â”€ */
.bnav{position:fixed;bottom:0;left:0;right:0;height:var(--nav);background:#fff;border-top:1px solid var(--border);display:flex;z-index:100;box-shadow:0 -2px 12px rgba(0,0,0,0.06)}
.nitem{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;border:none;background:none;cursor:pointer;font-family:'Nunito',sans-serif;font-size:10px;font-weight:700;color:var(--muted);transition:color .2s}
.nitem .ni{font-size:21px;transition:transform .2s}
.nitem.active{color:var(--primary)}
.nitem.active .ni{transform:scale(1.18)}

/* â”€â”€ HERO BANNER â”€â”€ */
.hero{margin:12px;border-radius:var(--radius);overflow:hidden;position:relative;height:195px;background:#1a1a2e;flex-shrink:0}
.hero-img{width:100%;height:100%;object-fit:cover;opacity:.65}
.hero-grad{position:absolute;inset:0;background:linear-gradient(to top,rgba(0,0,0,.88) 0%,transparent 55%)}
.hero-body{position:absolute;bottom:0;left:0;right:0;padding:14px}
.hero-badge{display:inline-flex;align-items:center;gap:4px;background:var(--primary);color:#fff;font-size:10px;font-weight:800;padding:3px 9px;border-radius:20px;margin-bottom:6px;text-transform:uppercase;letter-spacing:.5px}
.hero-title{font-size:17px;font-weight:900;color:#fff;line-height:1.2;margin-bottom:8px}
.hero-row{display:flex;align-items:flex-end;justify-content:space-between}
.hero-meta span{font-size:11px;color:rgba(255,255,255,.75);font-weight:600;margin-right:8px}
.hero-btn{background:var(--primary);color:#fff;border:none;border-radius:20px;padding:7px 16px;font-size:12px;font-weight:800;font-family:'Nunito',sans-serif;cursor:pointer;display:flex;align-items:center;gap:5px}

/* â”€â”€ SECTION â”€â”€ */
.sec{padding:16px 16px 0}
.sec-hd{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.sec-title{font-size:15px;font-weight:900;display:flex;align-items:center;gap:6px}
.see-all{font-size:12px;font-weight:700;color:var(--primary);border:none;background:none;cursor:pointer;font-family:'Nunito',sans-serif}

/* â”€â”€ HORIZONTAL SCROLL CARDS â”€â”€ */
.hscroll{display:flex;gap:11px;overflow-x:auto;padding-bottom:4px;scrollbar-width:none}
.hscroll::-webkit-scrollbar{display:none}
.dcard{flex-shrink:0;width:112px;cursor:pointer}
.dcard-img{width:112px;height:158px;border-radius:12px;overflow:hidden;position:relative;background:#ddd;display:block}
.dcard-img img{width:100%;height:100%;object-fit:cover}
.ep-badge{position:absolute;bottom:6px;left:6px;background:rgba(0,0,0,.72);color:#fff;font-size:10px;font-weight:700;padding:2px 6px;border-radius:6px}
.dcard-title{font-size:11px;font-weight:700;margin-top:6px;line-height:1.3;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.dcard-star{font-size:10px;color:var(--muted);margin-top:2px;font-weight:600}

/* â”€â”€ RANK LIST â”€â”€ */
.rlist{display:flex;flex-direction:column;gap:9px;padding:0 16px}
.rcard{background:#fff;border-radius:14px;padding:11px;display:flex;align-items:center;gap:11px;cursor:pointer;box-shadow:var(--sh)}
.rnum{font-size:22px;font-weight:900;font-family:'Poppins',sans-serif;min-width:30px;text-align:center}
.rnum.g{color:#FFD700}.rnum.s{color:#C0C0C0}.rnum.b{color:#CD7F32}.rnum.n{color:var(--muted);font-size:16px}
.rcov{width:50px;height:68px;border-radius:9px;object-fit:cover;background:linear-gradient(135deg,#f093fb,#f5576c);flex-shrink:0}
.rinfo{flex:1;min-width:0}
.rtitle{font-size:13px;font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.rmeta{font-size:11px;color:var(--muted);margin-top:2px;font-weight:600}
.rscore{font-size:12px;font-weight:800;color:var(--primary)}

/* â”€â”€ SEARCH â”€â”€ */
.sbox{margin:12px;background:#fff;border-radius:14px;padding:11px 15px;display:flex;align-items:center;gap:9px;border:2px solid var(--border);transition:border-color .2s}
.sbox:focus-within{border-color:var(--primary)}
.sbox input{flex:1;border:none;background:none;font-family:'Nunito',sans-serif;font-size:14px;color:var(--text);outline:none}
.sbox input::placeholder{color:var(--muted)}
.sbtn{background:var(--primary);color:#fff;border:none;border-radius:10px;padding:7px 14px;font-size:12px;font-weight:800;font-family:'Nunito',sans-serif;cursor:pointer}
.tags{display:flex;flex-wrap:wrap;gap:7px;padding:0 16px;margin-bottom:14px}
.tag{background:var(--primary-light);color:var(--primary-dark);border:none;border-radius:20px;padding:6px 13px;font-size:12px;font-weight:700;font-family:'Nunito',sans-serif;cursor:pointer}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:11px;padding:0 16px}
.gcrd{cursor:pointer}
.gcrd-img{width:100%;aspect-ratio:3/4;border-radius:13px;overflow:hidden;position:relative}
.gcrd-img img{width:100%;height:100%;object-fit:cover}
.grank{position:absolute;top:7px;left:7px;background:var(--primary);color:#fff;font-size:11px;font-weight:900;padding:3px 8px;border-radius:20px;font-family:'Poppins',sans-serif}
.gcrd-title{font-size:12px;font-weight:800;margin-top:7px;line-height:1.3;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}

/* â”€â”€ DETAIL SCREEN â”€â”€ */
.det-hero{position:relative;height:270px;background:#111;flex-shrink:0}
.det-cover{width:100%;height:100%;object-fit:cover;opacity:.45}
.det-overlay{position:absolute;inset:0;background:linear-gradient(to top,var(--bg) 0%,transparent 48%)}
.back-btn{position:absolute;top:12px;left:12px;background:rgba(0,0,0,.45);border:none;color:#fff;width:36px;height:36px;border-radius:50%;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.det-thumb{position:absolute;bottom:-46px;left:16px;width:96px;height:134px;border-radius:13px;object-fit:cover;box-shadow:0 8px 24px rgba(0,0,0,.28);border:3px solid #fff;background:linear-gradient(135deg,#667eea,#764ba2)}
.det-info{padding:56px 16px 16px}
.det-title{font-size:19px;font-weight:900;line-height:1.2}
.det-meta{display:flex;gap:8px;margin-top:9px;flex-wrap:wrap}
.det-badge{background:var(--primary-light);color:var(--primary-dark);font-size:11px;font-weight:700;padding:3px 10px;border-radius:20px}
.det-desc{font-size:13px;color:var(--muted);line-height:1.6;margin-top:10px;font-weight:600}
.det-desc.col{display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden}
.readmore{background:none;border:none;color:var(--primary);font-size:12px;font-weight:700;cursor:pointer;font-family:'Nunito',sans-serif;margin-top:3px}
.det-actions{display:flex;gap:9px;margin-top:14px}
.btn-pri{flex:1;background:var(--primary);color:#fff;border:none;border-radius:13px;padding:13px;font-size:14px;font-weight:800;font-family:'Nunito',sans-serif;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px}
.btn-sec{background:var(--bg);color:var(--text);border:2px solid var(--border);border-radius:13px;padding:13px 16px;font-size:18px;cursor:pointer;display:flex;align-items:center}
.ep-sec{padding:0 16px 16px}
.ep-title{font-size:14px;font-weight:900;margin-bottom:11px}
.ep-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:7px}
.ep-btn{background:#fff;border:2px solid var(--border);border-radius:9px;padding:9px 4px;font-size:12px;font-weight:800;font-family:'Nunito',sans-serif;cursor:pointer;text-align:center;color:var(--text);transition:all .15s}
.ep-btn.active,.ep-btn:active{background:var(--primary);border-color:var(--primary);color:#fff}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸ¬ TIKTOK VIDEO PLAYER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#screen-watch{background:#000;z-index:200}
.watch-wrap{position:relative;width:100%;height:100%;overflow:hidden}

/* Video container - full screen */
.vid-container{position:absolute;inset:0;background:#000;display:flex;align-items:center;justify-content:center}
video#mainVideo{width:100%;height:100%;object-fit:contain;display:block}

/* Tap overlay to play/pause */
.tap-overlay{position:absolute;inset:0;z-index:10;cursor:pointer}
.tap-ripple{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);pointer-events:none;opacity:0;transition:opacity .3s}
.tap-ripple.show{opacity:1;animation:rippleOut .5s forwards}
@keyframes rippleOut{0%{transform:translate(-50%,-50%) scale(.5);opacity:1}100%{transform:translate(-50%,-50%) scale(1.5);opacity:0}}
.tap-icon{font-size:64px;filter:drop-shadow(0 0 12px rgba(0,0,0,.5))}

/* Top gradient */
.vgrad-top{position:absolute;top:0;left:0;right:0;height:130px;background:linear-gradient(to bottom,rgba(0,0,0,.75),transparent);z-index:20;pointer-events:none}
/* Bottom gradient */
.vgrad-bot{position:absolute;bottom:0;left:0;right:0;height:200px;background:linear-gradient(to top,rgba(0,0,0,.9),transparent);z-index:20;pointer-events:none}

/* Back button */
.v-back{position:absolute;top:14px;left:14px;z-index:30;background:rgba(255,255,255,.15);border:none;color:#fff;width:38px;height:38px;border-radius:50%;font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(4px)}

/* Drama info - bottom left */
.v-info{position:absolute;bottom:80px;left:14px;right:75px;z-index:30;color:#fff}
.v-drama-title{font-size:15px;font-weight:900;line-height:1.3;text-shadow:0 1px 8px rgba(0,0,0,.6)}
.v-ep-label{font-size:12px;font-weight:700;opacity:.85;margin-top:3px}
.v-desc{font-size:12px;opacity:.75;margin-top:4px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;line-height:1.4}

/* Right sidebar action buttons */
.v-actions{position:absolute;bottom:85px;right:12px;z-index:30;display:flex;flex-direction:column;align-items:center;gap:18px}
.v-act-btn{display:flex;flex-direction:column;align-items:center;gap:3px;cursor:pointer;background:none;border:none;color:#fff}
.v-act-icon{width:46px;height:46px;background:rgba(255,255,255,.18);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:22px;backdrop-filter:blur(4px);transition:transform .15s}
.v-act-btn:active .v-act-icon{transform:scale(.88)}
.v-act-label{font-size:10px;font-weight:700;color:rgba(255,255,255,.9)}

/* Episode list bottom sheet */
.ep-sheet{position:absolute;bottom:0;left:0;right:0;z-index:40;background:rgba(15,15,15,.95);backdrop-filter:blur(12px);border-radius:20px 20px 0 0;padding:12px 16px 24px;transform:translateY(100%);transition:transform .3s ease}
.ep-sheet.open{transform:translateY(0)}
.ep-sheet-handle{width:36px;height:4px;background:rgba(255,255,255,.3);border-radius:2px;margin:0 auto 14px}
.ep-sheet-title{color:#fff;font-size:14px;font-weight:900;margin-bottom:12px}
.ep-sheet-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;max-height:220px;overflow-y:auto;scrollbar-width:none}
.ep-sheet-grid::-webkit-scrollbar{display:none}
.ep-sht-btn{background:rgba(255,255,255,.12);border:1.5px solid rgba(255,255,255,.15);border-radius:9px;padding:9px 4px;font-size:12px;font-weight:800;color:#fff;font-family:'Nunito',sans-serif;cursor:pointer;text-align:center;transition:all .15s}
.ep-sht-btn.active{background:var(--primary);border-color:var(--primary)}

/* Seek bar */
.seekbar-wrap{position:absolute;bottom:60px;left:14px;right:14px;z-index:30}
.seekbar{-webkit-appearance:none;appearance:none;width:100%;height:3px;border-radius:2px;background:rgba(255,255,255,.3);outline:none;cursor:pointer}
.seekbar::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;border-radius:50%;background:#fff;cursor:pointer;box-shadow:0 0 6px rgba(0,0,0,.5)}
.time-row{display:flex;justify-content:space-between;margin-top:5px}
.time-row span{font-size:10px;color:rgba(255,255,255,.7);font-weight:600}

/* Episode nav pills bottom */
.ep-nav{position:absolute;bottom:16px;left:0;right:0;z-index:30;display:flex;align-items:center;justify-content:center;gap:10px}
.ep-nav-btn{background:rgba(255,255,255,.18);border:none;color:#fff;border-radius:20px;padding:9px 20px;font-size:13px;font-weight:800;font-family:'Nunito',sans-serif;cursor:pointer;backdrop-filter:blur(4px);display:flex;align-items:center;gap:6px;transition:all .15s}
.ep-nav-btn:active{transform:scale(.94)}
.ep-nav-btn.primary{background:var(--primary)}
.ep-nav-ep{background:rgba(255,255,255,.18);border:none;color:#fff;border-radius:20px;padding:9px 16px;font-size:12px;font-weight:800;font-family:'Nunito',sans-serif;cursor:pointer;backdrop-filter:blur(4px)}

/* Loading / buffering overlay */
.vbuf{position:absolute;inset:0;z-index:25;display:flex;align-items:center;justify-content:center;pointer-events:none}
.vspin{width:48px;height:48px;border:3px solid rgba(255,255,255,.25);border-top-color:#fff;border-radius:50%;animation:spin .7s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* Center play/pause icon flash */
.v-flash{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);z-index:35;pointer-events:none;opacity:0}
.v-flash.show{animation:flashAnim .45s forwards}
@keyframes flashAnim{0%{opacity:1;transform:translate(-50%,-50%) scale(.7)}50%{opacity:1;transform:translate(-50%,-50%) scale(1.1)}100%{opacity:0;transform:translate(-50%,-50%) scale(1.2)}}
.v-flash-icon{font-size:70px;filter:drop-shadow(0 0 20px rgba(0,0,0,.6))}

/* â”€â”€ PROFILE â”€â”€ */
.prof-hd{background:linear-gradient(135deg,var(--primary),#FF6B35);padding:30px 18px 22px;color:#fff;flex-shrink:0}
.prof-av{width:68px;height:68px;border-radius:50%;background:rgba(255,255,255,.28);display:flex;align-items:center;justify-content:center;font-size:30px;margin-bottom:10px;border:3px solid rgba(255,255,255,.45)}
.prof-name{font-size:19px;font-weight:900}
.prof-tag{font-size:13px;opacity:.85;font-weight:600;margin-top:2px}
.vip-card{margin:14px;border-radius:var(--radius);background:linear-gradient(135deg,var(--primary),#FF6B35);padding:18px;color:#fff;position:relative;overflow:hidden}
.vip-card::before{content:'ğŸ‘‘';position:absolute;right:-8px;top:-8px;font-size:75px;opacity:.14}
.vip-card-title{font-size:19px;font-weight:900}
.vip-card-sub{font-size:12px;opacity:.88;margin-top:3px;font-weight:600}
.vip-card-btn{margin-top:12px;background:#fff;color:var(--primary-dark);border:none;border-radius:9px;padding:9px 18px;font-size:12px;font-weight:900;font-family:'Nunito',sans-serif;cursor:pointer}
.pmenu{padding:12px;display:flex;flex-direction:column;gap:2px}
.pitem{background:#fff;border:none;padding:14px;border-radius:13px;display:flex;align-items:center;gap:12px;cursor:pointer;font-family:'Nunito',sans-serif;margin-bottom:2px}
.pitem-ico{font-size:20px;min-width:30px;text-align:center}
.pitem-txt{flex:1;text-align:left}
.pitem-label{font-size:13px;font-weight:800;color:var(--text)}
.pitem-sub{font-size:11px;color:var(--muted);font-weight:600;margin-top:1px}

/* â”€â”€ UTILS â”€â”€ */
.loader{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px;padding:36px}
.spinner{width:32px;height:32px;border:3px solid var(--border);border-top-color:var(--primary);border-radius:50%;animation:spin .7s linear infinite}
.empty{text-align:center;padding:44px 24px;color:var(--muted)}
.empty-ico{font-size:44px;margin-bottom:10px}
.empty-txt{font-size:14px;font-weight:700}
.toast{position:fixed;top:64px;left:50%;transform:translateX(-50%);background:rgba(26,26,46,.92);color:#fff;padding:9px 18px;border-radius:20px;font-size:12px;font-weight:700;z-index:999;opacity:0;pointer-events:none;transition:opacity .3s;white-space:nowrap}
.toast.show{opacity:1}

/* Cover placeholder colors */
.cph{width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;color:#fff;font-size:11px;font-weight:700;text-align:center;padding:8px;line-height:1.3}
</style>
</head>
<body>

<!-- â•â• HOME â•â• -->
<div class="screen active" id="screen-home">
  <div class="topbar">
    <div class="logo">Drama<b>Cin</b></div>
    <div class="topbar-right">
      <button class="icon-btn" onclick="toast('Notifikasi')">ğŸ””</button>
    </div>
  </div>
  <div class="scroll" id="home-scroll">
    <div class="hero" id="hero-wrap">
      <div style="width:100%;height:100%;background:linear-gradient(135deg,#1a1a2e,#2d2d5e);display:flex;align-items:center;justify-content:center;font-size:40px;opacity:.35">ğŸ¬</div>
      <div class="hero-grad"></div>
      <div class="hero-body">
        <div class="hero-row">
          <div>
            <div class="hero-badge">ğŸ”¥ Trending</div>
            <div class="hero-title" id="hero-title">Memuat...</div>
            <div><span class="hero-meta" id="hero-meta"></span></div>
          </div>
          <button class="hero-btn" id="hero-btn">â–¶ Tonton</button>
        </div>
      </div>
    </div>

    <div class="sec">
      <div class="sec-hd">
        <div class="sec-title">ğŸ”¥ Lagi Populer</div>
        <button class="see-all" onclick="switchNav('rank')">Lihat Semua â€º</button>
      </div>
      <div class="hscroll" id="popular-list"><div class="loader"><div class="spinner"></div></div></div>
    </div>

    <div class="sec" style="margin-top:8px">
      <div class="sec-hd">
        <div class="sec-title">ğŸ†• Terbaru</div>
        <button class="see-all" onclick="switchNav('search')">Lihat Semua â€º</button>
      </div>
      <div class="hscroll" id="new-list"><div class="loader"><div class="spinner"></div></div></div>
    </div>
    <div style="height:14px"></div>
  </div>
</div>

<!-- â•â• SEARCH â•â• -->
<div class="screen" id="screen-search">
  <div class="topbar"><div class="logo">Drama<b>Cin</b></div></div>
  <div class="scroll">
    <div class="sbox">
      <span style="font-size:17px">ğŸ”</span>
      <input type="text" id="sinput" placeholder="Cari drama, genre..." onkeydown="if(event.key==='Enter')doSearch()">
      <button class="sbtn" onclick="doSearch()">Cari</button>
    </div>
    <div id="stags-sec">
      <div class="sec" style="padding-top:4px"><div class="sec-hd"><div class="sec-title">ğŸ“ˆ Populer Dicari</div></div></div>
      <div class="tags">
        <button class="tag" onclick="searchKw('cinta')">cinta</button>
        <button class="tag" onclick="searchKw('keluarga')">keluarga</button>
        <button class="tag" onclick="searchKw('balas dendam')">balas dendam</button>
        <button class="tag" onclick="searchKw('pewaris')">pewaris</button>
        <button class="tag" onclick="searchKw('istri')">istri</button>
        <button class="tag" onclick="searchKw('raja')">raja</button>
        <button class="tag" onclick="searchKw('dendam')">dendam</button>
        <button class="tag" onclick="searchKw('pengusaha')">pengusaha</button>
      </div>
      <div class="sec" style="padding-top:0"><div class="sec-hd"><div class="sec-title">ğŸ”¥ Sedang Banyak Dicari</div></div></div>
      <div class="grid2" id="trending-grid"><div class="loader" style="grid-column:span 2"><div class="spinner"></div></div></div>
    </div>
    <div id="sresults-sec" style="display:none">
      <div class="sec"><div class="sec-hd">
        <div class="sec-title" id="sresult-title">Hasil</div>
        <button class="see-all" onclick="clearSearch()">âœ• Tutup</button>
      </div></div>
      <div class="rlist" id="sresults"></div>
    </div>
    <div style="height:14px"></div>
  </div>
</div>

<!-- â•â• RANK â•â• -->
<div class="screen" id="screen-rank">
  <div class="topbar"><div class="logo">Drama<b>Cin</b></div></div>
  <div class="scroll">
    <div class="sec"><div class="sec-hd"><div class="sec-title">ğŸ† Ranking Drama</div></div></div>
    <div class="rlist" id="rank-list"><div class="loader"><div class="spinner"></div></div></div>
    <div style="height:14px"></div>
  </div>
</div>

<!-- â•â• DETAIL â•â• -->
<div class="screen" id="screen-detail">
  <div class="scroll">
    <div class="det-hero">
      <img id="det-cover" class="det-cover" src="" alt="">
      <div class="det-overlay"></div>
      <button class="back-btn" onclick="goBack()">â†</button>
      <img id="det-thumb" class="det-thumb" src="" alt="" onerror="this.style.display='none'">
    </div>
    <div class="det-info">
      <div id="det-title" class="det-title">Loading...</div>
      <div id="det-meta" class="det-meta"></div>
      <div id="det-desc" class="det-desc col">-</div>
      <button class="readmore" id="readmore-btn" onclick="toggleDesc()">Selengkapnya â€º</button>
      <div class="det-actions">
        <button class="btn-pri" id="det-watch-btn">â–¶ Mulai Tonton</button>
        <button class="btn-sec" id="det-fav-btn" onclick="toggleFav()">ğŸ¤</button>
      </div>
    </div>
    <div class="ep-sec">
      <div class="ep-title">ğŸ“‹ Daftar Episode</div>
      <div class="ep-grid" id="det-ep-grid"><div class="loader" style="grid-column:span 5"><div class="spinner"></div></div></div>
    </div>
    <div style="height:80px"></div>
  </div>
</div>

<!-- â•â• WATCH (TikTok Player) â•â• -->
<div class="screen" id="screen-watch">
  <div class="watch-wrap" id="watch-wrap">

    <!-- Video element -->
    <div class="vid-container">
      <video id="mainVideo" playsinline webkit-playsinline preload="auto"
        onwaiting="showBuf()" oncanplay="hideBuf()" onplaying="hideBuf()"
        ontimeupdate="onTimeUpdate()" onended="onVideoEnded()"
        onerror="onVideoError()">
      </video>
    </div>

    <!-- Buffering -->
    <div class="vbuf" id="vbuf" style="display:none"><div class="vspin"></div></div>

    <!-- Tap overlay -->
    <div class="tap-overlay" id="tapOverlay" onclick="tapPlayPause()"></div>

    <!-- Flash icon -->
    <div class="v-flash" id="vflash"><div class="v-flash-icon" id="vflash-icon">â–¶ï¸</div></div>

    <!-- Top gradient & Back -->
    <div class="vgrad-top"></div>
    <button class="v-back" onclick="goBack()">â†</button>

    <!-- Bottom gradient -->
    <div class="vgrad-bot"></div>

    <!-- Seek bar -->
    <div class="seekbar-wrap" id="seekbar-wrap">
      <input type="range" class="seekbar" id="seekbar" value="0" min="0" max="100" step="0.1"
        oninput="onSeekInput()" onchange="onSeekChange()">
      <div class="time-row">
        <span id="time-cur">0:00</span>
        <span id="time-dur">0:00</span>
      </div>
    </div>

    <!-- Drama info bottom left -->
    <div class="v-info">
      <div class="v-drama-title" id="v-title">Loading...</div>
      <div class="v-ep-label" id="v-ep-label">Episode 1</div>
      <div class="v-desc" id="v-desc"></div>
    </div>

    <!-- Right actions -->
    <div class="v-actions">
      <button class="v-act-btn" onclick="toggleFavWatch()" id="v-fav-btn">
        <div class="v-act-icon" id="v-fav-icon">ğŸ¤</div>
        <span class="v-act-label">Favorit</span>
      </button>
      <button class="v-act-btn" onclick="toggleMute()">
        <div class="v-act-icon" id="v-mute-icon">ğŸ”Š</div>
        <span class="v-act-label" id="v-mute-label">Suara</span>
      </button>
      <button class="v-act-btn" onclick="toggleEpSheet()">
        <div class="v-act-icon">ğŸ“‹</div>
        <span class="v-act-label">Episode</span>
      </button>
      <button class="v-act-btn" onclick="toggleFullscreen()">
        <div class="v-act-icon" id="v-fs-icon">â›¶</div>
        <span class="v-act-label">Layar</span>
      </button>
    </div>

    <!-- Episode nav bottom -->
    <div class="ep-nav">
      <button class="ep-nav-btn" id="prev-btn" onclick="changeEp(-1)">â¬… Sebelumnya</button>
      <button class="ep-nav-ep" id="ep-num-label">Ep 1</button>
      <button class="ep-nav-btn primary" id="next-btn" onclick="changeEp(1)">Berikutnya â¡</button>
    </div>

    <!-- Episode sheet -->
    <div class="ep-sheet" id="ep-sheet">
      <div class="ep-sheet-handle"></div>
      <div class="ep-sheet-title" id="ep-sheet-title">Pilih Episode</div>
      <div class="ep-sheet-grid" id="ep-sheet-grid"></div>
    </div>
    <!-- sheet backdrop -->
    <div id="ep-sheet-backdrop" onclick="toggleEpSheet()" style="display:none;position:absolute;inset:0;z-index:38;background:transparent"></div>

  </div>
</div>

<!-- â•â• PROFILE â•â• -->
<div class="screen" id="screen-profile">
  <div class="scroll">
    <div class="prof-hd">
      <div class="prof-av">ğŸ‘¤</div>
      <div class="prof-name" id="prof-name">Pengguna</div>
      <div class="prof-tag" id="prof-tag">Member Gratis</div>
    </div>
    <div class="vip-card">
      <div class="vip-card-title">ğŸ‘‘ Upgrade ke VIP</div>
      <div class="vip-card-sub">Bebas iklan & akses semua episode HD</div>
      <button class="vip-card-btn">Mulai dari Rp 2.000/hari</button>
    </div>
    <div class="pmenu">
      <button class="pitem" onclick="toast('Favorit kamu')">
        <span class="pitem-ico">â¤ï¸</span>
        <div class="pitem-txt"><div class="pitem-label">Favorit Saya</div><div class="pitem-sub" id="fav-lbl">0 drama</div></div>
        <span>â€º</span>
      </button>
      <button class="pitem" onclick="toast('Riwayat tonton')">
        <span class="pitem-ico">ğŸ“º</span>
        <div class="pitem-txt"><div class="pitem-label">Riwayat Tonton</div><div class="pitem-sub" id="hist-lbl">0 drama</div></div>
        <span>â€º</span>
      </button>
      <button class="pitem" onclick="toast('Program Afiliasi')">
        <span class="pitem-ico">ğŸ¤</span>
        <div class="pitem-txt"><div class="pitem-label">Program Afiliasi</div><div class="pitem-sub">Dapatkan komisi</div></div>
        <span>â€º</span>
      </button>
      <button class="pitem" onclick="toast('Pengaturan')">
        <span class="pitem-ico">âš™ï¸</span>
        <div class="pitem-txt"><div class="pitem-label">Pengaturan</div><div class="pitem-sub">Akun & notifikasi</div></div>
        <span>â€º</span>
      </button>
      <button class="pitem" onclick="toast('Admin')">
        <span class="pitem-ico">ğŸ’¬</span>
        <div class="pitem-txt"><div class="pitem-label">Hubungi Admin</div><div class="pitem-sub">Bantuan & dukungan</div></div>
        <span>â€º</span>
      </button>
    </div>
    <div style="text-align:center;color:var(--muted);font-size:11px;padding:8px;font-weight:600">DramaCin v2.0</div>
    <div style="height:70px"></div>
  </div>
</div>

<!-- â•â• BOTTOM NAV â•â• -->
<nav class="bnav" id="bnav">
  <button class="nitem active" id="nav-home" onclick="switchNav('home')"><span class="ni">ğŸ </span>Home</button>
  <button class="nitem" id="nav-search" onclick="switchNav('search')"><span class="ni">ğŸ”</span>Pencarian</button>
  <button class="nitem" id="nav-rank" onclick="switchNav('rank')"><span class="ni">ğŸ†</span>Ranking</button>
  <button class="nitem" id="nav-profile" onclick="switchNav('profile')"><span class="ni">ğŸ‘¤</span>Profil</button>
</nav>

<div class="toast" id="toast-el"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const API   = 'https://captain.sapimu.au/dramabox/api/v1';
const TOKEN = '53d25de32c37b0fcd2b14a9f834050493cc044d5039b5aff3283da73a8ef761b';
const LANG  = 'in';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let cur        = 'home';
let history_   = [];
let bookId     = null;
let curEp      = 1;
let maxEp      = 1;
let chapters_  = [];
let favs       = JSON.parse(localStorage.getItem('favs')  || '[]');
let hist       = JSON.parse(localStorage.getItem('hist')  || '[]');
let homeOk=false, rankOk=false, trendOk=false;
let isMuted    = false;
let epSheetOpen= false;
const vidEl    = document.getElementById('mainVideo');
const seekEl   = document.getElementById('seekbar');
let seekDragging = false;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TELEGRAM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const tg = window.Telegram?.WebApp;
if(tg){ tg.ready(); tg.expand();
  const u = tg.initDataUnsafe?.user;
  if(u){
    document.getElementById('prof-name').textContent = u.first_name+(u.last_name?' '+u.last_name:'');
    document.getElementById('prof-tag').textContent  = '@'+(u.username||'member');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// API
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function apiFetch(ep){
  try{
    const r = await fetch(`${API}/${ep}`,{headers:{'Authorization':`Bearer ${TOKEN}`}});
    return r.ok ? r.json() : null;
  }catch(e){return null}
}
const g  = (o,...k) => k.reduce((a,b)=>a?.[b],o) ?? null;
const gf = (d,...f) => { for(const x of f){const v=d[x];if(v)return v} return '' };
const getList = d =>
  g(d,'data','list') ||
  g(d,'data','chapterList') ||
  (Array.isArray(g(d,'data'))?g(d,'data'):null) || [];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAV
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PALETTES = [
  'linear-gradient(135deg,#667eea,#764ba2)',
  'linear-gradient(135deg,#f093fb,#f5576c)',
  'linear-gradient(135deg,#4facfe,#00f2fe)',
  'linear-gradient(135deg,#43e97b,#38f9d7)',
  'linear-gradient(135deg,#fa709a,#fee140)',
  'linear-gradient(135deg,#a18cd1,#fbc2eb)',
];
function pal(t){ return PALETTES[Math.abs((t||'').length)%PALETTES.length] }

function coverHtml(d, cls='dcard-img'){
  const cov = gf(d,'coverUrl','cover','coverImg','image','pic');
  const ttl = gf(d,'bookName','name','title');
  const ep  = gf(d,'chapterCount','episodeCount','totalChapter');
  if(cov) return `<div class="${cls}" style="position:relative">
    <img src="${cov}" style="width:100%;height:100%;object-fit:cover;display:block" loading="lazy"
      onerror="this.parentNode.innerHTML='<div class=cph style=background:${pal(ttl)}>ğŸ¬<br><small>${ttl.slice(0,25)}</small></div>'">
    ${ep?`<span class="ep-badge">${ep} Ep</span>`:''}
  </div>`;
  return `<div class="${cls}"><div class="cph" style="background:${pal(ttl)}">ğŸ¬<br><small>${ttl.slice(0,30)}</small>${ep?`<br><small style="opacity:.7">${ep} Ep</small>`:''}</div></div>`;
}

function switchNav(name){
  if(cur===name && !['detail','watch'].includes(cur)) return;
  const old = document.getElementById('screen-'+cur);
  if(old) old.classList.remove('active');
  document.getElementById('bnav').style.display='flex';
  ['home','search','rank','profile'].forEach(n=>
    document.getElementById('nav-'+n).classList.toggle('active',n===name));
  if(!['detail','watch'].includes(cur)) history_=[cur];
  cur = name;
  document.getElementById('screen-'+name).classList.add('active');
  if(name==='home'   && !homeOk)  loadHome();
  if(name==='rank'   && !rankOk)  loadRank();
  if(name==='search' && !trendOk) loadTrend();
}

function goBack(){
  // pause video if leaving watch
  if(cur==='watch') vidEl.pause();
  const prev = history_.pop() || 'home';
  document.getElementById('screen-'+cur).classList.remove('active');
  document.getElementById('bnav').style.display='flex';
  ['home','search','rank','profile'].forEach(n=>
    document.getElementById('nav-'+n).classList.toggle('active',n===prev));
  cur = prev;
  document.getElementById('screen-'+prev).classList.add('active');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HOME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadHome(){
  homeOk=true;
  const d = await apiFetch(`foryou/1?lang=${LANG}`);
  const list = getList(d);
  if(list.length){
    const h=list[0];
    document.getElementById('hero-title').textContent = gf(h,'bookName','name','title');
    const ep=gf(h,'chapterCount','episodeCount'), sc=gf(h,'score','rating');
    document.getElementById('hero-meta').innerHTML =
      `${ep?`<span>${ep} Ep</span>`:''}${sc?`<span>â­${sc}</span>`:''}`;
    document.getElementById('hero-btn').onclick=()=>openDetail(h);

    const cover = gf(h,'coverUrl','cover','coverImg');
    if(cover){
      const hw = document.getElementById('hero-wrap');
      hw.innerHTML = `<img class="hero-img" src="${cover}">
        <div class="hero-grad"></div>
        <div class="hero-body">
          <div class="hero-row">
            <div>
              <div class="hero-badge">ğŸ”¥ Trending</div>
              <div class="hero-title">${gf(h,'bookName','name','title')}</div>
              <div>${ep?`<span style="font-size:11px;color:rgba(255,255,255,.75);font-weight:600">${ep} Ep  </span>`:''}${sc?`<span style="font-size:11px;color:rgba(255,255,255,.75);font-weight:600">â­${sc}</span>`:''}</div>
            </div>
            <button class="hero-btn" onclick='openDetail(${JSON.stringify(h)})'>â–¶ Tonton</button>
          </div>
        </div>`;
    }

    document.getElementById('popular-list').innerHTML = list.slice(0,12).map(d=>{
      const t=gf(d,'bookName','name','title'), sc=gf(d,'score','rating');
      return `<div class="dcard" onclick='openDetail(${JSON.stringify(d)})'>
        ${coverHtml(d)}
        <div class="dcard-title">${t}</div>
        ${sc?`<div class="dcard-star">â­${sc}</div>`:''}
      </div>`;
    }).join('');
  } else {
    document.getElementById('popular-list').innerHTML='<div class="empty"><div class="empty-ico">ğŸ“¡</div><div class="empty-txt">Gagal memuat</div></div>';
  }

  const nd = await apiFetch(`new/1?lang=${LANG}`);
  const nlist = getList(nd);
  document.getElementById('new-list').innerHTML = nlist.length
    ? nlist.slice(0,12).map(d=>{
        const t=gf(d,'bookName','name','title'), sc=gf(d,'score','rating');
        return `<div class="dcard" onclick='openDetail(${JSON.stringify(d)})'>
          ${coverHtml(d)}
          <div class="dcard-title">${t}</div>
          ${sc?`<div class="dcard-star">â­${sc}</div>`:''}
        </div>`;
      }).join('')
    : '<div class="empty"><div class="empty-ico">ğŸ“º</div><div class="empty-txt">Tidak ada data</div></div>';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RANK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadRank(){
  rankOk=true;
  const d=await apiFetch(`rank/1?lang=${LANG}`);
  const list=getList(d);
  const el=document.getElementById('rank-list');
  if(!list.length){el.innerHTML='<div class="empty"><div class="empty-ico">ğŸ†</div><div class="empty-txt">Gagal memuat</div></div>';return}
  el.innerHTML=list.slice(0,20).map((d,i)=>{
    const t=gf(d,'bookName','name','title'), sc=gf(d,'score','rating'), ep=gf(d,'chapterCount','episodeCount');
    const nc=i===0?'g':i===1?'s':i===2?'b':'n';
    const cov=gf(d,'coverUrl','cover','coverImg');
    return `<div class="rcard" onclick='openDetail(${JSON.stringify(d)})'>
      <div class="rnum ${nc}">${i+1}</div>
      ${cov?`<img class="rcov" src="${cov}" loading="lazy" onerror="this.style.background='${pal(t)}'">`:
        `<div class="rcov" style="background:${pal(t)};display:flex;align-items:center;justify-content:center;font-size:22px">ğŸ¬</div>`}
      <div class="rinfo"><div class="rtitle">${t}</div><div class="rmeta">${ep?ep+' Ep':'Drama China'}</div></div>
      ${sc?`<div class="rscore">â­${sc}</div>`:''}
    </div>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SEARCH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadTrend(){
  trendOk=true;
  const d=await apiFetch(`rank/1?lang=${LANG}`);
  const list=getList(d);
  const el=document.getElementById('trending-grid');
  if(!list.length){el.innerHTML='<div style="grid-column:span 2;text-align:center;color:var(--muted);padding:20px">Gagal memuat</div>';return}
  el.innerHTML=list.slice(0,6).map((d,i)=>{
    const t=gf(d,'bookName','name','title'), cov=gf(d,'coverUrl','cover','coverImg');
    return `<div class="gcrd" onclick='openDetail(${JSON.stringify(d)})'>
      <div class="gcrd-img">${cov?`<img src="${cov}" style="width:100%;height:100%;object-fit:cover" loading="lazy">`:
        `<div style="width:100%;height:100%;background:${pal(t)};display:flex;align-items:center;justify-content:center;font-size:36px">ğŸ¬</div>`}
        <div class="grank">#${i+1}</div>
      </div>
      <div class="gcrd-title">${t}</div>
    </div>`;
  }).join('');
}

function doSearch(){ const kw=document.getElementById('sinput').value.trim(); if(kw) searchKw(kw); }
async function searchKw(kw){
  document.getElementById('sinput').value=kw;
  document.getElementById('stags-sec').style.display='none';
  document.getElementById('sresults-sec').style.display='block';
  document.getElementById('sresult-title').textContent=`ğŸ” "${kw}"`;
  document.getElementById('sresults').innerHTML='<div class="loader"><div class="spinner"></div></div>';
  const d=await apiFetch(`search/${encodeURIComponent(kw)}/1?lang=${LANG}&pageSize=20`);
  const list=getList(d);
  if(!list.length){document.getElementById('sresults').innerHTML='<div class="empty"><div class="empty-ico">ğŸ”</div><div class="empty-txt">Tidak ditemukan</div></div>';return}
  document.getElementById('sresults').innerHTML=list.slice(0,20).map(d=>{
    const t=gf(d,'bookName','name','title'), sc=gf(d,'score','rating'), ep=gf(d,'chapterCount','episodeCount');
    const cov=gf(d,'coverUrl','cover','coverImg');
    return `<div class="rcard" onclick='openDetail(${JSON.stringify(d)})'>
      ${cov?`<img class="rcov" src="${cov}" loading="lazy">`:
        `<div class="rcov" style="background:${pal(t)};display:flex;align-items:center;justify-content:center;font-size:22px">ğŸ¬</div>`}
      <div class="rinfo"><div class="rtitle">${t}</div><div class="rmeta">${ep?ep+' Ep':'Drama China'}</div></div>
      ${sc?`<div class="rscore">â­${sc}</div>`:''}
    </div>`;
  }).join('');
}
function clearSearch(){
  document.getElementById('stags-sec').style.display='block';
  document.getElementById('sresults-sec').style.display='none';
  document.getElementById('sinput').value='';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DETAIL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let detailDrama = null;
function openDetail(drama){
  history_.push(cur);
  detailDrama = drama;
  const id=gf(drama,'bookId','id');
  const ttl=gf(drama,'bookName','name','title');
  const desc=gf(drama,'introduce','description','intro','synopsis')||'Tidak ada deskripsi.';
  const cov=gf(drama,'coverUrl','cover','coverImg');
  const sc=gf(drama,'score','rating'), ep=gf(drama,'chapterCount','episodeCount');
  bookId=id;

  document.getElementById('det-title').textContent=ttl;
  document.getElementById('det-desc').textContent=desc;
  document.getElementById('det-desc').className='det-desc col';
  document.getElementById('det-meta').innerHTML=
    [sc?`<span class="det-badge">â­ ${sc}</span>`:'',
     ep?`<span class="det-badge">ğŸ“º ${ep} Episode</span>`:'',
     `<span class="det-badge">ğŸ‡¨ğŸ‡³ Drama China</span>`].filter(Boolean).join('');
  if(cov){document.getElementById('det-cover').src=cov;document.getElementById('det-thumb').src=cov;}
  document.getElementById('det-fav-btn').textContent=favs.includes(id)?'â¤ï¸':'ğŸ¤';
  document.getElementById('det-watch-btn').onclick=()=>watchEp(id,1,ttl,drama);
  loadChapters(id,ttl);

  document.getElementById('screen-'+cur).classList.remove('active');
  document.getElementById('bnav').style.display='flex';
  ['home','search','rank','profile'].forEach(n=>document.getElementById('nav-'+n).classList.remove('active'));
  cur='detail';
  document.getElementById('screen-detail').classList.add('active');
}
async function loadChapters(id,ttl){
  const el=document.getElementById('det-ep-grid');
  el.innerHTML='<div class="loader" style="grid-column:span 5"><div class="spinner"></div></div>';
  const d=await apiFetch(`chapters/${id}?lang=${LANG}`);
  chapters_ = g(d,'data','chapterList') || g(d,'data','list') || getList(d) || [];
  maxEp=chapters_.length;
  if(!chapters_.length){el.innerHTML='<div style="grid-column:span 5;text-align:center;color:var(--muted);padding:20px">Episode tidak tersedia</div>';return}
  el.innerHTML=chapters_.slice(0,60).map((ch,i)=>{
    const n=gf(ch,'chapterNo','episodeNo')||(i+1);
    return `<button class="ep-btn" onclick="watchEp('${id}',${n},'${ttl}',null)">${n}</button>`;
  }).join('');
}

function toggleDesc(){
  const el=document.getElementById('det-desc'),btn=document.getElementById('readmore-btn');
  if(el.classList.contains('col')){el.classList.remove('col');btn.textContent='Sembunyikan â€¹';}
  else{el.classList.add('col');btn.textContent='Selengkapnya â€º';}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ¬ TIKTOK VIDEO PLAYER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentDrama = null;
async function watchEp(id, ep, title, dramaObj){
  history_.push(cur);
  bookId=id; curEp=Number(ep);
  currentDrama = dramaObj || detailDrama;

  // Switch to watch screen
  document.getElementById('screen-'+cur).classList.remove('active');
  document.getElementById('bnav').style.display='none'; // hide nav for immersive
  ['home','search','rank','profile'].forEach(n=>document.getElementById('nav-'+n).classList.remove('active'));
  cur='watch';
  document.getElementById('screen-watch').classList.add('active');

  // Reset UI
  document.getElementById('v-title').textContent = title || 'Loading...';
  document.getElementById('v-ep-label').textContent = `Episode ${ep}`;
  document.getElementById('ep-num-label').textContent = `Ep ${ep}`;
  document.getElementById('v-desc').textContent = '';
  document.getElementById('vbuf').style.display='flex';
  document.getElementById('seekbar').value=0;
  document.getElementById('time-cur').textContent='0:00';
  document.getElementById('time-dur').textContent='0:00';

  // Nav buttons state
  document.getElementById('prev-btn').style.opacity = ep<=1?'0.4':'1';
  document.getElementById('prev-btn').disabled = ep<=1;

  // Fav state
  document.getElementById('v-fav-icon').textContent = favs.includes(id)?'â¤ï¸':'ğŸ¤';

  // Fill episode sheet
  if(chapters_.length){
    document.getElementById('ep-sheet-title').textContent = title||'Episode';
    document.getElementById('ep-sheet-grid').innerHTML = chapters_.slice(0,80).map((ch,i)=>{
      const n=gf(ch,'chapterNo','episodeNo')||(i+1);
      return `<button class="ep-sht-btn ${n==ep?'active':''}" onclick="watchEp('${id}',${n},'${title}',null);toggleEpSheet()">${n}</button>`;
    }).join('');
  }

  // Set desc
  const desc = currentDrama ? gf(currentDrama,'introduce','description','intro','synopsis') : '';
  document.getElementById('v-desc').textContent = desc ? desc.slice(0,100)+'â€¦' : '';

  // Fetch video
  const data = await apiFetch(`watch/${id}/${ep}?lang=${LANG}&direction=1`);
  const videoUrl =
    g(data,'data','videoUrl') || g(data,'data','url') || g(data,'data','playUrl') ||
    g(data,'data','streamUrl') || g(data,'data','m3u8Url') || g(data,'data','mp4Url') || null;

  const dramaTitle = g(data,'data','bookName') || g(data,'data','name') || title;
  document.getElementById('v-title').textContent = dramaTitle || title;

  if(videoUrl){
    vidEl.src = videoUrl;
    vidEl.load();
    // try autoplay
    vidEl.play().catch(()=>{
      // autoplay blocked - show big play button hint
      showFlash('â–¶ï¸');
      document.getElementById('vbuf').style.display='none';
    });
  } else {
    document.getElementById('vbuf').style.display='none';
    toast('âš ï¸ Video episode ini belum tersedia');
    showFlash('âš ï¸');
  }

  // Save history
  if(!hist.includes(id)){hist.unshift(id);if(hist.length>50)hist.pop();localStorage.setItem('hist',JSON.stringify(hist));updateCounts();}
}

// Play / Pause on tap
function tapPlayPause(){
  if(epSheetOpen){toggleEpSheet();return}
  if(vidEl.paused||vidEl.ended){ vidEl.play(); showFlash('â–¶ï¸'); }
  else{ vidEl.pause(); showFlash('â¸ï¸'); }
}

function showFlash(icon){
  const el=document.getElementById('vflash'), ico=document.getElementById('vflash-icon');
  ico.textContent=icon; el.classList.remove('show');
  void el.offsetWidth; el.classList.add('show');
}

function showBuf(){ document.getElementById('vbuf').style.display='flex'; }
function hideBuf(){ document.getElementById('vbuf').style.display='none'; }

function onVideoEnded(){
  // Auto next episode
  if(chapters_.length && curEp<maxEp){ changeEp(1); }
  else{ showFlash('ğŸ”š'); }
}
function onVideoError(){
  hideBuf();
  toast('âš ï¸ Gagal memutar video');
  showFlash('âŒ');
}

// Seek bar
function onTimeUpdate(){
  if(seekDragging) return;
  const cur_=vidEl.currentTime, dur=vidEl.duration||0;
  if(dur>0) seekEl.value=(cur_/dur)*100;
  document.getElementById('time-cur').textContent=fmt(cur_);
  document.getElementById('time-dur').textContent=fmt(dur);
}
function onSeekInput(){ seekDragging=true; const dur=vidEl.duration||0; if(dur>0){const t=(seekEl.value/100)*dur;document.getElementById('time-cur').textContent=fmt(t);} }
function onSeekChange(){ seekDragging=false; const dur=vidEl.duration||0; if(dur>0) vidEl.currentTime=(seekEl.value/100)*dur; }
function fmt(s){ const m=Math.floor((s||0)/60),sec=Math.floor((s||0)%60); return `${m}:${sec<10?'0':''}${sec}`; }

function changeEp(dir){
  const ne=curEp+dir;
  if(ne<1||(!chapters_.length&&ne>999)) return;
  if(chapters_.length&&ne>chapters_.length) return;
  const title=document.getElementById('v-title').textContent;
  watchEp(bookId,ne,title,currentDrama);
}

function toggleMute(){
  isMuted=!isMuted; vidEl.muted=isMuted;
  document.getElementById('v-mute-icon').textContent=isMuted?'ğŸ”‡':'ğŸ”Š';
  document.getElementById('v-mute-label').textContent=isMuted?'Mute':'Suara';
  toast(isMuted?'ğŸ”‡ Suara dimatikan':'ğŸ”Š Suara dinyalakan');
}

function toggleEpSheet(){
  epSheetOpen=!epSheetOpen;
  document.getElementById('ep-sheet').classList.toggle('open',epSheetOpen);
  document.getElementById('ep-sheet-backdrop').style.display=epSheetOpen?'block':'none';
}

function toggleFullscreen(){
  const el=document.getElementById('screen-watch');
  if(!document.fullscreenElement){ el.requestFullscreen?.(); document.getElementById('v-fs-icon').textContent='âŠ¡'; }
  else{ document.exitFullscreen?.(); document.getElementById('v-fs-icon').textContent='â›¶'; }
}

function toggleFavWatch(){
  const id=bookId;
  if(favs.includes(id)){ favs=favs.filter(f=>f!==id); document.getElementById('v-fav-icon').textContent='ğŸ¤'; toast('Dihapus dari favorit'); }
  else{ favs.unshift(id); document.getElementById('v-fav-icon').textContent='â¤ï¸'; toast('Ditambahkan ke favorit â¤ï¸'); }
  localStorage.setItem('favs',JSON.stringify(favs)); updateCounts();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FAVORITES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleFav(){
  const id=bookId, btn=document.getElementById('det-fav-btn');
  if(favs.includes(id)){ favs=favs.filter(f=>f!==id); btn.textContent='ğŸ¤'; toast('Dihapus dari favorit'); }
  else{ favs.unshift(id); btn.textContent='â¤ï¸'; toast('Ditambahkan ke favorit â¤ï¸'); }
  localStorage.setItem('favs',JSON.stringify(favs)); updateCounts();
}
function updateCounts(){
  document.getElementById('fav-lbl').textContent  = favs.length+' drama';
  document.getElementById('hist-lbl').textContent = hist.length+' drama';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let toastT;
function toast(m){ const el=document.getElementById('toast-el'); el.textContent=m; el.classList.add('show'); clearTimeout(toastT); toastT=setTimeout(()=>el.classList.remove('show'),2400); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
updateCounts();
loadHome();
</script>
</body>
</html>
