<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover">
<title>DramaFeed - Nonton Drama Sub Indo</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<!-- FIREBASE SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#000;--bg2:#0c0c0c;--bg3:#111;--bg4:#161616;--bg5:#1c1c1c;
  --accent:#fff;--red:#e63946;--gold:#c9a84c;
  --text:#ededed;--text2:#888;--text3:#444;
  --border:rgba(255,255,255,.08);--border2:rgba(255,255,255,.04);
  --radius:6px;--radius2:10px;--shadow:0 4px 24px rgba(0,0,0,.6);--tr:all .18s ease;
  --db:#e63946;--fr:#7c3aed;--ml:#10b981;--gs:#d97706;
  --dw:#0891b2;--sm:#e11d48;--ns:#7c3aed;--db2:#ea580c;--fx:#0284c7;
}
html{scroll-behavior:smooth}
body{font-family:-apple-system,BlinkMacSystemFont,'Inter','Segoe UI',system-ui,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden;-webkit-font-smoothing:antialiased}
body.noscroll{overflow:hidden}
button{border:none;outline:none;cursor:pointer;font-family:inherit}
input{font-family:inherit;outline:none;border:none}
a{text-decoration:none;color:inherit}
::selection{background:rgba(255,255,255,.15);color:#fff}
::-webkit-scrollbar{width:3px;height:3px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--bg5);border-radius:2px}
.hdr{position:sticky;top:0;z-index:100;background:rgba(0,0,0,.9);backdrop-filter:blur(20px);border-bottom:1px solid var(--border2)}
.hdr-in{max-width:1440px;margin:0 auto;padding:0 20px;height:56px;display:flex;align-items:center;gap:8px}
.logo{display:flex;align-items:center;gap:7px;font-size:1rem;font-weight:700;cursor:pointer;flex-shrink:0;color:#fff}
.logo i{color:var(--red);font-size:.95rem}
.plat-btn{display:flex;align-items:center;gap:6px;padding:5px 10px 5px 8px;background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius);font-size:.75rem;font-weight:500;color:var(--text2);cursor:pointer;transition:var(--tr);flex-shrink:0;white-space:nowrap}
.plat-btn:hover{border-color:rgba(255,255,255,.16);color:var(--text)}
.plat-btn .pdot{width:6px;height:6px;border-radius:50%;background:var(--red);display:inline-block}
#fbSyncBadge{width:6px;height:6px;border-radius:50%;background:#10b981;display:inline-block;margin-left:2px;flex-shrink:0}
.plat-modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:500;display:none;align-items:center;justify-content:center;backdrop-filter:blur(6px);padding:20px}
.plat-modal-bg.open{display:flex}
.plat-modal{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius2);width:100%;max-width:280px;overflow:hidden}
.plat-modal-hdr{padding:14px 16px;border-bottom:1px solid var(--border2);display:flex;align-items:center;justify-content:space-between}
.plat-modal-hdr h2{font-size:.7rem;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:.08em}
.plat-close{width:24px;height:24px;border-radius:var(--radius);background:var(--bg3);color:var(--text2);display:flex;align-items:center;justify-content:center;font-size:.65rem}
.plat-grid{display:flex;flex-direction:column}
.plat-card{display:flex;align-items:center;gap:10px;padding:9px 14px;cursor:pointer;transition:background .1s;background:none}
.plat-card:hover{background:var(--bg3)}
.plat-card-ico{width:32px;height:32px;border-radius:7px;flex-shrink:0;overflow:hidden}
.plat-card-name{font-size:.82rem;font-weight:500;color:var(--text)}
.plat-check{width:14px;height:14px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.5rem;flex-shrink:0;margin-left:auto;opacity:0}
.plat-card.selected .plat-check{opacity:1;background:var(--text);color:#000}
.plat-badge-new{font-size:.5rem;font-weight:700;padding:1px 5px;border-radius:3px;background:var(--bg5);color:var(--text3);border:1px solid var(--border)}
.nav{display:flex;gap:0;flex-shrink:0;overflow-x:auto}
.nav::-webkit-scrollbar{display:none}
.nb{padding:6px 11px;border-radius:var(--radius);font-size:.76rem;font-weight:500;color:var(--text3);cursor:pointer;transition:var(--tr);white-space:nowrap;background:none}
.nb.on{color:var(--text);background:var(--bg3);font-weight:600}
.swrap{flex:1;max-width:320px;margin-left:auto;position:relative}
.sbox{position:relative;display:flex;align-items:center}
.sbox i.si{position:absolute;left:10px;color:var(--text3);font-size:.72rem}
.sbox input{width:100%;padding:7px 60px 7px 30px;background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);font-size:.78rem;transition:var(--tr)}
.sbox input:focus{border-color:rgba(255,255,255,.2)}
.sbox input::placeholder{color:var(--text3)}
.sgo{position:absolute;right:4px;padding:4px 10px;background:var(--text);color:#000;border-radius:4px;font-size:.7rem;font-weight:600}
.sugbox{position:absolute;top:calc(100% + 4px);left:0;right:0;background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius2);display:none;z-index:200;max-height:320px;overflow-y:auto}
.sugbox.show{display:block}
.sugi{padding:9px 13px;cursor:pointer;transition:background .1s;display:flex;align-items:center;gap:8px;font-size:.78rem;color:var(--text2)}
.sugi:hover{background:var(--bg3);color:var(--text)}
.mbar{display:none;position:fixed;bottom:0;left:0;right:0;background:rgba(0,0,0,.97);backdrop-filter:blur(24px);border-top:1px solid var(--border2);z-index:100;padding:2px 0 env(safe-area-inset-bottom)}
.mbar-in{display:flex;justify-content:space-around}
.mb{display:flex;flex-direction:column;align-items:center;gap:2px;padding:7px 6px;color:var(--text3);font-size:.52rem;font-weight:500;cursor:pointer;background:none;white-space:nowrap}
.mb i{font-size:.9rem}
.mb.on{color:var(--text)}
.mb.premium-tab{color:var(--gold)}
.main{max-width:1440px;margin:0 auto;padding:24px 20px;min-height:calc(100vh - 120px)}
.stitle{font-size:.78rem;font-weight:600;margin-bottom:14px;display:flex;align-items:center;gap:7px;color:var(--text3);text-transform:uppercase;letter-spacing:.06em}
.src-badge{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:3px;font-size:.62rem;font-weight:600;margin-bottom:12px;text-transform:uppercase;letter-spacing:.05em;border:1px solid var(--border)}
.src-badge.db{color:var(--db);border-color:rgba(230,57,70,.2)}
.src-badge.fr{color:var(--fr);border-color:rgba(124,58,237,.2)}
.src-badge.ml{color:var(--ml);border-color:rgba(16,185,129,.2)}
.src-badge.gs{color:var(--gs);border-color:rgba(217,119,6,.2)}
.src-badge.dw{color:var(--dw);border-color:rgba(8,145,178,.2)}
.src-badge.sm{color:var(--sm);border-color:rgba(225,29,72,.2)}
.src-badge.ns{color:var(--ns);border-color:rgba(124,58,237,.2)}
.src-badge.db2{color:var(--db2);border-color:rgba(234,88,12,.2)}
.src-badge.fx{color:var(--fx);border-color:rgba(2,132,199,.2)}
.fbtn{padding:5px 12px;background:none;border:1px solid var(--border);border-radius:var(--radius);font-size:.72rem;color:var(--text2);cursor:pointer;transition:var(--tr)}
.fbtn.on{background:var(--text);border-color:var(--text);color:#000;font-weight:600}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:1px;background:var(--border2)}
.card{position:relative;cursor:pointer;background:var(--bg)}
.card:hover{background:var(--bg2)}
.cimg{position:relative;aspect-ratio:2/3;overflow:hidden;background:var(--bg3)}
.cimg img{width:100%;height:100%;object-fit:cover;transition:transform .4s ease;display:block}
.card:hover .cimg img{transform:scale(1.04)}
.chov{position:absolute;inset:0;background:linear-gradient(0deg,rgba(0,0,0,.95) 0%,rgba(0,0,0,.4) 50%,transparent 100%);opacity:0;transition:opacity .2s ease;display:flex;align-items:center;justify-content:center}
.card:hover .chov{opacity:1}
.cplay{width:40px;height:40px;border-radius:50%;background:var(--text);display:flex;align-items:center;justify-content:center;color:#000;font-size:.85rem;transform:scale(.7) translateY(6px);transition:transform .2s ease,opacity .2s ease;opacity:0}
.card:hover .cplay{transform:scale(1) translateY(0);opacity:1}
.cbadge{position:absolute;top:6px;left:6px;background:rgba(0,0,0,.75);color:var(--text2);padding:2px 6px;border-radius:3px;font-size:.58rem;font-weight:600;backdrop-filter:blur(4px);border:1px solid var(--border)}
.cscore{position:absolute;top:6px;right:6px;background:rgba(0,0,0,.75);color:var(--gold);padding:2px 6px;border-radius:3px;font-size:.58rem;font-weight:600;display:flex;align-items:center;gap:2px}
.cplatbadge{position:absolute;bottom:6px;left:6px;width:24px;height:24px;border-radius:6px;overflow:hidden;border:1.5px solid rgba(255,255,255,.18);z-index:3}
.cplatbadge img{width:100%;height:100%;object-fit:cover;display:block}
.cbody{padding:10px 10px 12px}
.cname{font-size:.78rem;font-weight:500;line-height:1.35;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;color:var(--text)}
.csub{font-size:.65rem;color:var(--text3);display:flex;align-items:center;gap:4px;margin-top:3px}
.noimg{width:100%;height:100%;background:var(--bg3);display:flex;align-items:center;justify-content:center;color:var(--text3);font-size:1.5rem}
.card-fav-btn{position:absolute;bottom:44px;right:6px;width:28px;height:28px;border-radius:4px;background:rgba(0,0,0,.8);color:var(--text3);display:flex;align-items:center;justify-content:center;font-size:.68rem;z-index:5;border:1px solid var(--border);opacity:0;transition:var(--tr)}
.card:hover .card-fav-btn{opacity:1}
.card-fav-btn.saved{opacity:1;color:var(--gold);border-color:rgba(201,168,76,.3)}
.cw-section{margin-bottom:28px}
.cw-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.cw-title{font-size:.72rem;font-weight:600;display:flex;align-items:center;gap:6px;color:var(--text3);text-transform:uppercase;letter-spacing:.06em}
.cw-clear{font-size:.68rem;color:var(--text3);padding:3px 8px;background:none;border:1px solid var(--border);border-radius:var(--radius);cursor:pointer}
.cw-scroll{display:flex;gap:8px;overflow-x:auto;padding-bottom:6px;scrollbar-width:none}
.cw-scroll::-webkit-scrollbar{display:none}
.cw-card{flex-shrink:0;width:120px;background:var(--bg2);border-radius:var(--radius);overflow:hidden;cursor:pointer;border:1px solid var(--border2);transition:var(--tr);position:relative}
.cw-card:hover{border-color:var(--border)}
.cw-thumb{position:relative;aspect-ratio:2/3;overflow:hidden;background:var(--bg3)}
.cw-thumb img{width:100%;height:100%;object-fit:cover;display:block}
.cw-play-icon{position:absolute;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity .15s}
.cw-card:hover .cw-play-icon{opacity:1}
.cw-play-icon i{font-size:1.1rem;color:#fff}
.cw-prog-bar{position:absolute;bottom:0;left:0;right:0;height:2px;background:rgba(255,255,255,.1)}
.cw-prog-fill{height:100%;background:var(--red)}
.cw-info{padding:6px 7px 8px}
.cw-name{font-size:.68rem;font-weight:500;line-height:1.3;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;overflow:hidden}
.cw-ep{font-size:.6rem;color:var(--text3);margin-top:1px}
.cw-del{position:absolute;top:4px;right:4px;width:20px;height:20px;border-radius:3px;background:rgba(0,0,0,.75);color:var(--text3);display:flex;align-items:center;justify-content:center;font-size:.55rem;opacity:0;transition:var(--tr);z-index:5}
.cw-card:hover .cw-del{opacity:1}
.cw-resume-banner{background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius2);padding:12px 14px;display:flex;align-items:center;gap:12px;margin-bottom:14px;cursor:pointer;transition:var(--tr)}
.cw-resume-banner:hover{background:var(--bg4)}
.cw-resume-icon{width:34px;height:34px;border-radius:var(--radius);background:var(--bg5);display:flex;align-items:center;justify-content:center;color:var(--text2);font-size:.85rem;flex-shrink:0}
.cw-resume-text{flex:1}
.cw-resume-text strong{font-size:.82rem;display:block;margin-bottom:1px;font-weight:500}
.cw-resume-text span{font-size:.7rem;color:var(--text3)}
.cw-resume-prog{height:2px;background:var(--bg5);border-radius:1px;margin-top:5px;overflow:hidden}
.cw-resume-prog-fill{height:100%;background:var(--red);border-radius:1px}
.wl-empty{text-align:center;padding:60px 20px;color:var(--text3)}
.load-more{display:flex;justify-content:center;margin-top:24px}
.lmbtn{padding:9px 24px;background:none;border:1px solid var(--border);border-radius:var(--radius);color:var(--text2);font-size:.78rem;font-weight:500;display:flex;align-items:center;gap:7px;transition:var(--tr)}
.lmbtn.loading{pointer-events:none;opacity:.4}
.lmbtn .spinner{width:13px;height:13px;border:1.5px solid var(--bg5);border-top-color:var(--text2);border-radius:50%;animation:spin .6s linear infinite;display:none}
.lmbtn.loading .spinner{display:block}
.lmbtn.loading .lmtext{display:none}
.end-msg{text-align:center;padding:16px;color:var(--text3);font-size:.75rem}
.dhero{position:relative;border-radius:var(--radius2);overflow:hidden;margin-bottom:20px;background:var(--bg2);border:1px solid var(--border2)}
.dbg{position:absolute;inset:0;background-size:cover;background-position:center;filter:blur(40px) brightness(.12) saturate(.5);transform:scale(1.3)}
.din{position:relative;display:flex;gap:20px;padding:24px;z-index:1}
.dposter{width:160px;flex-shrink:0;border-radius:var(--radius);overflow:hidden;background:var(--bg3);border:1px solid var(--border)}
.dposter img{width:100%;aspect-ratio:2/3;object-fit:cover;display:block}
.dinfo{flex:1;display:flex;flex-direction:column;justify-content:center}
.dttl{font-size:1.35rem;font-weight:700;margin-bottom:8px;line-height:1.25}
.dtags{display:flex;flex-wrap:wrap;gap:4px;margin-bottom:10px}
.dtag{padding:2px 7px;background:var(--bg4);border-radius:3px;font-size:.65rem;color:var(--text3);border:1px solid var(--border2)}
.dsts{display:flex;gap:14px;margin-bottom:10px;flex-wrap:wrap}
.ds{display:flex;align-items:center;gap:4px;font-size:.75rem;color:var(--text2)}
.ds i{color:var(--text3);font-size:.65rem}
.ddesc{font-size:.8rem;color:var(--text2);line-height:1.65;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden;margin-bottom:8px}
.ddesc.open{-webkit-line-clamp:unset}
.bmore{background:none;color:var(--text3);font-size:.72rem;cursor:pointer;padding:0;margin-bottom:12px}
.bwatch{padding:9px 20px;background:var(--text);color:#000;border-radius:var(--radius);font-size:.8rem;font-weight:600;display:inline-flex;align-items:center;gap:6px;transition:var(--tr)}
.bwatch:hover{background:rgba(255,255,255,.85)}
.bfav{padding:9px 16px;background:none;color:var(--text2);border-radius:var(--radius);font-size:.8rem;font-weight:500;display:inline-flex;align-items:center;gap:6px;transition:var(--tr);border:1px solid var(--border)}
.bfav.saved{color:var(--gold);border-color:rgba(201,168,76,.3)}
.epgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(64px,1fr));gap:4px;margin-top:6px}
.epc{padding:8px 4px;background:var(--bg3);border:1px solid var(--border2);border-radius:var(--radius);text-align:center;cursor:pointer;font-size:.75rem;font-weight:500;color:var(--text2);transition:var(--tr)}
.epc:hover{background:var(--bg4);color:var(--text)}
.epc.cw-ep-active{background:var(--text);color:#000;border-color:var(--text);font-weight:600}
.ld{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:80px 20px;gap:10px}
.sp{width:28px;height:28px;border:2px solid var(--bg4);border-top-color:var(--text3);border-radius:50%;animation:spin .7s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.lt{color:var(--text3);font-size:.78rem}
.ebox{text-align:center;padding:50px 20px}
.ebox i{font-size:1.8rem;color:var(--text3);margin-bottom:10px;display:block}
.bret{padding:7px 18px;background:var(--text);color:#000;border-radius:var(--radius);font-size:.76rem;font-weight:600;display:inline-flex;gap:5px;align-items:center}
.empty{text-align:center;padding:40px 20px;color:var(--text3);font-size:.8rem}
.back{display:inline-flex;align-items:center;gap:5px;padding:6px 12px;background:none;color:var(--text2);border-radius:var(--radius);font-size:.75rem;font-weight:500;cursor:pointer;margin-bottom:14px;border:1px solid var(--border);transition:var(--tr)}
.toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:var(--bg4);color:var(--text);padding:9px 18px;border-radius:var(--radius);font-size:.78rem;z-index:1000;opacity:0;transition:opacity .25s;pointer-events:none;white-space:nowrap;border:1px solid var(--border)}
.toast.show{opacity:1}
.tkp{position:fixed;inset:0;z-index:600;background:#000;display:none;flex-direction:column}
.tkp.open{display:flex}
.tk-vc{flex:1;position:relative;overflow:hidden;display:flex;align-items:center;justify-content:center}
.tk-vc video{width:100%;height:100%;object-fit:contain;background:#000}
.tk-grad-top{position:absolute;top:0;left:0;right:0;height:100px;background:linear-gradient(180deg,rgba(0,0,0,.6) 0%,transparent 100%);pointer-events:none;z-index:2}
.tk-grad-bot{position:absolute;bottom:0;left:0;right:0;height:180px;background:linear-gradient(0deg,rgba(0,0,0,.7) 0%,transparent 100%);pointer-events:none;z-index:2}
.tk-close{position:absolute;top:max(14px,env(safe-area-inset-top));left:14px;z-index:10;width:36px;height:36px;border-radius:var(--radius);background:rgba(0,0,0,.6);color:rgba(255,255,255,.8);display:flex;align-items:center;justify-content:center;font-size:1rem;backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,.08)}
.tk-epc{position:absolute;top:max(18px,env(safe-area-inset-top));left:50%;transform:translateX(-50%);z-index:10;background:rgba(0,0,0,.6);color:rgba(255,255,255,.8);padding:5px 12px;border-radius:var(--radius);font-size:.72rem;font-weight:600;backdrop-filter:blur(8px)}
.tk-side{position:absolute;right:10px;bottom:140px;z-index:10;display:flex;flex-direction:column;gap:16px;align-items:center}
.tk-sb{display:flex;flex-direction:column;align-items:center;gap:3px;background:none;color:rgba(255,255,255,.7);font-size:.5rem;font-weight:500}
.tk-sb i{width:40px;height:40px;border-radius:var(--radius);background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;font-size:1rem;backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,.08)}
.tk-sb.wl-active i{border-color:rgba(201,168,76,.4);color:var(--gold)}
.tk-bottom{position:absolute;bottom:max(20px,env(safe-area-inset-bottom));left:14px;right:68px;z-index:10}
.tk-dname{font-size:.95rem;font-weight:600;color:#fff;margin-bottom:3px;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;overflow:hidden}
.tk-epsub{font-size:.78rem;color:rgba(255,255,255,.55);margin-bottom:6px}
.tk-hint{font-size:.62rem;color:rgba(255,255,255,.25);display:flex;align-items:center;gap:4px}
.tk-hint i{animation:tkBounce 2s infinite ease-in-out}
@keyframes tkBounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-4px)}}
.tk-prog{position:absolute;bottom:0;left:0;right:0;height:2px;background:rgba(255,255,255,.08);z-index:11}
.tk-prog-bar{height:100%;background:var(--red);width:0%;transition:width .15s linear}
.tk-load{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;z-index:8;background:rgba(0,0,0,.4)}
.tk-load .sp{width:36px;height:36px;border-color:rgba(255,255,255,.1);border-top-color:rgba(255,255,255,.6)}
.tk-pp{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;z-index:6;pointer-events:none}
.tk-pp i{width:60px;height:60px;border-radius:50%;background:rgba(0,0,0,.4);display:flex;align-items:center;justify-content:center;font-size:1.3rem;color:#fff;opacity:0;transform:scale(1.6);transition:all .18s ease-out}
.tk-pp.show i{opacity:1;transform:scale(1)}
.tk-seek{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;z-index:6;pointer-events:none}
.tk-seek-ind{display:flex;align-items:center;gap:6px;background:rgba(0,0,0,.6);padding:10px 16px;border-radius:var(--radius2);opacity:0;transform:scale(.85);transition:all .15s ease-out}
.tk-seek-ind.show{opacity:1;transform:scale(1)}
.tk-seek-ind span{font-size:.9rem;font-weight:600;color:#fff}
.tk-err{position:absolute;inset:0;flex-direction:column;align-items:center;justify-content:center;gap:10px;z-index:7;color:rgba(255,255,255,.5);font-size:.82rem;display:none}
.tk-err.show{display:flex}
.tk-err i{font-size:2rem;color:var(--text3)}
.tk-err button{padding:7px 18px;border-radius:var(--radius);background:var(--text);color:#000;font-size:.76rem;font-weight:600}
.tk-epanel{position:absolute;bottom:0;left:0;right:0;max-height:55vh;background:rgba(6,6,6,.97);backdrop-filter:blur(24px);border-radius:var(--radius2) var(--radius2) 0 0;transform:translateY(100%);transition:transform .3s cubic-bezier(.4,0,.2,1);z-index:20;display:flex;flex-direction:column;border-top:1px solid var(--border)}
.tk-epanel.open{transform:translateY(0)}
.tk-eph{padding:12px 14px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border2);font-weight:600;font-size:.82rem;color:var(--text)}
.tk-eph button{background:none;color:var(--text3);font-size:1.1rem;width:30px;height:30px;border-radius:var(--radius);display:flex;align-items:center;justify-content:center}
.tk-epl{overflow-y:auto;padding:8px;display:grid;grid-template-columns:repeat(auto-fill,minmax(56px,1fr));gap:4px}
.tk-epb{padding:9px 4px;border-radius:var(--radius);background:var(--bg3);color:var(--text3);text-align:center;font-size:.72rem;font-weight:500;border:1px solid var(--border2);transition:var(--tr)}
.tk-epb.on{background:var(--text);color:#000;border-color:var(--text);font-weight:600}
.tk-overlay{position:absolute;inset:0;background:rgba(0,0,0,.5);z-index:15;display:none}
.tk-overlay.show{display:block}
.tk-anim-up{animation:tkUp .25s ease}
.tk-anim-down{animation:tkDn .25s ease}
@keyframes tkUp{from{opacity:.3;transform:translateY(20%)}to{opacity:1;transform:translateY(0)}}
@keyframes tkDn{from{opacity:.3;transform:translateY(-20%)}to{opacity:1;transform:translateY(0)}}
.foot{border-top:1px solid var(--border2);margin-top:48px;background:var(--bg)}
.foot-top{max-width:1440px;margin:0 auto;padding:40px 24px 32px;display:grid;grid-template-columns:1.6fr 1fr 1fr 1.3fr;gap:40px}
.foot-brand{display:flex;flex-direction:column;gap:10px}
.foot-logo{display:flex;align-items:center;gap:6px;font-size:.95rem;font-weight:700;color:var(--text)}
.foot-logo i{color:var(--red)}
.foot-tagline{font-size:.76rem;color:var(--text3);line-height:1.7;max-width:240px}
.foot-socials{display:flex;gap:6px;margin-top:2px}
.foot-social{width:30px;height:30px;border-radius:var(--radius);background:var(--bg3);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;color:var(--text3);font-size:.76rem;transition:var(--tr)}
.foot-col h4{font-size:.65rem;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:.08em;margin-bottom:12px}
.foot-links{display:flex;flex-direction:column;gap:8px}
.foot-link{font-size:.76rem;color:var(--text3);cursor:pointer;display:flex;align-items:center;gap:5px}
.foot-link:hover{color:var(--text)}
.foot-platforms{display:flex;flex-wrap:wrap;gap:4px}
.foot-plat-tag{padding:3px 8px;background:var(--bg3);border:1px solid var(--border2);border-radius:3px;font-size:.62rem;color:var(--text3)}
.foot-support{display:flex;flex-direction:column;gap:6px}
.foot-support-sub{font-size:.74rem;color:var(--text3);line-height:1.6;margin-bottom:4px}
.foot-saw-btn{display:flex;align-items:center;justify-content:center;gap:6px;padding:9px;background:var(--text);color:#000;border-radius:var(--radius);font-size:.76rem;font-weight:600;cursor:pointer;border:none;transition:var(--tr);width:100%}
.foot-tg-btn{display:flex;align-items:center;justify-content:center;gap:6px;padding:8px;background:none;border:1px solid var(--border);color:var(--text3);border-radius:var(--radius);font-size:.76rem;font-weight:500;cursor:pointer;transition:var(--tr);width:100%}
.foot-bottom{border-top:1px solid var(--border2);padding:16px 24px;max-width:1440px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
.foot-copy{font-size:.7rem;color:var(--text3)}
.foot-copy span{color:var(--text2)}
.foot-bottom-links{display:flex;gap:16px}
.foot-bottom-link{font-size:.68rem;color:var(--text3);cursor:pointer}
.foot-bottom-link:hover{color:var(--text2)}
.saw-fab{position:fixed;bottom:80px;right:16px;z-index:300;display:flex;flex-direction:column;align-items:flex-end;gap:6px}
.saw-fab-btn{display:flex;align-items:center;gap:7px;padding:9px 15px;background:#fff;color:#000;border-radius:var(--radius);font-size:.76rem;font-weight:600;transition:var(--tr);border:none;cursor:pointer;white-space:nowrap;position:relative}
.saw-fab-pulse{position:absolute;top:-3px;right:-3px;width:8px;height:8px;border-radius:50%;background:var(--red);animation:fabPulse 2s infinite}
@keyframes fabPulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.6;transform:scale(1.4)}}
.tg-fab-btn{display:flex;align-items:center;gap:7px;padding:9px 15px;background:var(--bg3);border:1px solid var(--border);color:var(--text2);border-radius:var(--radius);font-size:.76rem;font-weight:500;transition:var(--tr);cursor:pointer;text-decoration:none}
.saw-modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:400;display:none;align-items:flex-end;justify-content:center;backdrop-filter:blur(6px)}
.saw-modal-bg.open{display:flex}
.saw-modal{background:var(--bg2);border:1px solid var(--border);border-top-left-radius:var(--radius2);border-top-right-radius:var(--radius2);width:100%;max-width:480px;padding:0 0 32px;overflow:hidden;animation:sawSlideUp .28s cubic-bezier(.4,0,.2,1)}
@keyframes sawSlideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.saw-modal-handle{width:36px;height:3px;background:var(--border);border-radius:2px;margin:12px auto 0}
.saw-modal-hero{padding:22px 20px 18px;border-bottom:1px solid var(--border2);position:relative}
.saw-modal-ttl{font-size:1rem;font-weight:700;color:var(--text);margin-bottom:4px}
.saw-modal-sub{font-size:.78rem;color:var(--text3);line-height:1.5}
.saw-close{position:absolute;top:12px;right:12px;width:26px;height:26px;border-radius:var(--radius);background:var(--bg3);color:var(--text2);display:flex;align-items:center;justify-content:center;font-size:.65rem;cursor:pointer;border:1px solid var(--border)}
.saw-modal-body{padding:18px 20px 0}
.saw-amounts{display:grid;grid-template-columns:repeat(3,1fr);gap:5px;margin-bottom:12px}
.saw-amt{padding:9px 4px;background:var(--bg3);border:1px solid var(--border2);border-radius:var(--radius);text-align:center;font-size:.75rem;font-weight:500;color:var(--text2);cursor:pointer;transition:var(--tr)}
.saw-amt.on{background:var(--text);border-color:var(--text);color:#000;font-weight:600}
.saw-goto{display:flex;align-items:center;justify-content:center;gap:7px;width:100%;padding:12px;background:var(--text);color:#000;border-radius:var(--radius);font-size:.84rem;font-weight:700;cursor:pointer;transition:var(--tr);border:none;margin-top:2px}
.saw-note{text-align:center;font-size:.65rem;color:var(--text3);margin-top:10px;line-height:1.5}
.pm-hero{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius2);padding:40px 28px;text-align:center;margin-bottom:24px}
.pm-title{font-size:1.5rem;font-weight:800;color:var(--text);margin-bottom:8px}
.pm-subtitle{font-size:.82rem;color:var(--text3);margin-bottom:20px;line-height:1.6}
.pm-stats{display:flex;justify-content:center;gap:32px;margin-bottom:22px}
.pm-stat-num{font-size:1.3rem;font-weight:800;color:var(--text)}
.pm-stat-lbl{font-size:.62rem;color:var(--text3);text-transform:uppercase;letter-spacing:.05em;margin-top:1px}
.pm-cta{display:inline-flex;align-items:center;gap:7px;padding:11px 24px;background:var(--text);color:#000;border-radius:var(--radius);font-size:.84rem;font-weight:700;cursor:pointer;border:none}
.pm-perks{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:1px;background:var(--border2);margin-bottom:24px;border:1px solid var(--border2);border-radius:var(--radius);overflow:hidden}
.pm-perk{background:var(--bg);padding:16px;display:flex;align-items:flex-start;gap:12px;position:relative}
.pm-perk:hover{background:var(--bg2)}
.pm-perk-ico{width:36px;height:36px;border-radius:var(--radius);display:flex;align-items:center;justify-content:center;font-size:1rem;flex-shrink:0;background:var(--bg3);color:var(--text2)}
.pm-perk-body h4{font-size:.82rem;font-weight:600;margin-bottom:3px;color:var(--text)}
.pm-perk-body p{font-size:.72rem;color:var(--text3);line-height:1.5}
.pm-perk-badge{position:absolute;top:12px;right:12px;font-size:.55rem;font-weight:700;padding:2px 6px;border-radius:3px;border:1px solid}
.pm-perk-badge.soon{color:var(--text3);border-color:var(--border)}
.pm-perk-badge.live{color:var(--ml);border-color:rgba(16,185,129,.2)}
.pm-tiers{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:8px;margin-bottom:24px}
.pm-tier{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius2);padding:20px;text-align:center;position:relative}
.pm-tier.popular{border-color:rgba(255,255,255,.16)}
.pm-tier-badge{position:absolute;top:-9px;left:50%;transform:translateX(-50%);background:var(--text);color:#000;font-size:.55rem;font-weight:700;padding:2px 10px;border-radius:3px;white-space:nowrap}
.pm-tier-name{font-size:.65rem;font-weight:600;color:var(--text3);margin-bottom:5px;text-transform:uppercase}
.pm-tier-price{font-size:1.3rem;font-weight:800;color:var(--text);margin-bottom:3px}
.pm-tier-price span{font-size:.65rem;font-weight:400;color:var(--text3)}
.pm-tier-desc{font-size:.7rem;color:var(--text3);margin-bottom:12px;line-height:1.5}
.pm-tier-btn{display:block;padding:9px;background:var(--text);color:#000;border-radius:var(--radius);font-size:.75rem;font-weight:600;cursor:pointer;border:none;width:100%}
.pm-tier-btn.outline{background:none;border:1px solid var(--border);color:var(--text2)}
.pm-faq{margin-bottom:24px}
.pm-faq-item{background:var(--bg2);border:1px solid var(--border2);border-radius:var(--radius);margin-bottom:4px;overflow:hidden}
.pm-faq-q{padding:13px 14px;font-size:.82rem;font-weight:500;cursor:pointer;display:flex;justify-content:space-between;align-items:center;color:var(--text)}
.pm-faq-q i{transition:transform .25s;color:var(--text3);font-size:.65rem}
.pm-faq-q.open i{transform:rotate(180deg)}
.pm-faq-a{padding:0 14px;max-height:0;overflow:hidden;transition:all .25s;font-size:.78rem;color:var(--text3);line-height:1.65}
.pm-faq-a.open{padding:0 14px 13px;max-height:200px}
.pm-donate-box{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius2);padding:22px;text-align:center}
.pm-donate-box h3{font-size:.95rem;font-weight:700;margin-bottom:6px;color:var(--text)}
.pm-donate-box p{font-size:.78rem;color:var(--text3);margin-bottom:14px;line-height:1.6}
.rot-banner{border-radius:var(--radius);margin:0 0 20px;overflow:hidden;position:relative;border:1px solid var(--border)}
.rot-slide{display:none}
.rot-slide.active{display:block;animation:banFade .35s ease}
@keyframes banFade{from{opacity:0}to{opacity:1}}
.rot-banner-inner{padding:13px 16px;display:flex;align-items:center;gap:12px}
.rot-banner-ttl{font-size:.8rem;font-weight:600;margin-bottom:1px}
.rot-banner-sub{font-size:.7rem;opacity:.7;line-height:1.4}
.rot-banner-btn{padding:6px 13px;border-radius:var(--radius);font-size:.7rem;font-weight:600;border:none;cursor:pointer;flex-shrink:0}
.rot-banner-dots{display:flex;gap:3px;position:absolute;bottom:5px;right:8px}
.rot-dot{width:4px;height:4px;border-radius:50%;background:rgba(255,255,255,.25)}
.rot-dot.on{background:rgba(255,255,255,.7);width:12px;border-radius:2px}
.rot-banner-close{position:absolute;top:5px;right:5px;width:18px;height:18px;border-radius:3px;background:rgba(0,0,0,.3);color:rgba(255,255,255,.5);display:flex;align-items:center;justify-content:center;font-size:.5rem;cursor:pointer;border:none}
.fb-sync-status{display:inline-flex;align-items:center;gap:4px;font-size:.62rem;color:var(--ml);padding:3px 8px;background:rgba(16,185,129,.08);border:1px solid rgba(16,185,129,.2);border-radius:var(--radius);margin-left:8px}
/* ══ LOGIN BUTTON ══ */
.login-btn{display:flex;align-items:center;gap:6px;padding:5px 11px;background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius);font-size:.74rem;font-weight:500;color:var(--text2);cursor:pointer;transition:var(--tr);flex-shrink:0;white-space:nowrap}
.login-btn:hover{border-color:rgba(255,255,255,.2);color:var(--text)}
.login-btn img{width:14px;height:14px;border-radius:50%}
.user-avatar{width:28px;height:28px;border-radius:50%;object-fit:cover;border:1.5px solid var(--border);cursor:pointer;flex-shrink:0;transition:var(--tr)}
.user-avatar:hover{border-color:rgba(255,255,255,.3)}
/* ══ LOGIN MODAL ══ */
.auth-modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.88);z-index:600;display:none;align-items:center;justify-content:center;backdrop-filter:blur(12px);padding:20px}
.auth-modal-bg.open{display:flex}
.auth-modal{background:var(--bg2);border:1px solid var(--border);border-radius:14px;width:100%;max-width:340px;overflow:hidden;animation:authPop .22s cubic-bezier(.34,1.56,.64,1)}
@keyframes authPop{from{opacity:0;transform:scale(.9)}to{opacity:1;transform:scale(1)}}
.auth-hero{padding:32px 24px 24px;text-align:center;border-bottom:1px solid var(--border2)}
.auth-logo{width:48px;height:48px;background:var(--red);border-radius:12px;display:flex;align-items:center;justify-content:center;margin:0 auto 14px;font-size:1.3rem;color:#fff}
.auth-title{font-size:1.05rem;font-weight:700;color:var(--text);margin-bottom:5px}
.auth-sub{font-size:.75rem;color:var(--text3);line-height:1.55}
.auth-body{padding:20px 24px 24px;display:flex;flex-direction:column;gap:10px}
.auth-google-btn{display:flex;align-items:center;justify-content:center;gap:10px;padding:11px;background:#fff;color:#1f1f1f;border-radius:var(--radius);font-size:.82rem;font-weight:600;cursor:pointer;border:none;transition:var(--tr);width:100%}
.auth-google-btn:hover{background:#f0f0f0}
.auth-google-btn img{width:18px;height:18px}
.auth-divider{display:flex;align-items:center;gap:10px;color:var(--text3);font-size:.65rem}
.auth-divider::before,.auth-divider::after{content:'';flex:1;height:1px;background:var(--border)}
.auth-anon-btn{display:flex;align-items:center;justify-content:center;gap:7px;padding:10px;background:none;border:1px solid var(--border);color:var(--text3);border-radius:var(--radius);font-size:.76rem;font-weight:500;cursor:pointer;transition:var(--tr);width:100%}
.auth-anon-btn:hover{border-color:rgba(255,255,255,.15);color:var(--text2)}
.auth-note{font-size:.62rem;color:var(--text3);text-align:center;line-height:1.55}
.auth-close{position:absolute;top:12px;right:12px;width:26px;height:26px;border-radius:var(--radius);background:var(--bg3);color:var(--text2);display:flex;align-items:center;justify-content:center;font-size:.65rem;cursor:pointer;border:1px solid var(--border)}
/* ══ USER DROPDOWN ══ */
.user-menu-bg{position:fixed;inset:0;z-index:550;display:none}
.user-menu-bg.open{display:block}
.user-menu{position:fixed;top:58px;right:16px;background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius2);width:220px;z-index:560;overflow:hidden;animation:authPop .18s ease}
.user-menu-head{padding:14px 14px 10px;border-bottom:1px solid var(--border2);display:flex;align-items:center;gap:10px}
.user-menu-avatar{width:36px;height:36px;border-radius:50%;object-fit:cover;flex-shrink:0;border:1.5px solid var(--border)}
.user-menu-name{font-size:.78rem;font-weight:600;color:var(--text);display:block;margin-bottom:1px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:130px}
.user-menu-email{font-size:.62rem;color:var(--text3);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:130px}
.user-menu-item{display:flex;align-items:center;gap:9px;padding:10px 14px;font-size:.76rem;color:var(--text2);cursor:pointer;transition:background .1s;background:none;width:100%;text-align:left}
.user-menu-item:hover{background:var(--bg3);color:var(--text)}
.user-menu-item i{font-size:.7rem;width:14px;color:var(--text3)}
.user-menu-item.danger{color:var(--red)}
.user-menu-item.danger i{color:var(--red)}
.user-menu-item.danger:hover{background:rgba(230,57,70,.08)}
@media(max-width:768px){
  .hdr-in{padding:0 12px;height:52px}.nav{display:none}.mbar{display:block}
  .main{padding:14px 12px 80px}
  .grid{grid-template-columns:repeat(auto-fill,minmax(110px,1fr))}
  .din{flex-direction:column;padding:16px;align-items:center;text-align:center}
  .dposter{width:130px}.dinfo{align-items:center}.dsts{justify-content:center}
  .swrap{max-width:none;flex:1}
  .plat-btn span.plat-name{display:none}
  .saw-fab{bottom:70px;right:12px}
  .foot-top{grid-template-columns:1fr;gap:20px;padding:24px 16px 18px}
  .foot-bottom{flex-direction:column;text-align:center}
}
@media(max-width:400px){.grid{grid-template-columns:repeat(2,1fr)}}
</style>
</head>
<body>
<header class="hdr">
  <div class="hdr-in">
    <div class="logo" onclick="App.goHome()"><i class="fas fa-play-circle"></i><span>DramaFeed</span></div>
    <button class="plat-btn" onclick="App.openPlatModal()">
      <span class="pdot"></span>
      <span class="plat-name" id="platBtnName">DramaBox</span>
      <i class="fas fa-chevron-down" style="font-size:.65rem;color:var(--text3)"></i>
    </button>
    <nav class="nav" id="navDesktop"></nav>
    <div class="swrap">
      <div class="sbox">
        <i class="fas fa-search si"></i>
        <input type="text" id="qInp" placeholder="Cari drama..." autocomplete="off">
        <button class="sgo" onclick="App.doSearch()">Cari</button>
      </div>
      <div id="sugBox" class="sugbox"></div>
    </div>
    <div id="authBtnWrap">
      <button class="login-btn" id="loginBtn" onclick="Auth.openModal()">
        <i class="fab fa-google" style="font-size:.75rem;color:#4285f4"></i>
        <span>Masuk</span>
      </button>
    </div>
  </div>
</header>

<!-- USER MENU BACKDROP -->
<div class="user-menu-bg" id="userMenuBg" onclick="Auth.closeMenu()"></div>
<div class="user-menu" id="userMenu" style="display:none">
  <div class="user-menu-head">
    <img class="user-menu-avatar" id="umAvatar" src="" onerror="this.src=''" alt="">
    <div>
      <span class="user-menu-name" id="umName">User</span>
      <span class="user-menu-email" id="umEmail"></span>
    </div>
  </div>
  <button class="user-menu-item" onclick="Auth.closeMenu();App.openWatchlist()"><i class="fas fa-bookmark"></i> Favorit Saya</button>
  <button class="user-menu-item" onclick="Auth.closeMenu();FB._pullFromCloud();showToast('Menyinkron data...')"><i class="fas fa-cloud-download-alt"></i> Sinkron Cloud</button>
  <button class="user-menu-item danger" onclick="Auth.logout()"><i class="fas fa-sign-out-alt"></i> Keluar</button>
</div>

<!-- AUTH MODAL -->
<div class="auth-modal-bg" id="authModalBg" onclick="Auth._closeBg(event)">
  <div class="auth-modal" style="position:relative">
    <button class="auth-close" onclick="Auth.closeModal()"><i class="fas fa-times"></i></button>
    <div class="auth-hero">
      <div class="auth-logo"><i class="fas fa-play-circle"></i></div>
      <div class="auth-title">Masuk ke DramaFeed</div>
      <div class="auth-sub">Login untuk menyinkron favorit & riwayat nonton di semua perangkat kamu</div>
    </div>
    <div class="auth-body">
      <button class="auth-google-btn" onclick="Auth.loginGoogle()">
        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google">
        Lanjutkan dengan Google
      </button>
      <div class="auth-divider">atau</div>
      <button class="auth-anon-btn" onclick="Auth.loginAnon()">
        <i class="fas fa-user-secret"></i> Lanjutkan sebagai Tamu
      </button>
      <div class="auth-note">Dengan masuk, kamu setuju dengan syarat penggunaan DramaFeed. Data kamu aman dan tidak dibagikan.</div>
    </div>
  </div>
</div>

<div class="plat-modal-bg" id="platModalBg" onclick="App._closePlatModalBg(event)">
  <div class="plat-modal">
    <div class="plat-modal-hdr">
      <h2>Switch Platform</h2>
      <button class="plat-close" onclick="App.closePlatModal()"><i class="fas fa-times"></i></button>
    </div>
    <div class="plat-grid" id="platGrid"></div>
  </div>
</div>

<div class="mbar"><div class="mbar-in" id="navMobile"></div></div>
<main id="root" class="main"><div class="ld"><div class="sp"></div><div class="lt">Memuat drama...</div></div></main>
<div id="toast" class="toast"></div>
<div id="tkPlayer" class="tkp"></div>
<footer class="foot">
  <div class="foot-top">
    <div class="foot-brand">
      <div class="foot-logo"><i class="fas fa-play-circle"></i><span>DramaFeed</span></div>
      <p class="foot-tagline">Platform streaming drama sub Indo terlengkap. Nonton dari 9 platform favorit dalam satu tempat, gratis!</p>
      <div class="foot-socials">
        <a class="foot-social" href="https://t.me/+aTJBTWSaTII1MGFl" target="_blank"><i class="fab fa-telegram-plane"></i></a>
      </div>
    </div>
    <div class="foot-col">
      <h4>Platform</h4>
      <div class="foot-platforms">
        <span class="foot-plat-tag">DramaBox</span><span class="foot-plat-tag">FreeReels</span>
        <span class="foot-plat-tag">MeloLo</span><span class="foot-plat-tag">GoodShort</span>
        <span class="foot-plat-tag">DramaWave</span><span class="foot-plat-tag">ShortMax</span>
        <span class="foot-plat-tag">NetShort</span><span class="foot-plat-tag">DramaBite</span>
        <span class="foot-plat-tag">FlexTV</span>
      </div>
    </div>
    <div class="foot-col">
      <h4>Menu</h4>
      <div class="foot-links">
        <span class="foot-link" onclick="App.goHome()"><i class="fas fa-chevron-right"></i> Beranda</span>
        <span class="foot-link" onclick="App.openWatchlist()"><i class="fas fa-chevron-right"></i> Favorit</span>
        <span class="foot-link" onclick="App.openPremium()"><i class="fas fa-chevron-right"></i> Premium</span>
        <span class="foot-link" onclick="App.openPlatModal()"><i class="fas fa-chevron-right"></i> Ganti Platform</span>
      </div>
    </div>
    <div class="foot-col">
      <h4>Dukung Kami</h4>
      <div class="foot-support">
        <p class="foot-support-sub">DramaFeed gratis untuk semua. Bantu kami tetap online!</p>
        <button class="foot-saw-btn" onclick="Saw.open()">Donasi via Saweria</button>
        <a class="foot-tg-btn" href="https://t.me/+aTJBTWSaTII1MGFl" target="_blank"><i class="fab fa-telegram-plane"></i> Gabung Telegram</a>
      </div>
    </div>
  </div>
  <div class="foot-bottom">
    <div class="foot-copy">&copy; 2026 <span>DramaFeed</span></div>
    <div class="foot-bottom-links">
      <span class="foot-bottom-link" onclick="App.openPremium()">Premium</span>
      <span class="foot-bottom-link" onclick="Saw.open()">Donasi</span>
      <a class="foot-bottom-link" href="https://t.me/+aTJBTWSaTII1MGFl" target="_blank">Telegram</a>
    </div>
  </div>
</footer>

<div class="saw-fab">
  <a class="tg-fab-btn" href="https://t.me/+aTJBTWSaTII1MGFl" target="_blank">
    <i class="fab fa-telegram-plane" style="font-size:1.1rem"></i><span>Grup Telegram</span>
  </a>
  <button class="saw-fab-btn" onclick="Saw.open()">
    <span class="saw-fab-pulse"></span><span>Dukung Kami</span>
  </button>
</div>

<div class="saw-modal-bg" id="sawModalBg" onclick="Saw._closeBg(event)">
  <div class="saw-modal">
    <div class="saw-modal-handle"></div>
    <div class="saw-modal-hero">
      <button class="saw-close" onclick="Saw.close()"><i class="fas fa-times"></i></button>
      <div class="saw-modal-ttl">Dukung DramaFeed</div>
      <div class="saw-modal-sub">DramaFeed gratis untuk semua. Kalau suka, traktir kami kopi!</div>
    </div>
    <div class="saw-modal-body">
      <div class="saw-amounts" id="sawAmounts">
        <div class="saw-amt" onclick="Saw.pick(this,5000)">Rp 5.000</div>
        <div class="saw-amt on" onclick="Saw.pick(this,10000)">Rp 10.000</div>
        <div class="saw-amt" onclick="Saw.pick(this,20000)">Rp 20.000</div>
        <div class="saw-amt" onclick="Saw.pick(this,50000)">Rp 50.000</div>
        <div class="saw-amt" onclick="Saw.pick(this,100000)">Rp 100.000</div>
        <div class="saw-amt" onclick="Saw.pick(this,0)">Lainnya</div>
      </div>
      <button class="saw-goto" onclick="Saw.go()">
        <i class="fas fa-heart"></i><span id="sawGotoTxt">Donasi Rp 10.000 via Saweria</span>
      </button>
      <div class="saw-note">Pembayaran aman via Saweria &mdash; QRIS, Transfer Bank, GoPay, OVO, dll</div>
    </div>
  </div>
</div>
<script>
var FIREBASE_CONFIG = {
  apiKey: "AIzaSyCujwc9sb83xFG-pEBuvW7_cpe1pbQuwPQ",
  authDomain: "dramafeed-bf542.firebaseapp.com",
  projectId: "dramafeed-bf542",
  storageBucket: "dramafeed-bf542.firebasestorage.app",
  messagingSenderId: "1038586962200",
  appId: "1:1038586962200:web:1b417b2d2c754bcf7d3e6d",
  measurementId: "G-7Q1F919QF3"
};

var TOKEN='53d25de32c37b0fcd2b14a9f834050493cc044d5039b5aff3283da73a8ef761b';
var DB_BASE='https://captain.sapimu.au/dramabox/api/v1';
var FR_BASE='https://captain.sapimu.au/freereels/api/v1';
var FR_LANG='id-ID';
var ML_BASE='https://api.sonzaix.indevs.in/melolo';
var GS_BASE='https://captain.sapimu.au/goodshort/api/v1';
var DW_BASE='https://captain.sapimu.au/dramawave/api/v1';
var DW_LANG='id-ID';
var SM_BASE='https://captain.sapimu.au/shortmax/api/v1';
var SM_LANG='id';
var NS_BASE='https://captain.sapimu.au/netshort/api/v1';
var DB2_BASE='https://captain.sapimu.au/dramabite/api/v1';
var FX_BASE='https://captain.sapimu.au/flextv/api/v1';
var FX_LANG='id';
var GS_CHANNEL=562;

var PLAT_IMGS={
  dramabox:'https://i.ibb.co.com/QFC6BSdM/images-5.jpg',
  freereels:'https://i.ibb.co.com/nH248Pd/unnamed.png',
  melolo:'https://i.ibb.co.com/k6x2zvBL/images-6.jpg',
  goodshort:'https://i.ibb.co.com/FbrKcHdw/images-8.jpg',
  dramawave:'https://i.ibb.co.com/x87TDkkW/images-9.jpg',
  shortmax:'https://i.ibb.co.com/8LZ4s6mc/images-1.png',
  netshort:'https://i.ibb.co.com/Mx6tGKcJ/images-10.jpg',
  dramabite:'https://i.ibb.co.com/tPB7fjFZ/images-12.jpg',
  flextv:'https://i.ibb.co.com/RkKRFqMY/images-2.png'
};
var PLAT_NAMES={dramabox:'DramaBox',freereels:'FreeReels',melolo:'MeloLo',goodshort:'GoodShort',dramawave:'DramaWave',shortmax:'ShortMax',netshort:'NetShort',dramabite:'DramaBite',flextv:'FlexTV'};
var TABS={
  dramabox:[{id:'foryou',icon:'fa-heart',label:'Untuk Kamu'},{id:'new',icon:'fa-bolt',label:'Terbaru'},{id:'rank',icon:'fa-trophy',label:'Peringkat'},{id:'classify',icon:'fa-th-large',label:'Semua'}],
  freereels:[{id:'foryou',icon:'fa-heart',label:'Untuk Kamu'},{id:'popular',icon:'fa-fire',label:'Populer'},{id:'new',icon:'fa-bolt',label:'Terbaru'},{id:'anime',icon:'fa-dragon',label:'Anime'},{id:'dubbing',icon:'fa-microphone',label:'Dubbing'},{id:'coming-soon',icon:'fa-clock',label:'Segera'}],
  melolo:[{id:'home',icon:'fa-home',label:'Home'},{id:'populer',icon:'fa-fire',label:'Populer'},{id:'new',icon:'fa-bolt',label:'Terbaru'}],
  goodshort:[{id:'home',icon:'fa-home',label:'Home'},{id:'new',icon:'fa-bolt',label:'Terbaru'},{id:'popular',icon:'fa-fire',label:'Populer'}],
  dramawave:[{id:'popular',icon:'fa-fire',label:'Populer'},{id:'new',icon:'fa-bolt',label:'Terbaru'}],
  shortmax:[{id:'foryou',icon:'fa-heart',label:'Untuk Kamu'},{id:'recommend',icon:'fa-thumbs-up',label:'Rekomendasi'},{id:'new',icon:'fa-bolt',label:'Terbaru'},{id:'ranked',icon:'fa-trophy',label:'Peringkat'},{id:'romance',icon:'fa-heart-pulse',label:'Romance'},{id:'epic',icon:'fa-dragon',label:'Epic'},{id:'war',icon:'fa-shield',label:'Perang'},{id:'vip',icon:'fa-crown',label:'VIP'}],
  netshort:[{id:'feed',icon:'fa-heart',label:'Untuk Kamu'},{id:'explore',icon:'fa-compass',label:'Jelajahi'},{id:'new',icon:'fa-bolt',label:'Terbaru'},{id:'dubbing',icon:'fa-microphone',label:'Dubbing'},{id:'vip',icon:'fa-crown',label:'VIP'}],
  dramabite:[{id:'foryou',icon:'fa-heart',label:'Untuk Kamu'},{id:'hot',icon:'fa-fire',label:'Hot'},{id:'recommend',icon:'fa-thumbs-up',label:'Rekomendasi'},{id:'new',icon:'fa-bolt',label:'Terbaru'}],
  flextv:[{id:'popular',icon:'fa-fire',label:'Populer'},{id:'new',icon:'fa-bolt',label:'Terbaru'}]
};
var lastRaw=null,currentVideoUrl='';

// ══ FIREBASE MANAGER ══
var FB={
  _db:null,_auth:null,_uid:null,_ready:false,_user:null,
  init:function(){
    var self=this;
    if(!FIREBASE_CONFIG.apiKey||FIREBASE_CONFIG.apiKey==='YOUR_API_KEY'){
      console.warn('[Firebase] Config belum diisi - cloud sync dinonaktifkan');return;
    }
    try{
      firebase.initializeApp(FIREBASE_CONFIG);
      self._db=firebase.firestore();self._auth=firebase.auth();
      // Listen to auth state changes
      self._auth.onAuthStateChanged(function(user){
        if(user){
          self._uid=user.uid;self._ready=true;self._user=user;
          self._pullFromCloud();self._showBadge();
          Auth._onLogin(user);
        }else{
          self._ready=false;self._uid=null;self._user=null;
          Auth._onLogout();
        }
      });
    }catch(e){console.warn('[Firebase] Init gagal:',e.message)}
  },
  _ref:function(){return this._db.collection('users').doc(this._uid)},
  syncWL:function(){
    if(!this._ready)return;
    this._ref().set({watchlist:Store.wlGet(),wl_ts:firebase.firestore.FieldValue.serverTimestamp()},{merge:true})
      .catch(function(e){console.warn('[FB] syncWL:',e.message)});
  },
  syncCW:function(){
    if(!this._ready)return;
    this._ref().set({continue_watching:Store.cwGet(),cw_ts:firebase.firestore.FieldValue.serverTimestamp()},{merge:true})
      .catch(function(e){console.warn('[FB] syncCW:',e.message)});
  },
  _pullFromCloud:function(){
    var self=this;
    self._ref().get().then(function(doc){
      if(!doc.exists)return;var d=doc.data();var changed=false;
      if(d.watchlist&&Array.isArray(d.watchlist)&&d.watchlist.length){
        var loc=Store.wlGet();var m=d.watchlist.slice();
        loc.forEach(function(i){if(!m.find(function(x){return x.id===i.id&&x.src===i.src}))m.unshift(i)});
        Store.set('wl',m);changed=true;
      }
      if(d.continue_watching&&Array.isArray(d.continue_watching)&&d.continue_watching.length){
        var loc2=Store.cwGet();var m2=d.continue_watching.slice();
        loc2.forEach(function(i){if(!m2.find(function(x){return x.id===i.id&&x.src===i.src}))m2.unshift(i)});
        if(m2.length>30)m2=m2.slice(0,30);
        Store.set('cw',m2);changed=true;
      }
      if(changed)showToast('\u2601\ufe0f Data disinkron dari cloud!');
    }).catch(function(e){console.warn('[FB] pull:',e.message)});
  },
  _showBadge:function(){
    var btn=document.querySelector('.plat-btn');
    if(btn&&!document.getElementById('fbSyncBadge')){
      var b=document.createElement('span');b.id='fbSyncBadge';b.title='Cloud Sync Aktif';
      b.style.cssText='width:6px;height:6px;border-radius:50%;background:#10b981;display:inline-block;margin-left:2px;flex-shrink:0';
      btn.appendChild(b);
    }
  }
};

// ══ AUTH MANAGER ══
var Auth={
  _pendingPlay:null,
  openModal:function(fromWatch){
    var sub=document.querySelector('.auth-sub');
    if(sub){
      if(fromWatch||Auth._pendingPlay){
        sub.innerHTML='<span style="color:var(--red);font-weight:700">&#128274; Login untuk Menonton</span><br><small>Kamu harus login Google dulu sebelum bisa nonton drama.</small>';
      }else{
        sub.textContent='Login untuk menyinkron favorit dan riwayat nonton di semua perangkat kamu';
      }
    }
    document.getElementById('authModalBg').classList.add('open');
    document.body.classList.add('noscroll');
  },
  closeModal:function(){
    document.getElementById('authModalBg').classList.remove('open');
    document.body.classList.remove('noscroll');
  },
  _closeBg:function(e){if(e.target===document.getElementById('authModalBg'))this.closeModal()},
  loginGoogle:function(){
    var self=this;
    var provider=new firebase.auth.GoogleAuthProvider();
    provider.setCustomParameters({prompt:'select_account'});
    FB._auth.signInWithPopup(provider).then(function(result){
      self.closeModal();
      showToast('\u2705 Login berhasil! Halo, '+result.user.displayName.split(' ')[0]+'!');
    }).catch(function(e){
      if(e.code==='auth/popup-blocked'){
        FB._auth.signInWithRedirect(provider);
      }else{
        showToast('\u274c Login gagal: '+e.message);
        console.warn('[Auth] Google login error:',e);
      }
    });
  },
  loginAnon:function(){
    if(Auth._pendingPlay){showToast('&#128274; Login Google diperlukan untuk menonton!');return;}
    var self=this;
    FB._auth.signInAnonymously().then(function(){
      self.closeModal();
      showToast('\u{1F464} Masuk sebagai tamu');
    }).catch(function(e){
      showToast('\u274c Gagal: '+e.message);
    });
  },
  logout:function(){
    Auth.closeMenu();
    FB._auth.signOut().then(function(){
      showToast('Berhasil keluar');
    }).catch(function(e){console.warn('[Auth] logout error:',e)});
  },
  _onLogin:function(user){
    var wrap=document.getElementById('authBtnWrap');
    if(!wrap)return;
    var isAnon=user.isAnonymous;
    // Resume pending play setelah login Google
    if(!isAnon&&Auth._pendingPlay){
      var pp=Auth._pendingPlay;Auth._pendingPlay=null;
      setTimeout(function(){App.play(pp.dKey,pp.ep)},400);
    }
    if(isAnon){
      wrap.innerHTML='<button class="login-btn" onclick="Auth.openModal()" title="Tamu - Klik untuk login Google"><i class="fas fa-user-secret" style="font-size:.75rem;color:var(--text3)"></i><span style="display:none" class="plat-name">Tamu</span></button>';
    }else{
      var photo=user.photoURL||'';
      var name=user.displayName||user.email||'User';
      var initials=name.charAt(0).toUpperCase();
      if(photo){
        var avatarEl=document.createElement('img');
        avatarEl.className='user-avatar';
        avatarEl.src=photo;
        avatarEl.alt=initials;
        avatarEl.title=name;
        avatarEl.onclick=function(){Auth.toggleMenu()};
        avatarEl.onerror=function(){
          var btn=document.createElement('button');
          btn.className='login-btn';
          btn.style.cssText='gap:6px;padding:4px';
          btn.onclick=function(){Auth.toggleMenu()};
          btn.innerHTML='<span style="width:28px;height:28px;border-radius:50%;background:var(--red);display:flex;align-items:center;justify-content:center;font-size:.75rem;color:#fff;font-weight:700">'+initials+'</span>';
          this.parentNode&&this.parentNode.replaceChild(btn,this);
        };
        wrap.innerHTML='';
        wrap.appendChild(avatarEl);
      }else{
        wrap.innerHTML='<button class="login-btn" onclick="Auth.toggleMenu()" style="gap:6px"><span style="width:22px;height:22px;border-radius:50%;background:var(--red);display:flex;align-items:center;justify-content:center;font-size:.65rem;color:#fff;font-weight:700">'+initials+'</span></button>';
      }
      // Update menu info
      var ua=document.getElementById('umAvatar');var un=document.getElementById('umName');var ue=document.getElementById('umEmail');
      if(ua)ua.src=photo;
      if(un)un.textContent=name;
      if(ue)ue.textContent=user.email||'Akun Google';
    }
  },
  _onLogout:function(){
    var wrap=document.getElementById('authBtnWrap');
    if(wrap)wrap.innerHTML='<button class="login-btn" id="loginBtn" onclick="Auth.openModal()"><i class="fab fa-google" style="font-size:.75rem;color:#4285f4"></i><span>Masuk</span></button>';
    Auth.closeMenu();
  },
  toggleMenu:function(){
    var menu=document.getElementById('userMenu');
    var bg=document.getElementById('userMenuBg');
    if(!menu)return;
    var isOpen=menu.style.display==='block';
    menu.style.display=isOpen?'none':'block';
    bg.classList.toggle('open',!isOpen);
  },
  closeMenu:function(){
    var menu=document.getElementById('userMenu');
    var bg=document.getElementById('userMenuBg');
    if(menu)menu.style.display='none';
    if(bg)bg.classList.remove('open');
  }
};

// ══ STORE ══
var Store={
  _k:function(ns){return 'df_'+ns},
  get:function(ns){try{return JSON.parse(localStorage.getItem(this._k(ns)))||[]}catch(e){return[]}},
  set:function(ns,v){try{localStorage.setItem(this._k(ns),JSON.stringify(v))}catch(e){}},
  cwGet:function(){return this.get('cw')},
  cwSave:function(item){
    var list=this.cwGet();var idx=list.findIndex(function(x){return x.id===item.id&&x.src===item.src});
    if(idx>-1)list.splice(idx,1);list.unshift(item);if(list.length>30)list=list.slice(0,30);
    this.set('cw',list);setTimeout(function(){FB.syncCW()},500);
  },
  cwRemove:function(id,src){this.set('cw',this.cwGet().filter(function(x){return!(x.id===id&&x.src===src)}));setTimeout(function(){FB.syncCW()},500)},
  cwClear:function(){this.set('cw',[]);setTimeout(function(){FB.syncCW()},500)},
  cwFind:function(id,src){return this.cwGet().find(function(x){return x.id===id&&x.src===src})||null},
  wlGet:function(){return this.get('wl')},
  wlAdd:function(item){
    var list=this.wlGet();if(list.find(function(x){return x.id===item.id&&x.src===item.src}))return false;
    list.unshift(item);this.set('wl',list);setTimeout(function(){FB.syncWL()},500);return true;
  },
  wlRemove:function(id,src){this.set('wl',this.wlGet().filter(function(x){return!(x.id===id&&x.src===src)}));setTimeout(function(){FB.syncWL()},500)},
  wlHas:function(id,src){return!!this.wlGet().find(function(x){return x.id===id&&x.src===src})},
  wlToggle:function(item){if(this.wlHas(item.id,item.src)){this.wlRemove(item.id,item.src);return false}else{this.wlAdd(item);return true}}
};

function showToast(m){var t=document.getElementById('toast');t.textContent=m;t.classList.add('show');setTimeout(function(){t.classList.remove('show')},2500)}
function copyUrl(){if(currentVideoUrl){navigator.clipboard.writeText(currentVideoUrl).then(function(){showToast('URL disalin')}).catch(function(){showToast('Gagal menyalin')})}}

function apiFetch(b,p){return fetch(b+p,{headers:{'Authorization':'Bearer '+TOKEN,'Accept':'application/json'}}).then(function(r){return r.json()}).then(function(j){lastRaw=j;return j})}
function frFetch(p){return fetch(FR_BASE+p,{headers:{'Authorization':'Bearer '+TOKEN,'Accept':'application/json'}}).then(function(r){return r.json()}).then(function(j){lastRaw=j;return j})}
function mlFetch(p){return fetch(ML_BASE+p,{headers:{'Accept':'application/json'}}).then(function(r){return r.json()}).then(function(j){lastRaw=j;return j})}
function gsFetch(p){return fetch(GS_BASE+p,{headers:{'Authorization':'Bearer '+TOKEN,'Accept':'application/json'}}).then(function(r){return r.json()}).then(function(j){lastRaw=j;return j})}

var DB={
  foryou:function(p){return apiFetch(DB_BASE,'/foryou/'+p+'?lang=in')},
  newest:function(p){return apiFetch(DB_BASE,'/new/'+p+'?lang=in')},
  rank:function(p){return apiFetch(DB_BASE,'/rank/'+p+'?lang=in')},
  classify:function(p,s){return apiFetch(DB_BASE,'/classify?lang=in&pageNo='+p+'&pageSize=20&sort='+s)},
  search:function(q,p){return apiFetch(DB_BASE,'/search/'+encodeURIComponent(q)+'/'+p+'?lang=in&pageSize=20')},
  suggest:function(q){return apiFetch(DB_BASE,'/suggest/'+encodeURIComponent(q)+'?lang=in')},
  chapters:function(id){return apiFetch(DB_BASE,'/chapters/'+id+'?lang=in')},
  watch:function(id,ep){return apiFetch(DB_BASE,'/watch/'+id+'/'+ep+'?lang=in&direction=1')},
  batch:function(id){return apiFetch(DB_BASE,'/batch/watch?bookId='+id+'&lang=in')}
};
var FR={
  foryou:function(){return frFetch('/foryou?lang='+FR_LANG)},
  popular:function(p){return frFetch('/popular?page='+(p||0)+'&lang='+FR_LANG)},
  newest:function(p){return frFetch('/new?page='+(p||0)+'&lang='+FR_LANG)},
  anime:function(p){return frFetch('/anime?page='+(p||0)+'&lang='+FR_LANG)},
  dubbing:function(p){return frFetch('/dubbing?page='+(p||0)+'&lang='+FR_LANG)},
  comingSoon:function(){return frFetch('/coming-soon?lang='+FR_LANG)},
  search:function(q,p){return frFetch('/search?q='+encodeURIComponent(q)+'&page='+(p||0)+'&lang='+FR_LANG)},
  suggest:function(q){return frFetch('/search/suggest?q='+encodeURIComponent(q)+'&lang='+FR_LANG)},
  detail:function(id){return frFetch('/dramas/'+encodeURIComponent(id)+'?lang='+FR_LANG)},
  episodes:function(id){return frFetch('/dramas/'+encodeURIComponent(id)+'/episodes?lang='+FR_LANG)},
  play:function(id,ep){return frFetch('/dramas/'+encodeURIComponent(id)+'/play/'+ep+'?lang='+FR_LANG)}
};
var ML={
  home:function(p){return mlFetch('/home?page='+p)},
  populer:function(p){return mlFetch('/populer?page='+p)},
  newest:function(p){return mlFetch('/new?page='+p)},
  search:function(q,p){return mlFetch('/search?q='+encodeURIComponent(q)+'&result=10&page='+p)},
  detail:function(id){return mlFetch('/detail/'+encodeURIComponent(id))},
  stream:function(epId){return mlFetch('/stream/'+encodeURIComponent(epId))}
};
var GS={
  home:function(p,ps){return gsFetch('/home?channelId='+GS_CHANNEL+'&page='+(p||1)+'&pageSize='+(ps||12))},
  search:function(q,p){return gsFetch('/search?q='+encodeURIComponent(q)+(p?'&page='+p:''))},
  book:function(id){return gsFetch('/book/'+id)},
  chapters:function(id){return gsFetch('/chapters/'+id)},
  play:function(bookId,chapterId,q){return gsFetch('/play/'+bookId+'/'+chapterId+'?q='+(q||'720p'))},
  unlock:function(bookId,q){return gsFetch('/unlock/'+bookId+'?q='+(q||'720p'))}
};
var DW={
  popular:function(p){return apiFetch(DW_BASE,'/feed/popular?page='+(p||1)+'&lang='+DW_LANG)},
  search:function(q,p){return apiFetch(DW_BASE,'/search?q='+encodeURIComponent(q)+'&lang='+DW_LANG+(p?'&page='+p:''))},
  keywords:function(q){return apiFetch(DW_BASE,'/search/keywords?q='+encodeURIComponent(q)+'&lang='+DW_LANG)},
  detail:function(id){return apiFetch(DW_BASE,'/dramas/'+id+'?lang='+DW_LANG)},
  play:function(id,ep){return apiFetch(DW_BASE,'/dramas/'+id+'/play/'+ep+'?lang='+DW_LANG)}
};
var SM={
  foryou:function(p){return apiFetch(SM_BASE,'/foryou?page='+(p||1)+'&lang='+SM_LANG)},
  recommend:function(p){return apiFetch(SM_BASE,'/feed/recommend?lang='+SM_LANG+(p?'&page='+p:''))},
  newest:function(p){return apiFetch(SM_BASE,'/feed/new?lang='+SM_LANG+(p?'&page='+p:''))},
  ranked:function(p){return apiFetch(SM_BASE,'/feed/ranked?lang='+SM_LANG+(p?'&page='+p:''))},
  romance:function(p){return apiFetch(SM_BASE,'/feed/romance?lang='+SM_LANG+(p?'&page='+p:''))},
  epic:function(p){return apiFetch(SM_BASE,'/feed/epic?lang='+SM_LANG+(p?'&page='+p:''))},
  war:function(p){return apiFetch(SM_BASE,'/feed/war?lang='+SM_LANG+(p?'&page='+p:''))},
  vip:function(p){return apiFetch(SM_BASE,'/feed/vip?lang='+SM_LANG+(p?'&page='+p:''))},
  search:function(q,p){return apiFetch(SM_BASE,'/search?q='+encodeURIComponent(q)+'&lang='+SM_LANG+'&page='+(p||1))},
  detail:function(id){return apiFetch(SM_BASE,'/detail/'+id+'?lang='+SM_LANG)},
  play:function(id,ep){return apiFetch(SM_BASE,'/play/'+id+'?ep='+ep+'&lang='+SM_LANG)}
};
var NS={
  feed:function(p){return apiFetch(NS_BASE,'/feed/'+(p||1))},
  explore:function(p){return apiFetch(NS_BASE,'/explore/'+(p||1))},
  newest:function(p){return apiFetch(NS_BASE,'/new/'+(p||1))},
  dubbing:function(p){return apiFetch(NS_BASE,'/dubbing/'+(p||1))},
  vip:function(p){return apiFetch(NS_BASE,'/vip/'+(p||1))},
  search:function(q,p){return apiFetch(NS_BASE,'/search/'+encodeURIComponent(q)+'/'+(p||1))},
  hint:function(q){return apiFetch(NS_BASE,'/search-hint'+(q?'?q='+encodeURIComponent(q):''))},
  detail:function(id){return apiFetch(NS_BASE,'/detail/'+id)},
  episodes:function(id){return apiFetch(NS_BASE,'/episodes/'+id)},
  episode:function(id,ep){return apiFetch(NS_BASE,'/episode/'+id+'/'+ep)}
};
var DB2={
  foryou:function(p){return apiFetch(DB2_BASE,'/foryou?lang=id&page='+(p||0))},
  hot:function(p){return apiFetch(DB2_BASE,'/hot?lang=id&page='+(p||0))},
  recommend:function(p){return apiFetch(DB2_BASE,'/recommend?lang=id&page='+(p||0))},
  dramas:function(p){return apiFetch(DB2_BASE,'/dramas?lang=id&page='+(p||0))},
  detail:function(id){return apiFetch(DB2_BASE,'/drama/'+id+'?lang=id')},
  episode:function(id,ep,q){return apiFetch(DB2_BASE,'/drama/'+id+'/episode/'+ep+'?lang=id&quality='+(q||'default'))},
  search:function(q,p){return apiFetch(DB2_BASE,'/search?q='+encodeURIComponent(q)+'&lang=id&limit=20&page='+(p||0))}
};
var FX={
  popular:function(p){return apiFetch(FX_BASE,'/tabs/popular?page='+(p||1)+'&lang='+FX_LANG)},
  newest:function(p){return apiFetch(FX_BASE,'/tabs/new?page='+(p||1)+'&lang='+FX_LANG)},
  search:function(q,p){return apiFetch(FX_BASE,'/search?q='+encodeURIComponent(q)+'&page='+(p||1)+'&lang='+FX_LANG)},
  detail:function(id){return apiFetch(FX_BASE,'/series/'+id+'?lang='+FX_LANG)},
  episodes:function(id){return apiFetch(FX_BASE,'/series/'+id+'/episodes?lang='+FX_LANG)},
  play:function(seriesId,episodeId){return apiFetch(FX_BASE,'/play/'+seriesId+'/'+episodeId+'?lang='+FX_LANG)}
};

// ════ HELPERS ════
function flattenObj(o,p,d){var r={};if(!o||typeof o!=='object'||d>4)return r;p=p||'';d=d||0;Object.keys(o).forEach(function(k){var v=o[k],f=p?p+'.'+k:k;if(v===null||v===undefined)return;if(typeof v==='string'||typeof v==='number'||typeof v==='boolean'){r[f]=v;r[k]=v}else if(Array.isArray(v)){r[f]=v;r[k]=v}else if(typeof v==='object'){var n=flattenObj(v,f,d+1);Object.keys(n).forEach(function(nk){r[nk]=n[nk]})}});return r}
function smartGet(f,c){for(var i=0;i<c.length;i++){var v=f[c[i]];if(v!==undefined&&v!==null&&v!=='')return v}return null}
function fixImageUrl(url){if(!url||typeof url!=='string')return'';if(url.includes('.heic')||url.includes('fizzopic.org'))return'https://wsrv.nl/?url='+encodeURIComponent(url)+'&output=webp&q=80';return url}
function getCover(r){if(!r)return'';var c=r.cover||r.thumb_url||r.thumbUrl||r.thumb||r.coverUrl||r.cover_url||r.image||r.img||r.poster||r.thumbnail||r.pic||r.banner||'';if(c&&typeof c==='string')return fixImageUrl(c);if(c&&typeof c==='object'&&c.url)return fixImageUrl(c.url);return''}
function normD(r){
  if(!r||typeof r==='string')return null;
  var id=r.bookId||r.book_id||r.drama_id||r.dramaId||r.series_id||r.seriesId||r.id||r.key||r.slug||(typeof r.code==='string'?r.code:null);
  var nm=r.drama_name||r.dramaName||r.bookName||r.book_name||r.series_name||r.seriesName||r.title||r.name;
  var img=getCover(r);var desc=r.description||r.introduction||r.desc||r.synopsis||'';
  var eps=r.episode_count||r.episodeCount||r.chapterCount||r.chapter_count||r.totalEpisodes||r.total_episodes||r.epCount||r.ep_count||0;
  var tag=r.tags||r.label||r.tag||r.genre||r.genres||r.categories||r.classify_name||'';
  var sc=r.score||r.rating||0;var vw=r.watch_value||r.watchValue||r.playCount||r.play_count||r.view_count||r.viewCount||r.views||0;
  if(typeof eps==='string')eps=parseInt(eps)||0;if(typeof eps==='object')eps=Array.isArray(eps)?eps.length:0;
  if(Array.isArray(tag))tag=tag.join(', ');if(!id||!nm)return null;
  return{id:String(id),name:nm,img:img,desc:desc,eps:eps,tag:tag,score:sc,views:vw,raw:r};
}
function normChap(r,i){
  if(typeof r==='number')return{num:r,title:'Episode '+r,streamId:''};
  if(typeof r==='string')return{num:i+1,title:r,streamId:''};
  var n=r.chapterNo||r.episode||r.ep||r.number||r.index||r.sort||r.no||(i+1);
  var t=r.chapterName||r.title||r.name||r.episodeTitle||('Episode '+n);
  var sid=r.video_id||r.id||r.episodeId||r.episode_id||r.chapterId||r.item_id||'';
  return{num:parseInt(n)||(i+1),title:t,streamId:String(sid||'')};
}
function toList(res){
  if(!res)return[];if(Array.isArray(res))return res;
  if(res.episode_list&&Array.isArray(res.episode_list))return res.episode_list;
  if(res.episodes&&Array.isArray(res.episodes))return res.episodes;
  if(res.data&&Array.isArray(res.data)&&res.data.length>0){
    var first=res.data[0];
    if(first&&typeof first==='object'&&!Array.isArray(first)){
      var nk=['books','items','dramas','list','videos','series'];
      for(var ki=0;ki<nk.length;ki++){var key=nk[ki];if(first[key]&&Array.isArray(first[key])&&first[key].length>0){var combined=[];res.data.forEach(function(item){if(item&&item[key]&&Array.isArray(item[key]))combined=combined.concat(item[key])});if(combined.length>0)return combined}}
      if(first.id||first.dramaId||first.bookId||first.drama_id||first.key||first.slug||first.seriesId)return res.data;
    }
    if(Array.isArray(first))return first;return res.data;
  }
  if(res.items&&Array.isArray(res.items)){if(res.items.length&&typeof res.items[0]==='object'&&res.items[0].items){var out=[];res.items.forEach(function(m){if(m&&Array.isArray(m.items))out=out.concat(m.items)});return out}return res.items}
  if(res.result&&Array.isArray(res.result))return res.result;
  if(res.books&&Array.isArray(res.books))return res.books;
  if(res.list&&Array.isArray(res.list))return res.list;
  if(res.series&&Array.isArray(res.series))return res.series;
  if(res.dramas&&Array.isArray(res.dramas))return res.dramas;
  if(res.content&&Array.isArray(res.content))return res.content;
  var found=[];
  (function walk(x,depth){
    if(!x||depth>5)return;if(Array.isArray(x)){x.forEach(function(i){walk(i,depth+1)});return}
    if(typeof x!=='object')return;
    var hasId=x.key||x.id||x.bookId||x.slug||x.dramaId||x.drama_id||x.seriesId||x.series_id;
    var hasTitle=x.title||x.name||x.bookName||x.dramaName||x.drama_name||x.seriesName;
    if(hasId&&hasTitle){found.push(x);return}
    Object.keys(x).forEach(function(k){if('page_info author contact message type status'.indexOf(k)>-1)return;walk(x[k],depth+1)});
  })(res,0);
  return found;
}
function fxToList(res){
  if(!res)return[];var data=res.data||res;
  if(data.floor&&Array.isArray(data.floor)){var out=[];var seen={};data.floor.forEach(function(floor){var sl=floor.series_list||floor.seriesList||floor.list||floor.items||[];if(!Array.isArray(sl))return;sl.forEach(function(s){var uid=String(s.series_id||s.id||'');if(uid&&!seen[uid]){seen[uid]=true;out.push(s)}})});if(out.length)return out}
  if(data.list&&Array.isArray(data.list)&&data.list.length)return data.list;
  if(data.series&&Array.isArray(data.series)&&data.series.length)return data.series;
  if(data.items&&Array.isArray(data.items)&&data.items.length)return data.items;
  if(Array.isArray(res)&&res.length)return res;
  return toList(res);
}
function db2ToList(res){
  if(!res)return[];
  var candidates=[res.data,res.dramas,res.content,res.list,res.items,res.result,res.videos,res.books];
  for(var ci=0;ci<candidates.length;ci++){var c=candidates[ci];if(Array.isArray(c)&&c.length>0)return c;if(c&&typeof c==='object'&&!Array.isArray(c)){var ik=['dramas','content','list','items','videos','books','data'];for(var ii=0;ii<ik.length;ii++){if(c[ik[ii]]&&Array.isArray(c[ik[ii]])&&c[ik[ii]].length>0)return c[ik[ii]]}}}
  return toList(res);
}
function hasMore(r,l,src){
  if(r.page_info&&r.page_info.has_next!==undefined)return!!r.page_info.has_next;
  if(r.hasMore!==undefined)return!!r.hasMore;if(r.has_next!==undefined)return!!r.has_next;
  var d=r.data||r;if(d&&d.hasMore!==undefined)return!!d.hasMore;if(d&&d.has_next!==undefined)return!!d.has_next;
  if(src==='melolo'||src==='goodshort')return l.length>0;if(src==='flextv')return l.length>=8;return l.length>=10;
}
function extractFromQualities(qualities){
  if(!qualities||!Array.isArray(qualities)||!qualities.length)return'';
  var sorted=qualities.slice().sort(function(a,b){var hA=parseInt(String(a.label||a.height||0).replace(/[^0-9]/g,''))||0;var hB=parseInt(String(b.label||b.height||0).replace(/[^0-9]/g,''))||0;return hB-hA});
  for(var i=0;i<sorted.length;i++){var q=sorted[i];var url=q.url||q.play_url||q.video_url||q.stream_url||q.src||q.source||q.link||q.file||'';if(!url&&q.play_addr){if(typeof q.play_addr==='string')url=q.play_addr;else if(q.play_addr.url_list&&q.play_addr.url_list.length)url=q.play_addr.url_list[0]}if(!url&&q.url_list&&q.url_list.length)url=q.url_list[0];if(url)return url}
  return'';
}
function extractVideoUrl(d){
  if(!d)return'';if(typeof d==='string')return d;
  if(d.qualities&&Array.isArray(d.qualities)&&d.qualities.length){var qu=extractFromQualities(d.qualities);if(qu)return qu}
  if(d.data&&d.data.qualities){var qu2=extractFromQualities(d.data.qualities);if(qu2)return qu2}
  var u=d.m3u8||d.video_url||d.videoUrl||d.stream_url||d.streamUrl||d.url||d.video||d.m3u8_url||d.playUrl||d.hlsUrl||d.mp4_url||d.mp4||d.src||d.source||d.link||d.stream||d.play_url||'';
  if(u)return u;if(d.data)return extractVideoUrl(d.data);if(d.result)return extractVideoUrl(d.result);
  var f=flattenObj(d,'',0);return smartGet(f,['video_url','videoUrl','stream_url','streamUrl','url','video','playUrl','m3u8_url','m3u8','mp4_url','mp4','src','source','link','stream','play_url'])||'';
}
function fmtV(n){if(!n)return'0';if(typeof n==='string'&&(n.includes('M')||n.includes('K')))return n;n=parseInt(String(n).replace(/[^\d]/g,''))||0;if(n>=1e6)return(n/1e6).toFixed(1)+'M';if(n>=1e3)return(n/1e3).toFixed(1)+'K';return String(n)}
function esc(s){if(!s)return'';var d=document.createElement('div');d.textContent=String(s);return d.innerHTML}
if(!Promise.allSettled){Promise.allSettled=function(a){return Promise.all(a.map(function(p){return Promise.resolve(p).then(function(v){return{status:'fulfilled',value:v}},function(e){return{status:'rejected',reason:e}})}))}}

var DS={};
function storeD(d){var k='D_'+d.id;DS[k]=d;return k}
function getD(k){return DS[k]||null}

// ════ PLATFORM LIST ════
var PLAT_LIST=[
  {id:'dramabox',name:'DramaBox',badge:false},{id:'freereels',name:'FreeReels',badge:false},
  {id:'melolo',name:'MeloLo',badge:false},{id:'goodshort',name:'GoodShort',badge:true},
  {id:'dramawave',name:'DramaWave',badge:true},{id:'shortmax',name:'ShortMax',badge:true},
  {id:'netshort',name:'NetShort',badge:true},{id:'dramabite',name:'DramaBite',badge:true},
  {id:'flextv',name:'FlexTV',badge:true}
];
function buildPlatGrid(currentSrc){
  var h='';
  PLAT_LIST.forEach(function(p){
    h+='<div class="plat-card'+(p.id===currentSrc?' selected':'')+'" onclick="App.setSource(\''+p.id+'\')">'+
       '<div class="plat-card-ico"><img src="'+(PLAT_IMGS[p.id]||'')+'" style="width:100%;height:100%;object-fit:cover;border-radius:7px" onerror="this.style.display=\'none\'"></div>'+
       '<div class="plat-card-name">'+p.name+'</div>'+
       (p.badge?'<span class="plat-badge-new">NEW</span>':'')+
       '<div class="plat-check"><i class="fas fa-check"></i></div>'+
       '</div>';
  });
  document.getElementById('platGrid').innerHTML=h;
}

// ════ MAIN APP ════
var App={
  el:null,src:'dramabox',tab:'foryou',pg:1,sort:1,
  qry:'',chaps:[],batch:[],curD:null,sTimer:null,
  currentList:[],hasMoreData:true,isLoading:false,
  viewMode:'list',lastSearchQuery:'',
  tk:null,tkCache:{},tkCD:false,tkBound:false,
  _curView:'home',

  init:function(){
    this.el=document.getElementById('root');
    this._bindSearch();this._buildNav();this.switchTab('foryou');
    buildPlatGrid(this.src);
  },

  openPlatModal:function(){document.getElementById('platModalBg').classList.add('open')},
  closePlatModal:function(){document.getElementById('platModalBg').classList.remove('open')},
  _closePlatModalBg:function(e){if(e.target===document.getElementById('platModalBg'))this.closePlatModal()},

  setSource:function(s){
    if(this.src===s){this.closePlatModal();return}
    this.src=s;this.tab=TABS[s][0].id;this.pg=1;this.currentList=[];this.hasMoreData=true;
    document.getElementById('platBtnName').textContent=PLAT_NAMES[s]||s;
    buildPlatGrid(s);this.closePlatModal();this._buildNav();this.switchTab(this.tab);
  },

  _buildNav:function(){
    var self=this,tabs=TABS[this.src];
    document.getElementById('navDesktop').innerHTML=tabs.map(function(t){return'<button class="nb'+(t.id===self.tab?' on':'')+'" data-t="'+t.id+'" onclick="App.switchTab(\''+t.id+'\')"><i class="fas '+t.icon+'"></i> '+t.label+'</button>'}).join('');
    var loginIcon=FB._user&&!FB._user.isAnonymous?'<i class="fas fa-user-circle"></i>':'<i class="fab fa-google"></i>';
    var loginLabel=FB._user&&!FB._user.isAnonymous?'Profil':'Masuk';
    document.getElementById('navMobile').innerHTML=tabs.map(function(t){return'<button class="mb'+(t.id===self.tab?' on':'')+'" data-t="'+t.id+'" onclick="App.switchTab(\''+t.id+'\')"><i class="fas '+t.icon+'"></i>'+t.label+'</button>'}).join('')+
      '<button class="mb'+(self._curView==='watchlist'?' on':'')+'" onclick="App.openWatchlist()"><i class="fas fa-bookmark"></i>Favorit</button>'+
      '<button class="mb premium-tab'+(self._curView==='premium'?' on':'')+'" onclick="App.openPremium()"><i class="fas fa-crown"></i>Premium</button>'+
      '<button class="mb" onclick="document.getElementById(\'qInp\').focus()"><i class="fas fa-search"></i>Cari</button>'+
      '<button class="mb" onclick="FB._user&&!FB._user.isAnonymous?Auth.toggleMenu():Auth.openModal()">'+loginIcon+loginLabel+'</button>';
  },

  _bindSearch:function(){
    var self=this,inp=document.getElementById('qInp'),box=document.getElementById('sugBox');
    inp.addEventListener('input',function(){
      clearTimeout(self.sTimer);var q=inp.value.trim();
      if(q.length<2){box.classList.remove('show');return}
      self.sTimer=setTimeout(function(){
        var prom;
        if(self.src==='freereels')prom=FR.suggest(q);
        else if(self.src==='melolo')prom=ML.search(q,1);
        else if(self.src==='goodshort')prom=GS.search(q,1);
        else if(self.src==='dramawave')prom=DW.keywords(q);
        else if(self.src==='shortmax')prom=SM.search(q,1);
        else if(self.src==='netshort')prom=NS.hint(q);
        else if(self.src==='dramabite')prom=DB2.search(q,1);
        else if(self.src==='flextv')prom=FX.search(q,1);
        else prom=DB.suggest(q);
        prom.then(function(res){
          var list=self.src==='flextv'?fxToList(res):toList(res);
          if(!list.length){box.classList.remove('show');return}
          var h='';
          list.slice(0,6).forEach(function(it){
            if(typeof it==='string'){h+='<div class="sugi" onclick="App._sugPick(\''+esc(it).replace(/'/g,"\\'")+'\')">'+'<i class="fas fa-search"></i><span>'+esc(it)+'</span></div>';return}
            var nd=normD(it);if(nd)h+='<div class="sugi" onclick="App.openDetail(getD(\''+storeD(nd)+'\'))"><i class="fas fa-film"></i><span>'+esc(nd.name)+'</span></div>';
          });
          if(h){box.innerHTML=h;box.classList.add('show')}else box.classList.remove('show');
        }).catch(function(){box.classList.remove('show')});
      },400);
    });
    inp.addEventListener('keydown',function(e){if(e.key==='Enter'){e.preventDefault();self.doSearch()}});
    document.addEventListener('click',function(e){if(!e.target.closest('.swrap'))box.classList.remove('show')});
  },
  _sugPick:function(q){document.getElementById('sugBox').classList.remove('show');document.getElementById('qInp').value=q;this.doSearch()},
  doSearch:function(){
    var q=document.getElementById('qInp').value.trim();if(!q)return;
    document.getElementById('sugBox').classList.remove('show');
    this.qry=q;this.lastSearchQuery=q;this.currentList=[];this.pg=1;this.hasMoreData=true;this._search(q,1,false);
  },
  _search:function(q,p,append){
    var self=this;this._setNav(null);if(!append)this._loading();
    var prom;
    if(self.src==='freereels')prom=FR.search(q,p);
    else if(self.src==='melolo')prom=ML.search(q,p);
    else if(self.src==='goodshort')prom=GS.search(q,p);
    else if(self.src==='dramawave')prom=DW.search(q,p);
    else if(self.src==='shortmax')prom=SM.search(q,p);
    else if(self.src==='netshort')prom=NS.search(q,p);
    else if(self.src==='dramabite')prom=DB2.search(q,p);
    else if(self.src==='flextv')prom=FX.search(q,p);
    else prom=DB.search(q,p);
    prom.then(function(res){
      var list=(self.src==='flextv'?fxToList(res):toList(res)).map(normD).filter(Boolean);
      self.hasMoreData=list.length>0?hasMore(res,list,self.src):false;
      if(append)self.currentList=self.currentList.concat(list);else self.currentList=list;
      self.pg=p;
      var h='<button class="back" onclick="App.goToList()"><i class="fas fa-arrow-left"></i> Kembali</button>'+self._srcBadge();
      h+='<div class="stitle"><i class="fas fa-search"></i> Hasil: "'+esc(q)+'" ('+self.currentList.length+')</div>';
      if(!self.currentList.length)h+='<div class="empty"><i class="fas fa-film"></i><p>Tidak ditemukan</p></div>';
      else{h+=self._grid(self.currentList);h+=self._lmBtn('search',q)}
      self.el.innerHTML=h;self.isLoading=false;
    }).catch(function(){self._error('Gagal mencari',function(){self._search(q,p,false)})});
  },

  switchTab:function(tab){this._curView='home';this.tab=tab;this.pg=1;this.currentList=[];this.hasMoreData=true;this._setNav(tab);this._loadTab(tab,1,false)},
  _setNav:function(tab){document.querySelectorAll('.nb,.mb').forEach(function(el){el.classList.toggle('on',el.getAttribute('data-t')===tab)})},

  _loadTab:function(tab,p,append){
    var self=this;this.pg=p;if(!append)this._loading();
    var prom;
    if(self.src==='dramabox'){prom=tab==='foryou'?DB.foryou(p):tab==='new'?DB.newest(p):tab==='rank'?DB.rank(p):tab==='classify'?DB.classify(p,self.sort):DB.foryou(p)}
    else if(self.src==='freereels'){
      if(tab==='foryou')prom=FR.foryou();else if(tab==='popular')prom=FR.popular(p);else if(tab==='new')prom=FR.newest(p);else if(tab==='anime')prom=FR.anime(p);else if(tab==='dubbing')prom=FR.dubbing(p);else if(tab==='coming-soon')prom=FR.comingSoon();else prom=FR.foryou();
    }else if(self.src==='melolo'){prom=tab==='home'?ML.home(p):tab==='populer'?ML.populer(p):ML.newest(p)}
    else if(self.src==='goodshort'){prom=GS.home(p,12)}
    else if(self.src==='dramawave'){prom=DW.popular(p)}
    else if(self.src==='shortmax'){
      if(tab==='foryou')prom=SM.foryou(p);else if(tab==='recommend')prom=SM.recommend(p);else if(tab==='new')prom=SM.newest(p);else if(tab==='ranked')prom=SM.ranked(p);else if(tab==='romance')prom=SM.romance(p);else if(tab==='epic')prom=SM.epic(p);else if(tab==='war')prom=SM.war(p);else if(tab==='vip')prom=SM.vip(p);else prom=SM.foryou(p);
    }else if(self.src==='netshort'){
      if(tab==='feed')prom=NS.feed(p);else if(tab==='explore')prom=NS.explore(p);else if(tab==='new')prom=NS.newest(p);else if(tab==='dubbing')prom=NS.dubbing(p);else if(tab==='vip')prom=NS.vip(p);else prom=NS.feed(p);
    }else if(self.src==='dramabite'){
      if(tab==='foryou')prom=DB2.foryou(p);else if(tab==='hot')prom=DB2.hot(p);else if(tab==='recommend')prom=DB2.recommend(p);else prom=DB2.dramas(p);
    }else if(self.src==='flextv'){prom=tab==='popular'?FX.popular(p):FX.newest(p)}

    var processResult=function(res){
      var list;
      if(self.src==='dramabite')list=db2ToList(res).map(normD).filter(Boolean);
      else if(self.src==='flextv')list=fxToList(res).map(normD).filter(Boolean);
      else list=toList(res).map(normD).filter(Boolean);
      self.hasMoreData=list.length>0?hasMore(res,list,self.src):false;
      if(append){var ids={};self.currentList.forEach(function(d){ids[d.id]=true});var ni=list.filter(function(d){return!ids[d.id]});if(ni.length===0)self.hasMoreData=false;else self.currentList=self.currentList.concat(ni)}
      else{self.currentList=list}
      self._renderList();self.isLoading=false;
    };
    prom.then(processResult).catch(function(e){console.error(e);self._error('Gagal memuat',function(){self._loadTab(tab,p,false)})});
  },

  _renderList:function(){
    var self=this;self._setNav(self.tab);
    var ic={};TABS[self.src].forEach(function(t){ic[t.id]=t});
    var info=ic[self.tab]||{icon:'fa-film',label:'Drama'};
    var h=self._srcBadge();
    var firstTab=TABS[self.src][0].id;
    if(self.tab===firstTab){h+=self._cwSection()}
    h+='<div id="rotBannerSlot"></div>';
    h+='<div class="stitle"><i class="fas '+info.icon+'"></i> '+info.label+' ('+self.currentList.length+')</div>';
    if(self.src==='dramabox'&&self.tab==='classify')h+=self._dbSortBar();
    if(!self.currentList.length)h+='<div class="empty"><i class="fas fa-film"></i><p>Belum ada drama</p></div>';
    else{h+=self._grid(self.currentList);h+=self._lmBtn('tab',self.tab)}
    self.el.innerHTML=h;
    setTimeout(function(){RotBanner.render('rotBannerSlot')},50);
  },

  _cwSection:function(){
    var list=Store.cwGet();if(!list.length)return'';
    var h='<div class="cw-section"><div class="cw-header"><div class="cw-title"><i class="fas fa-history"></i> Lanjut Nonton</div><button class="cw-clear" onclick="App._cwClearAll()">Hapus Semua</button></div><div class="cw-scroll">';
    list.forEach(function(item){
      var pct=Math.round((item.progress||0)*100);
      h+='<div class="cw-card" onclick="App._cwResume(\''+esc(item.id)+'\',\''+esc(item.src)+'\','+item.ep+')">'+
         '<div class="cw-thumb">'+(item.img?'<img src="'+esc(item.img)+'" loading="lazy">':'')+'<div class="cw-play-icon"><i class="fas fa-play"></i></div>'+
         '<div class="cw-prog-bar"><div class="cw-prog-fill" style="width:'+pct+'%"></div></div></div>'+
         '<div class="cw-info"><div class="cw-name">'+esc(item.name)+'</div><div class="cw-ep">Ep '+item.ep+' &middot; '+(PLAT_NAMES[item.src]||item.src)+'</div></div>'+
         '<button class="cw-del" onclick="event.stopPropagation();App._cwRemoveItem(\''+esc(item.id)+'\',\''+esc(item.src)+'\')"><i class="fas fa-times"></i></button>'+
         '</div>';
    });
    h+='</div></div>';return h;
  },
  _cwClearAll:function(){Store.cwClear();this._renderList();showToast('Riwayat dihapus')},
  _cwRemoveItem:function(id,src){
    Store.cwRemove(id,src);var sec=document.querySelector('.cw-section');
    if(sec){var list=Store.cwGet();if(!list.length){sec.remove();return}var tmp=document.createElement('div');tmp.innerHTML=this._cwSection();sec.replaceWith(tmp.firstChild)}
  },
  _cwResume:function(id,src){
    var cwItem=Store.cwFind(id,src);if(!cwItem)return;
    if(this.src!==src){this.setSource(src)}
    var d=getD('D_'+id);
    if(d){this.openDetail(d)}else{var stub={id:id,name:cwItem.name,img:cwItem.img,desc:'',eps:cwItem.total||0,tag:'',score:0,views:0,raw:{}};storeD(stub);this.openDetail(stub)}
  },
  _cwSave:function(d,ep,total,progress){Store.cwSave({id:d.id,name:d.name,img:d.img,src:this.src,ep:ep,total:total,progress:progress,ts:Date.now()})},

  toggleWatchlist:function(d,btn){
    var item={id:d.id,name:d.name,img:d.img,src:this.src,eps:d.eps,score:d.score,tag:d.tag,ts:Date.now()};
    var added=Store.wlToggle(item);
    if(btn){btn.classList.toggle('saved',added);btn.innerHTML=added?'<i class="fas fa-bookmark"></i>':'<i class="far fa-bookmark"></i>'}
    showToast(added?'Ditambah ke Favorit':'Dihapus dari Favorit');
  },
  openWatchlist:function(){
    this._curView='watchlist';this._setNav(null);this._buildNav();
    var list=Store.wlGet();
    var h='<div class="stitle"><i class="fas fa-bookmark"></i> Favorit ('+list.length+')</div>';
    if(!list.length){h+='<div class="wl-empty"><i class="fas fa-bookmark" style="font-size:2rem;display:block;margin-bottom:12px"></i><p style="font-size:.85rem;color:var(--text2)">Belum ada drama favorit</p><small>Klik ikon bookmark pada drama untuk menyimpannya</small></div>'}
    else{
      h+='<div class="grid">';
      list.forEach(function(item){
        var k='D_'+item.id;if(!getD(k)){var stub={id:item.id,name:item.name,img:item.img,desc:'',eps:item.eps||0,tag:item.tag||'',score:item.score||0,views:0,raw:{}};storeD(stub)}
        h+='<div class="card" onclick="App._wlOpen(\''+esc(item.id)+'\',\''+esc(item.src)+'\')">'+
           '<div class="cimg">'+(item.img?'<img src="'+esc(item.img)+'" loading="lazy">':'<div class="noimg"><i class="fas fa-film"></i></div>')+
           '<div class="chov"><div class="cplay"><i class="fas fa-play"></i></div></div>'+
           (item.eps?'<div class="cbadge">'+item.eps+' Ep</div>':'')+
           '<div class="cplatbadge"><img src="'+(PLAT_IMGS[item.src]||'')+'" onerror="this.parentElement.style.display=\'none\'"></div>'+
           '</div><div class="cbody"><div class="cname">'+esc(item.name)+'</div><div class="csub"><span style="opacity:.6;font-size:.6rem">'+(PLAT_NAMES[item.src]||item.src)+'</span></div></div>'+
           '<button class="card-fav-btn saved" onclick="event.stopPropagation();App._wlRemoveRefresh(\''+esc(item.id)+'\',\''+esc(item.src)+'\')"><i class="fas fa-bookmark"></i></button>'+
           '</div>';
      });
      h+='</div>';
    }
    this.el.innerHTML=h;
  },
  _wlOpen:function(id,src){if(this.src!==src)this.setSource(src);var d=getD('D_'+id);if(d)this.openDetail(d)},
  _wlRemoveRefresh:function(id,src){Store.wlRemove(id,src);this.openWatchlist();showToast('Dihapus dari Favorit')},

  _dbSortBar:function(){
    var s=this,sorts=[{id:1,label:'Terpopuler'},{id:2,label:'Terbaru'},{id:3,label:'Rating'}];
    var h='<div style="display:flex;gap:5px;margin-bottom:16px">';
    sorts.forEach(function(x){h+='<button class="fbtn '+(s.sort===x.id?'on':'')+'" onclick="App.setSort('+x.id+')">'+x.label+'</button>'});
    return h+'</div>';
  },
  setSort:function(s){this.sort=s;this.currentList=[];this.pg=1;this.hasMoreData=true;this._loadTab('classify',1,false)},

  _srcBadge:function(){
    var m={dramabox:'<div class="src-badge db"><i class="fas fa-play-circle"></i> DramaBox</div>',freereels:'<div class="src-badge fr"><i class="fas fa-film"></i> FreeReels</div>',melolo:'<div class="src-badge ml"><i class="fas fa-tv"></i> MeloLo</div>',goodshort:'<div class="src-badge gs"><i class="fas fa-star"></i> GoodShort</div>',dramawave:'<div class="src-badge dw"><i class="fas fa-water"></i> DramaWave</div>',shortmax:'<div class="src-badge sm"><i class="fas fa-bolt"></i> ShortMax</div>',netshort:'<div class="src-badge ns"><i class="fas fa-play"></i> NetShort</div>',dramabite:'<div class="src-badge db2"><i class="fas fa-play-circle"></i> DramaBite</div>',flextv:'<div class="src-badge fx"><i class="fas fa-tv"></i> FlexTV</div>'};
    return m[this.src]||m.dramabox;
  },

  _grid:function(list){
    var self=this,h='<div class="grid">';var pimg=PLAT_IMGS[self.src]||'';
    list.forEach(function(d){
      var k=storeD(d);var isSaved=Store.wlHas(d.id,self.src);
      h+='<div class="card" onclick="App.openDetail(getD(\''+k+'\'))"><div class="cimg">';
      h+=d.img?'<img src="'+esc(d.img)+'" loading="lazy" onerror="this.onerror=null;this.parentElement.innerHTML=\'<div class=\\\'noimg\\\'><i class=\\\'fas fa-film\\\'></i></div>\'">':'<div class="noimg"><i class="fas fa-film"></i></div>';
      h+='<div class="chov"><div class="cplay"><i class="fas fa-play"></i></div></div>';
      if(d.eps)h+='<div class="cbadge">'+d.eps+' Ep</div>';
      if(d.score)h+='<div class="cscore"><i class="fas fa-star"></i> '+d.score+'</div>';
      if(pimg)h+='<div class="cplatbadge"><img src="'+pimg+'" onerror="this.parentElement.style.display=\'none\'"></div>';
      h+='</div>';
      h+='<button class="card-fav-btn'+(isSaved?' saved':'')+'" onclick="event.stopPropagation();App.toggleWatchlist(getD(\''+k+'\'),this)">'+(isSaved?'<i class="fas fa-bookmark"></i>':'<i class="far fa-bookmark"></i>')+'</button>';
      h+='<div class="cbody"><div class="cname">'+esc(d.name)+'</div><div class="csub">';
      if(d.tag)h+='<span>'+esc(String(d.tag).split(',')[0].trim())+'</span>';
      if(d.views)h+='<span><i class="fas fa-eye" style="font-size:.55rem;opacity:.4"></i> '+fmtV(d.views)+'</span>';
      h+='</div></div></div>';
    });
    return h+'</div>';
  },

  _lmBtn:function(t,a){
    if(!this.hasMoreData)return'<div class="end-msg">Semua drama sudah ditampilkan</div>';
    var ea=esc(String(a)).replace(/'/g,"\\'");
    return'<div class="load-more"><button class="lmbtn" id="loadMoreBtn" onclick="App.loadMore(\''+t+'\',\''+ea+'\')"><span class="spinner"></span><span class="lmtext"><i class="fas fa-plus"></i> Muat Lebih Banyak</span></button></div>';
  },
  loadMore:function(t,a){
    if(this.isLoading||!this.hasMoreData)return;
    this.isLoading=true;var b=document.getElementById('loadMoreBtn');if(b)b.classList.add('loading');
    var np=this.pg+1;if(t==='tab')this._loadTab(a,np,true);else this._search(a,np,true);
  },

  openDetail:function(d){
    if(!d){this._error('Drama tidak ditemukan',function(){App.goToList()});return}
    this.curD=d;this.viewMode='detail';this._loading();window.scrollTo({top:0,behavior:'smooth'});
    if(this.src==='freereels')this._openFR(d);else if(this.src==='melolo')this._openML(d);
    else if(this.src==='goodshort')this._openGS(d);else if(this.src==='dramawave')this._openDW(d);
    else if(this.src==='shortmax')this._openSM(d);else if(this.src==='netshort')this._openNS(d);
    else if(this.src==='dramabite')this._openDB2(d);else if(this.src==='flextv')this._openFX(d);
    else this._openDB(d);
  },

  _openDB:function(d){var self=this;Promise.allSettled([DB.chapters(d.id),DB.batch(d.id)]).then(function(r){self.chaps=r[0].status==='fulfilled'?toList(r[0].value).map(normChap):[];self.batch=r[1].status==='fulfilled'?toList(r[1].value):[];self._renderDetail(d,self.chaps)})},
  _openFR:function(d){
    var self=this;Promise.allSettled([FR.detail(d.id),FR.episodes(d.id)]).then(function(r){
      if(r[0].status==='fulfilled'){var dd=r[0].value.data||r[0].value;if(Array.isArray(dd))dd=dd[0];if(dd&&typeof dd==='object'){d.id=dd.id||dd.drama_id||d.id;d.name=dd.title||dd.name||d.name;var nc=getCover(dd);if(nc)d.img=nc;d.desc=dd.description||dd.introduction||dd.desc||d.desc;d.eps=parseInt(dd.episode_count||dd.episodeCount||0)||d.eps;d.tag=dd.tags||dd.label||d.tag;d.score=dd.score||dd.rating||d.score}}
      var epList=[];if(r[1].status==='fulfilled'){var eres=r[1].value;var raw=eres.data||eres;if(Array.isArray(raw))epList=raw;else if(raw&&Array.isArray(raw.list))epList=raw.list;else if(raw&&Array.isArray(raw.episodes))epList=raw.episodes;else epList=toList(eres)}
      if(epList.length>0){self.chaps=epList.map(function(ep,i){var num=parseInt(ep.episode||ep.ep||ep.number||ep.index||ep.no||(i+1))||(i+1);return{num:num,title:ep.title||ep.name||('Episode '+num),streamId:String(ep.id||ep.episodeId||ep.episode||num)}});d.eps=self.chaps.length}
      else if(d.eps>0){self.chaps=[];for(var i=1;i<=d.eps;i++)self.chaps.push({num:i,title:'Episode '+i,streamId:String(i)})}
      else self.chaps=[];
      storeD(d);self._renderDetail(d,self.chaps);
    }).catch(function(){if(d.eps>0){self.chaps=[];for(var i=1;i<=d.eps;i++)self.chaps.push({num:i,title:'Episode '+i,streamId:String(i)})}else self.chaps=[];self._renderDetail(d,self.chaps)});
  },
  _openML:function(d){
    var self=this;ML.detail(d.id).then(function(res){
      var dd=res.data||res;if(Array.isArray(dd))dd=dd[0];
      if(dd&&typeof dd==='object'){d.id=dd.drama_id||dd.id||d.id;d.name=dd.drama_name||dd.name||dd.title||d.name;var nc=getCover(dd);if(nc)d.img=nc;d.desc=dd.description||dd.desc||d.desc;d.eps=parseInt(dd.episode_count)||d.eps;d.tag=dd.tags||dd.tag||d.tag;d.score=dd.rating||dd.score||d.score;
        var epList=dd.video_list||dd.episodes||dd.episode_list||dd.chapters||null;
        if(epList&&epList.length>0){self.chaps=epList.map(function(ep,i){var num=ep.episode_number||ep.episode||ep.number||ep.index||(i+1);var sid=ep.video_id||ep.id||ep.episode_id||ep.stream_id||ep.item_id||ep._id||'';return{num:parseInt(num)||(i+1),title:ep.title||ep.name||('Episode '+(i+1)),streamId:String(sid)}})}
        else if(d.eps){self.chaps=[];for(var i=1;i<=d.eps;i++)self.chaps.push({num:i,title:'Episode '+i,streamId:''})}
        else self.chaps=[];
      }
      storeD(d);self._renderDetail(d,self.chaps);
    }).catch(function(){if(d.eps){self.chaps=[];for(var i=1;i<=d.eps;i++)self.chaps.push({num:i,title:'Episode '+i,streamId:''})}self._renderDetail(d,self.chaps||[])});
  },
  _openGS:function(d){
    var self=this;Promise.allSettled([GS.book(d.id),GS.chapters(d.id)]).then(function(r){
      if(r[0].status==='fulfilled'){var res=r[0].value;var dd=(res.data&&res.data.book)?res.data.book:(res.data||res);if(dd&&typeof dd==='object'){d.id=dd.bookId||dd.id||d.id;d.name=dd.bookName||dd.name||dd.title||d.name;var nc=dd.cover||dd.bookDetailCover||'';if(nc)d.img=fixImageUrl(nc);d.desc=dd.introduction||dd.description||dd.desc||d.desc;d.tag=dd.tags||dd.label||dd.genre||d.tag;d.score=dd.ratings||dd.score||dd.rating||d.score}}
      var clist=[];if(r[1].status==='fulfilled'){var cres=r[1].value;if(cres.data&&cres.data.list&&Array.isArray(cres.data.list))clist=cres.data.list;else if(cres.data&&Array.isArray(cres.data))clist=cres.data;else if(Array.isArray(cres))clist=cres;else clist=toList(cres)}
      if(clist.length>0){
        self.chaps=clist.map(function(ep,i){
          var num=i+1;var title=ep.chapterName||('Episode '+(i+1));var sid=String(ep.id||ep.chapterId||'');
          var directUrl='';
          if(ep.cdnList&&ep.cdnList.length)directUrl=ep.cdnList[0].videoPath||ep.cdnList[0].url||'';
          if(!directUrl&&ep.multiVideos&&ep.multiVideos.length){for(var mi=0;mi<ep.multiVideos.length;mi++){if(ep.multiVideos[mi].type==='720p'||ep.multiVideos[mi].filePath){directUrl=ep.multiVideos[mi].filePath||ep.multiVideos[mi].url||'';break}}if(!directUrl)directUrl=ep.multiVideos[0].filePath||ep.multiVideos[0].url||''}
          return{num:num,title:title,streamId:sid,directUrl:directUrl};
        });d.eps=self.chaps.length;
      }else if(d.eps>0){self.chaps=[];for(var i=1;i<=d.eps;i++)self.chaps.push({num:i,title:'Episode '+i,streamId:'',directUrl:''})}
      else self.chaps=[];
      storeD(d);self._renderDetail(d,self.chaps);
    }).catch(function(){if(d.eps>0){self.chaps=[];for(var i=1;i<=d.eps;i++)self.chaps.push({num:i,title:'Episode '+i,streamId:'',directUrl:''})}else self.chaps=[];self._renderDetail(d,self.chaps)});
  },
  _openDW:function(d){
    var self=this;DW.detail(d.id).then(function(res){
      var dd=res.data||res;if(Array.isArray(dd))dd=dd[0];
      if(dd&&typeof dd==='object'){d.id=dd.id||dd.dramaId||dd.drama_id||d.id;d.name=dd.title||dd.name||d.name;var nc=getCover(dd)||dd.cover||dd.thumbnail;if(nc)d.img=fixImageUrl(nc);d.desc=dd.description||dd.intro||dd.synopsis||d.desc;d.tag=dd.tags||dd.genres||d.tag;d.score=dd.rating||dd.score||d.score;
        var epList=dd.episodes||dd.episode_list||dd.chapters||null;
        if(epList&&Array.isArray(epList)&&epList.length){self.chaps=epList.map(function(ep,i){var num=parseInt(ep.episode||ep.ep||ep.number||ep.index||ep.no||(i+1))||(i+1);return{num:num,title:ep.title||ep.name||('Episode '+num),streamId:String(ep.id||ep.episodeId||ep.episode||num)}});d.eps=self.chaps.length}
        else{var cnt=parseInt(dd.totalEpisodes||dd.episodeCount||dd.episode_count||0)||0;if(cnt>0){d.eps=cnt;self.chaps=[];for(var i=1;i<=cnt;i++)self.chaps.push({num:i,title:'Episode '+i,streamId:String(i)})}else self.chaps=[]}
      }
      storeD(d);self._renderDetail(d,self.chaps);
    }).catch(function(){if(d.eps>0){self.chaps=[];for(var i=1;i<=d.eps;i++)self.chaps.push({num:i,title:'Episode '+i,streamId:String(i)})}else self.chaps=[];self._renderDetail(d,self.chaps)});
  },
  _openSM:function(d){
    var self=this;var tryIds=[];var seen={};
    function addId(v){if(v===null||v===undefined)return;var s=String(v).trim();if(!s||seen[s])return;seen[s]=1;tryIds.push(s)}
    if(d.raw){var rx=d.raw;[rx.code,rx.id,rx.drama_id,rx.dramaId,rx.bookId,rx.book_id,rx.key,rx.slug].forEach(function(v){addId(v)})}addId(d.id);
    function tryNext(ids){
      if(!ids.length){if(parseInt(d.eps)>0){self.chaps=[];for(var i=1;i<=parseInt(d.eps);i++)self.chaps.push({num:i,title:'Episode '+i,streamId:String(i)})}else self.chaps=[];storeD(d);self._renderDetail(d,self.chaps);return}
      var tid=ids[0];var rest=ids.slice(1);
      SM.detail(tid).then(function(res){
        var isErr=(res&&res.data&&res.data.error)||(res&&res.error)||(res&&res.code&&(res.code===404||res.code===400));
        if(isErr){tryNext(rest);return}
        d.id=tid;var dd=res.data||res;if(Array.isArray(dd))dd=dd[0];
        if(dd&&typeof dd==='object'){d.name=dd.name||dd.title||d.name;var nc=getCover(dd);if(nc)d.img=nc;d.desc=dd.summary||dd.description||d.desc;d.tag=dd.tags||dd.genres||d.tag;d.score=dd.rating||d.score;
          var epList=dd.episode_list||dd.chapters||dd.epList||null;
          if(epList&&Array.isArray(epList)&&epList.length){self.chaps=epList.map(function(ep,i){var num=parseInt(ep.ep||ep.episode||ep.number||(i+1))||(i+1);return{num:num,title:ep.title||ep.name||('Episode '+num),streamId:String(ep.ep||ep.id||ep.episode||num)}});d.eps=self.chaps.length}
          else{var cnt=parseInt(dd.episodes||dd.totalEpisodes||dd.episodeCount||dd.episode_count||0)||parseInt(d.eps)||0;if(cnt>0){d.eps=cnt;self.chaps=[];for(var i=1;i<=cnt;i++)self.chaps.push({num:i,title:'Episode '+i,streamId:String(i)})}else self.chaps=[]}
        }
        storeD(d);self._renderDetail(d,self.chaps);
      }).catch(function(){tryNext(rest)});
    }tryNext(tryIds);
  },
  _openNS:function(d){
    var self=this;Promise.allSettled([NS.detail(d.id),NS.episodes(d.id)]).then(function(r){
      if(r[0].status==='fulfilled'){var dd=r[0].value.data||r[0].value;if(Array.isArray(dd))dd=dd[0];if(dd&&typeof dd==='object'){d.id=String(dd.id||d.id);d.name=dd.title||dd.name||d.name;var nc=getCover(dd);if(nc)d.img=nc;d.desc=dd.description||dd.summary||d.desc;d.tag=dd.tags||dd.genres||d.tag;d.score=dd.rating||dd.score||d.score}}
      var epList=[];if(r[1].status==='fulfilled'){var raw=r[1].value.data||r[1].value;if(Array.isArray(raw))epList=raw;else if(raw&&Array.isArray(raw.list))epList=raw.list;else epList=toList(r[1].value)}
      if(epList.length>0){self.chaps=epList.map(function(ep,i){var num=parseInt(ep.episode||ep.ep||ep.number||(i+1))||(i+1);return{num:num,title:ep.title||ep.name||('Episode '+num),streamId:String(ep.id||ep.episodeId||num)}});d.eps=self.chaps.length}
      else if(parseInt(d.eps)>0){self.chaps=[];for(var i=1;i<=parseInt(d.eps);i++)self.chaps.push({num:i,title:'Episode '+i,streamId:String(i)})}
      else self.chaps=[];
      storeD(d);self._renderDetail(d,self.chaps);
    }).catch(function(){if(parseInt(d.eps)>0){self.chaps=[];for(var i=1;i<=parseInt(d.eps);i++)self.chaps.push({num:i,title:'Episode '+i,streamId:String(i)})}else self.chaps=[];self._renderDetail(d,self.chaps)});
  },
  _openDB2:function(d){
    var self=this;DB2.detail(d.id).then(function(res){
      var dd=res.data||res;if(Array.isArray(dd))dd=dd[0];
      if(dd&&typeof dd==='object'){d.id=String(dd.id||d.id);d.name=dd.title||dd.name||d.name;var nc=getCover(dd);if(nc)d.img=nc;d.desc=dd.description||dd.summary||d.desc;d.tag=dd.tags||dd.genres||d.tag;d.score=dd.rating||dd.score||d.score;
        var epList=dd.episodes||dd.episode_list||dd.chapters||null;
        if(epList&&Array.isArray(epList)&&epList.length){self.chaps=epList.map(function(ep,i){var num=parseInt(ep.episode||ep.ep||ep.number||(i+1))||(i+1);return{num:num,title:ep.title||ep.name||('Episode '+num),streamId:String(ep.id||ep.episodeId||ep.episode||num)}});d.eps=self.chaps.length}
        else{var cnt=parseInt(dd.totalEpisodes||dd.episodeCount||dd.total||0)||0;if(cnt>0){d.eps=cnt;self.chaps=[];for(var i=1;i<=cnt;i++)self.chaps.push({num:i,title:'Episode '+i,streamId:String(i)})}else self.chaps=[]}
      }
      storeD(d);self._renderDetail(d,self.chaps);
    }).catch(function(){if(parseInt(d.eps)>0){self.chaps=[];for(var i=1;i<=parseInt(d.eps);i++)self.chaps.push({num:i,title:'Episode '+i,streamId:String(i)})}else self.chaps=[];self._renderDetail(d,self.chaps)});
  },
  _openFX:function(d){
    var self=this;Promise.allSettled([FX.detail(d.id),FX.episodes(d.id)]).then(function(r){
      if(r[0].status==='fulfilled'){var dd=r[0].value.data||r[0].value;if(Array.isArray(dd))dd=dd[0];if(dd&&typeof dd==='object'){d.id=String(dd.id||dd.seriesId||dd.series_id||d.id);d.name=dd.title||dd.name||dd.seriesName||d.name;var nc=getCover(dd);if(nc)d.img=nc;d.desc=dd.description||dd.summary||d.desc;d.tag=dd.tags||dd.genres||d.tag;d.score=dd.rating||dd.score||d.score}}
      var epList=[];if(r[1].status==='fulfilled'){var raw=r[1].value.data||r[1].value;if(Array.isArray(raw))epList=raw;else if(raw&&Array.isArray(raw.list))epList=raw.list;else if(raw&&Array.isArray(raw.episodes))epList=raw.episodes;else epList=toList(r[1].value)}
      if(epList.length>0){self.chaps=epList.map(function(ep,i){var num=parseInt(ep.episode||ep.ep||ep.number||ep.index||(i+1))||(i+1);return{num:num,title:ep.title||ep.name||('Episode '+num),streamId:String(ep.id||ep.episodeId||ep.episode||num)}});d.eps=self.chaps.length}
      else if(parseInt(d.eps)>0){self.chaps=[];for(var i=1;i<=parseInt(d.eps);i++)self.chaps.push({num:i,title:'Episode '+i,streamId:String(i)})}
      else self.chaps=[];
      storeD(d);self._renderDetail(d,self.chaps);
    }).catch(function(){if(parseInt(d.eps)>0){self.chaps=[];for(var i=1;i<=parseInt(d.eps);i++)self.chaps.push({num:i,title:'Episode '+i,streamId:String(i)})}else self.chaps=[];self._renderDetail(d,self.chaps)});
  },

  _renderDetail:function(d,chaps){
    var self=this;var k=storeD(d);var ts=Array.isArray(d.tag)?d.tag.join(','):(d.tag||'');var isSaved=Store.wlHas(d.id,this.src);var cwItem=Store.cwFind(d.id,this.src);
    var h='<button class="back" onclick="App.goToList()"><i class="fas fa-arrow-left"></i> Kembali</button>'+this._srcBadge()+'<div class="dhero">';
    if(d.img)h+='<div class="dbg" style="background-image:url(\''+esc(d.img)+'\')"></div>';
    h+='<div class="din"><div class="dposter">'+(d.img?'<img src="'+esc(d.img)+'" onerror="this.style.display=\'none\'">':'<div class="noimg" style="height:100%"><i class="fas fa-film"></i></div>')+'</div>';
    h+='<div class="dinfo"><h1 class="dttl">'+esc(d.name)+'</h1><div class="dtags">';
    if(ts)ts.split(/[,|]/).forEach(function(t){t=t.trim();if(t)h+='<span class="dtag">'+esc(t)+'</span>'});
    h+='</div><div class="dsts">';
    if(d.score)h+='<div class="ds"><i class="fas fa-star"></i> '+d.score+'</div>';
    if(d.eps||chaps.length)h+='<div class="ds"><i class="fas fa-film"></i> '+(chaps.length||d.eps)+' Ep</div>';
    if(d.views)h+='<div class="ds"><i class="fas fa-eye"></i> '+fmtV(d.views)+'</div>';
    h+='</div>';
    if(d.desc)h+='<p class="ddesc" id="ddd">'+esc(d.desc)+'</p><button class="bmore" onclick="document.getElementById(\'ddd\').classList.toggle(\'open\')">Selengkapnya \u25bc</button>';
    h+='<div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">';
    var startEp=cwItem?cwItem.ep:1;
    h+='<button class="bwatch" onclick="App.play(\''+k+'\','+startEp+')"><i class="fas fa-play"></i> '+(cwItem?'Lanjut Ep '+startEp:'Tonton Ep 1')+'</button>';
    h+='<button class="bfav'+(isSaved?' saved':'')+'" id="detailFavBtn" onclick="App._detailToggleWl(\''+k+'\',this)">'+(isSaved?'<i class="fas fa-bookmark"></i> Tersimpan':'<i class="far fa-bookmark"></i> Simpan')+'</button>';
    h+='</div></div></div></div>';
    if(cwItem&&cwItem.progress>0.02){var pct=Math.round(cwItem.progress*100);h+='<div class="cw-resume-banner" onclick="App.play(\''+k+'\','+cwItem.ep+')"><div class="cw-resume-icon"><i class="fas fa-play"></i></div><div class="cw-resume-text"><strong>Lanjut nonton Episode '+cwItem.ep+'</strong><span>Kamu sudah menonton '+pct+'%</span><div class="cw-resume-prog"><div class="cw-resume-prog-fill" style="width:'+pct+'%"></div></div></div><i class="fas fa-chevron-right" style="color:var(--text3)"></i></div>'}
    h+='<div style="margin-top:18px"><div class="stitle"><i class="fas fa-list"></i> Episode ('+(chaps.length||d.eps||0)+')</div><div class="epgrid">';
    var lastEp=cwItem?cwItem.ep:null;
    if(chaps.length)chaps.forEach(function(ch){h+='<button class="epc'+(lastEp&&ch.num==lastEp?' cw-ep-active':'')+'" onclick="App.play(\''+k+'\','+ch.num+')">Ep '+ch.num+'</button>'});
    else if(d.eps){for(var i=1;i<=d.eps;i++)h+='<button class="epc'+(lastEp&&i==lastEp?' cw-ep-active':'')+'" onclick="App.play(\''+k+'\','+i+')">Ep '+i+'</button>'}
    else h+='<div class="empty"><p>Episode tidak tersedia</p></div>';
    h+='</div></div>';this.el.innerHTML=h;
  },

  _detailToggleWl:function(dKey,btn){
    var d=getD(dKey);if(!d)return;var item={id:d.id,name:d.name,img:d.img,src:this.src,eps:d.eps,score:d.score,tag:d.tag,ts:Date.now()};
    var added=Store.wlToggle(item);btn.className='bfav'+(added?' saved':'');btn.innerHTML=added?'<i class="fas fa-bookmark"></i> Tersimpan':'<i class="far fa-bookmark"></i> Simpan';
    showToast(added?'Ditambah ke Favorit':'Dihapus dari Favorit');
  },

  play:function(dKey,ep){
    var d=getD(dKey);if(!d)return;
    if(!FB._user||FB._user.isAnonymous){Auth._pendingPlay={dKey:dKey,ep:ep};Auth.openModal(true);return;}
    this.curD=d;var total=this.chaps.length||d.eps||0;
    this.tk={dKey:dKey,ep:ep,total:total,d:d};this.tkCache={};this._tkRender();this._tkLoadEp(ep,'none');
  },
  _gsUrlCache:{},  // Persistent GoodShort URL cache (tidak di-reset saat ganti ep)
  _tkRender:function(){
    var s=this.tk,d=s.d;var isSaved=Store.wlHas(d.id,this.src);
    var h='<div class="tk-vc" id="tkVC"><video id="tkVid" playsinline webkit-playsinline></video><div class="tk-grad-top"></div><div class="tk-grad-bot"></div>'+
        '<div class="tk-load" id="tkLoad"><div class="sp"></div></div>'+
        '<div class="tk-pp" id="tkPP"><i class="fas fa-play"></i></div>'+
        '<div class="tk-seek" id="tkSeek"><div class="tk-seek-ind" id="tkSeekInd"><i class="fas fa-forward"></i><span id="tkSeekTxt">+10s</span></div></div>'+
        '<div class="tk-err" id="tkErr"><i class="fas fa-exclamation-circle"></i><p>Video tidak tersedia</p><button onclick="App._tkRetry()"><i class="fas fa-redo"></i> Coba Lagi</button></div>'+
        '<button class="tk-close" onclick="App.tkClose()"><i class="fas fa-arrow-left"></i></button>'+
        '<div class="tk-epc" id="tkEpC">Ep '+s.ep+' / '+s.total+'</div>'+
        '<div class="tk-side">'+
          '<button class="tk-sb'+(isSaved?' wl-active':'')+'" id="tkWlBtn" onclick="App._tkToggleWl()"><i class="fas fa-bookmark"></i>Favorit</button>'+
          '<button class="tk-sb" onclick="App.tkToggleEps()"><i class="fas fa-list-ol"></i>Episode</button>'+
          '<button class="tk-sb" onclick="App._tkSeek(10)"><i class="fas fa-forward"></i>+10 dtk</button>'+
          '<button class="tk-sb" onclick="App._tkSeek(-10)"><i class="fas fa-backward"></i>-10 dtk</button>'+
          '<button class="tk-sb" onclick="copyUrl()"><i class="fas fa-link"></i>Link</button>'+
        '</div>'+
        '<div class="tk-bottom"><div class="tk-dname">'+esc(d.name)+'</div><div class="tk-epsub" id="tkEpSub">Episode '+s.ep+'</div><div class="tk-hint"><i class="fas fa-chevron-up"></i> Geser untuk ganti episode</div></div>'+
        '<div class="tk-prog"><div class="tk-prog-bar" id="tkProg"></div></div>'+
        '<div class="tk-overlay" id="tkOverlay" onclick="App.tkToggleEps()"></div>'+
        '<div class="tk-epanel" id="tkEpanel"><div class="tk-eph"><span><i class="fas fa-list"></i> Episode ('+s.total+')</span><button onclick="App.tkToggleEps()"><i class="fas fa-times"></i></button></div><div class="tk-epl" id="tkEpList">'+this._tkEpBtns(s.ep)+'</div></div>'+
        '</div>';
    var el=document.getElementById('tkPlayer');el.innerHTML=h;el.classList.add('open');document.body.classList.add('noscroll');this._tkBindEvents();
  },
  _tkToggleWl:function(){var d=this.tk&&this.tk.d;if(!d)return;var item={id:d.id,name:d.name,img:d.img,src:this.src,eps:d.eps,score:d.score,tag:d.tag,ts:Date.now()};var added=Store.wlToggle(item);var btn=document.getElementById('tkWlBtn');if(btn)btn.classList.toggle('wl-active',added);showToast(added?'Ditambah ke Favorit':'Dihapus dari Favorit')},
  _tkEpBtns:function(cur){var h='',chaps=this.chaps,total=this.tk.total;if(chaps.length){chaps.forEach(function(ch){h+='<button class="tk-epb'+(ch.num==cur?' on':'')+'" onclick="App._tkGoEp('+ch.num+')">'+ch.num+'</button>'})}else{for(var i=1;i<=total;i++)h+='<button class="tk-epb'+(i==cur?' on':'')+'" onclick="App._tkGoEp('+i+')">'+i+'</button>'}return h},
  _tkBindEvents:function(){
    if(this.tkBound)return;this.tkBound=true;
    var vc=document.getElementById('tkVC'),self=this,sy=0,mv=false;if(!vc)return;
    vc.addEventListener('touchstart',function(e){sy=e.changedTouches[0].screenY;mv=true},{passive:true});
    vc.addEventListener('touchend',function(e){if(!mv)return;mv=false;var dy=sy-e.changedTouches[0].screenY;if(dy>70)self._tkNext();else if(dy<-70)self._tkPrev();else if(Math.abs(dy)<10)self._tkTap()},{passive:true});
    vc.addEventListener('wheel',function(e){e.preventDefault();if(self.tkCD)return;self.tkCD=true;if(e.deltaY>30)self._tkNext();else if(e.deltaY<-30)self._tkPrev();setTimeout(function(){self.tkCD=false},800)},{passive:false});
    document.addEventListener('keydown',function(e){var p=document.getElementById('tkPlayer');if(!p||!p.classList.contains('open'))return;if(e.key==='ArrowUp')self._tkPrev();else if(e.key==='ArrowDown')self._tkNext();else if(e.key==='ArrowLeft')self._tkSeek(-10);else if(e.key==='ArrowRight')self._tkSeek(10);else if(e.key===' '){e.preventDefault();self._tkTap()}else if(e.key==='Escape')self.tkClose()});
  },
  _tkSeek:function(sec){var vid=document.getElementById('tkVid');if(!vid||!vid.duration)return;var t=vid.currentTime+sec;if(t<0)t=0;if(t>vid.duration)t=vid.duration;vid.currentTime=t;var ind=document.getElementById('tkSeekInd'),txt=document.getElementById('tkSeekTxt');if(ind&&txt){txt.textContent=(sec>0?'+':'')+sec+'s';ind.querySelector('i').className=sec>0?'fas fa-forward':'fas fa-backward';ind.classList.add('show');setTimeout(function(){ind.classList.remove('show')},600)}},
  _tkRetry:function(){if(this.tk)this._tkLoadEp(this.tk.ep,'none')},

  _tkLoadEp:function(ep,dir){
    var self=this,s=this.tk;if(ep<1||ep>s.total)return;s.ep=ep;
    var epc=document.getElementById('tkEpC');if(epc)epc.textContent='Ep '+ep+' / '+s.total;
    var esub=document.getElementById('tkEpSub');if(esub)esub.textContent='Episode '+ep;
    var epl=document.getElementById('tkEpList');if(epl)epl.innerHTML=this._tkEpBtns(ep);
    this._tkShowLoad(true);this._tkShowErr(false);
    var vid=document.getElementById('tkVid');
    if(vid&&dir!=='none'){vid.className='tk-anim-'+(dir==='up'?'up':'down');setTimeout(function(){vid.className=''},350)}
    if(this.tkCache[ep]){this._tkPlayUrl(this.tkCache[ep]);return}

    if(this.src==='goodshort'){
      var chap=null;for(var ci=0;ci<this.chaps.length;ci++){if(this.chaps[ci].num==ep){chap=this.chaps[ci];break}}
      var gsExtractUrl=function(res){
        // Extract from cdnList or multiVideos first (most reliable)
        if(res.data&&res.data.list&&Array.isArray(res.data.list)){
          var epData=res.data.list[0]||res.data.list.find(function(x){return x.index===(ep-1)||x.chapterName===String(ep)});
          if(epData){
            if(epData.cdnList&&epData.cdnList.length)return epData.cdnList[0].videoPath||'';
            if(epData.multiVideos&&epData.multiVideos.length){for(var i=0;i<epData.multiVideos.length;i++){if(epData.multiVideos[i].type==='720p')return epData.multiVideos[i].filePath||'';}return epData.multiVideos[0].filePath||'';}
            if(epData.cdn)return epData.cdn;
          }
        }
        if(res.cdnList&&res.cdnList.length)return res.cdnList[0].videoPath||'';
        if(res.multiVideos&&res.multiVideos.length){for(var i=0;i<res.multiVideos.length;i++){if(res.multiVideos[i].type==='720p')return res.multiVideos[i].filePath||'';}return res.multiVideos[0].filePath||'';}
        if(res.cdn)return res.cdn;
        var u=res.m3u8||res.url||res.video_url||res.stream_url||'';if(u)return u;
        if(res.data){u=res.data.m3u8||res.data.url||res.data.video_url||extractVideoUrl(res.data)||'';if(u)return u;}
        return extractVideoUrl(res)||'';
      };
      // Always re-fetch chapters to get fresh non-expired URL
      var gsShowErr=function(){self._tkShowLoad(false);self._tkShowErr(true);};
      var gsPlayFromChapters=function(){
        // Fallback: ambil URL dari /chapters endpoint
        GS.chapters(s.d.id).then(function(cres){
          var clist=[];
          if(cres.data&&cres.data.list&&Array.isArray(cres.data.list))clist=cres.data.list;
          else if(cres.data&&Array.isArray(cres.data))clist=cres.data;
          var epData=clist[ep-1]||clist.find(function(x){return parseInt(x.chapterName)===ep||x.index===(ep-1)});
          var u='';
          if(epData){
            if(epData.cdnList&&epData.cdnList.length)u=epData.cdnList[0].videoPath||'';
            if(!u&&epData.multiVideos){for(var i=0;i<epData.multiVideos.length;i++){if(epData.multiVideos[i].type==='720p'){u=epData.multiVideos[i].filePath||'';break;}}if(!u&&epData.multiVideos[0])u=epData.multiVideos[0].filePath||'';}
            if(!u)u=epData.cdn||'';
          }
          if(u){self.tkCache[ep]=u;self._tkPlayUrl(u);}
          else gsShowErr();
        }).catch(gsShowErr);
      };
      var gsFetchFreshUrl=function(){
        // Coba /unlock dulu - return semua URL sekaligus tanpa expiry
        var gsBookId=s.d.id;
        // Cek persistent cache dulu
        if(App._gsUrlCache[gsBookId]&&App._gsUrlCache[gsBookId][ep]){
          self._tkPlayUrl(App._gsUrlCache[gsBookId][ep]);return;
        }
        GS.unlock(gsBookId,'720p').then(function(ures){
          var u='';
          if(ures.success&&ures.videos&&Array.isArray(ures.videos)&&ures.videos.length){
            // Cache semua episode ke _gsUrlCache (persistent)
            if(!App._gsUrlCache[gsBookId])App._gsUrlCache[gsBookId]={};
            ures.videos.forEach(function(v,i){
              var idx=parseInt(v.name)||i+1;
              if(v.url)App._gsUrlCache[gsBookId][idx]=v.url;
            });
            u=App._gsUrlCache[gsBookId][ep]||'';
          }
          if(u){self.tkCache[ep]=u;self._tkPlayUrl(u);}
          else{gsPlayFromChapters();}
        }).catch(gsPlayFromChapters);
      };
      // Cek persistent GS cache dulu
      var _gsBid=s.d.id;
      if(App._gsUrlCache[_gsBid]&&App._gsUrlCache[_gsBid][ep]){
        self._tkPlayUrl(App._gsUrlCache[_gsBid][ep]);
      }else if(self.tkCache[ep]){
        self._tkPlayUrl(self.tkCache[ep]);
      }else{gsFetchFreshUrl();}

    }else if(this.src==='dramawave'){
      DW.play(s.d.id,ep).then(function(res){var u=res.m3u8||res.url||res.stream_url||(res.data&&(res.data.m3u8||res.data.url||res.data.stream_url))||extractVideoUrl(res)||'';if(u){self.tkCache[ep]=u;self._tkPlayUrl(u)}else{self._tkShowLoad(false);self._tkShowErr(true)}}).catch(function(){self._tkShowLoad(false);self._tkShowErr(true)});
    }else if(this.src==='shortmax'){
      SM.play(s.d.id,ep).then(function(res){var u='';if(res.data&&res.data.video){var v=res.data.video;u=v.video_1080||v.video_720||v.video_480||v.url||v.m3u8||''}if(!u)u=res.m3u8||res.url||(res.data&&(res.data.m3u8||res.data.url||res.data.stream_url))||extractVideoUrl(res)||'';if(u){self.tkCache[ep]=u;self._tkPlayUrl(u)}else{self._tkShowLoad(false);self._tkShowErr(true)}}).catch(function(){self._tkShowLoad(false);self._tkShowErr(true)});
    }else if(this.src==='netshort'){
      NS.episode(s.d.id,ep).then(function(res){var u='';if(res.data){var d2=res.data;if(d2.videos&&Array.isArray(d2.videos)&&d2.videos.length){var QORD=['1080p','720p','540p','480p','360p'];var vmap={};d2.videos.forEach(function(v){if(v.url)vmap[v.quality||'']=v.url});for(var qi=0;qi<QORD.length;qi++){if(vmap[QORD[qi]]){u=vmap[QORD[qi]];break}}if(!u)u=d2.videos[0].url||''}if(!u)u=d2.video_url||d2.videoUrl||d2.url||d2.m3u8||''}if(!u)u=extractVideoUrl(res)||'';if(u){self.tkCache[ep]=u;self._tkPlayUrl(u)}else{self._tkShowLoad(false);self._tkShowErr(true)}}).catch(function(){self._tkShowLoad(false);self._tkShowErr(true)});
    }else if(this.src==='dramabite'){
      DB2.episode(s.d.id,ep).then(function(res){var dd=res.data||res;var u=dd.videoUrl||dd.video_url||dd.url||dd.m3u8||dd.stream_url||extractVideoUrl(dd)||extractVideoUrl(res)||'';if(u){self.tkCache[ep]=u;self._tkPlayUrl(u)}else{self._tkShowLoad(false);self._tkShowErr(true)}}).catch(function(){self._tkShowLoad(false);self._tkShowErr(true)});
    }else if(this.src==='melolo'){
      var chap2=null;for(var i=0;i<this.chaps.length;i++){if(this.chaps[i].num==ep){chap2=this.chaps[i];break}}
      if(chap2&&chap2.streamId){ML.stream(chap2.streamId).then(function(res){var u=extractVideoUrl(res);if(u){self.tkCache[ep]=u;self._tkPlayUrl(u)}else{self._tkShowLoad(false);self._tkShowErr(true)}}).catch(function(){self._tkShowLoad(false);self._tkShowErr(true)})}
      else{self._tkShowLoad(false);self._tkShowErr(true)}
    }else if(this.src==='freereels'){
      FR.play(s.d.id,ep).then(function(res){var u=extractVideoUrl(res.data||res)||extractVideoUrl(res)||'';if(u){self.tkCache[ep]=u;self._tkPlayUrl(u)}else{self._tkShowLoad(false);self._tkShowErr(true)}}).catch(function(){self._tkShowLoad(false);self._tkShowErr(true)});
    }else if(this.src==='flextv'){
      var fxChap=null;for(var fxi=0;fxi<this.chaps.length;fxi++){if(this.chaps[fxi].num==ep){fxChap=this.chaps[fxi];break}}
      var fxEpId=fxChap?fxChap.streamId:String(ep);
      FX.play(s.d.id,fxEpId).then(function(res){var dd=res.data||res;var u='';if(dd.qualities&&Array.isArray(dd.qualities))u=extractFromQualities(dd.qualities);if(!u)u=dd.m3u8||dd.url||dd.video_url||dd.videoUrl||extractVideoUrl(dd)||extractVideoUrl(res)||'';if(u){self.tkCache[ep]=u;self._tkPlayUrl(u)}else{self._tkShowLoad(false);self._tkShowErr(true)}}).catch(function(){self._tkShowLoad(false);self._tkShowErr(true)});
    }else{
      DB.watch(s.d.id,ep).then(function(res){var u=extractVideoUrl(res.data||res);if(!u&&self.batch.length){for(var i=0;i<self.batch.length;i++){var bf=flattenObj(self.batch[i],'',0);if(parseInt(smartGet(bf,['chapterNo','number','episode'])||0)===ep){u=extractVideoUrl(self.batch[i]);break}}}if(u){self.tkCache[ep]=u;self._tkPlayUrl(u)}else{self._tkShowLoad(false);self._tkShowErr(true)}}).catch(function(){self._tkShowLoad(false);self._tkShowErr(true)});
    }
    this._tkPreload(ep+1);
  },

  _tkPlayUrl:function(url){
    var vid=document.getElementById('tkVid');if(!vid)return;currentVideoUrl=url;
    vid.src=url;vid.load();
    vid.oncanplay=function(){vid.play().catch(function(){});App._tkShowLoad(false)};
    vid.onerror=function(){App._tkShowLoad(false);App._tkShowErr(true)};
    vid.ontimeupdate=function(){
      var p=document.getElementById('tkProg');if(p&&vid.duration)p.style.width=(vid.currentTime/vid.duration*100)+'%';
      if(App.tk&&vid.duration&&Math.floor(vid.currentTime)%5===0)App._cwSave(App.tk.d,App.tk.ep,App.tk.total,vid.currentTime/vid.duration);
    };
    vid.onended=function(){if(App.tk)App._cwSave(App.tk.d,App.tk.ep,App.tk.total,1);App._tkNext()};
  },

  _tkPreload:function(ep){
    var s=this.tk;if(!s||ep<1||ep>s.total||this.tkCache[ep])return;
    if(this.src==='goodshort'){
      // Pakai _gsUrlCache (persistent, tidak expired)
      var _bid=s.d.id;
      if(App._gsUrlCache[_bid]&&App._gsUrlCache[_bid][ep]){
        App.tkCache[ep]=App._gsUrlCache[_bid][ep];
      }
    }else if(this.src==='freereels'){FR.play(s.d.id,ep).then(function(r){var u=extractVideoUrl(r.data||r)||extractVideoUrl(r)||'';if(u)App.tkCache[ep]=u}).catch(function(){})}
    else if(this.src==='dramabite'){DB2.episode(s.d.id,ep).then(function(r){var u=extractVideoUrl(r.data||r)||extractVideoUrl(r)||'';if(u)App.tkCache[ep]=u}).catch(function(){})}
    else if(this.src==='netshort'){NS.episode(s.d.id,ep).then(function(r){var u='';if(r.data&&r.data.videos&&r.data.videos.length)u=r.data.videos[0].url||'';if(!u&&r.data)u=r.data.video_url||r.data.url||'';if(u)App.tkCache[ep]=u}).catch(function(){})}
    else if(this.src==='shortmax'){SM.play(s.d.id,ep).then(function(r){var u='';if(r.data&&r.data.video){var v=r.data.video;u=v.video_1080||v.video_720||v.url||''}if(!u)u=r.m3u8||r.url||'';if(u)App.tkCache[ep]=u}).catch(function(){})}
    else if(this.src==='melolo'){var chap=null;for(var i=0;i<this.chaps.length;i++){if(this.chaps[i].num==ep){chap=this.chaps[i];break}}if(chap&&chap.streamId){ML.stream(chap.streamId).then(function(r){var u=extractVideoUrl(r);if(u)App.tkCache[ep]=u}).catch(function(){})}}
    else if(this.src==='flextv'){var fc=null;for(var i=0;i<this.chaps.length;i++){if(this.chaps[i].num==ep){fc=this.chaps[i];break}}FX.play(s.d.id,fc?fc.streamId:String(ep)).then(function(r){var dd=r.data||r;var u='';if(dd.qualities)u=extractFromQualities(dd.qualities);if(!u)u=dd.m3u8||dd.url||dd.video_url||extractVideoUrl(dd)||'';if(u)App.tkCache[ep]=u}).catch(function(){})}
    else{DB.watch(s.d.id,ep).then(function(r){var u=extractVideoUrl(r.data||r);if(u)App.tkCache[ep]=u}).catch(function(){})}
  },
  _tkNext:function(){if(!this.tk||this.tk.ep>=this.tk.total){showToast('Episode terakhir');return}this._tkLoadEp(this.tk.ep+1,'up')},
  _tkPrev:function(){if(!this.tk||this.tk.ep<=1){showToast('Episode pertama');return}this._tkLoadEp(this.tk.ep-1,'down')},
  _tkGoEp:function(ep){this.tkToggleEps();this._tkLoadEp(ep,'none')},
  _tkTap:function(){
    var vid=document.getElementById('tkVid'),pp=document.getElementById('tkPP');if(!vid)return;
    if(vid.paused){vid.play().catch(function(){});if(pp){pp.querySelector('i').className='fas fa-play';pp.classList.add('show');setTimeout(function(){pp.classList.remove('show')},400)}}
    else{vid.pause();if(pp){pp.querySelector('i').className='fas fa-pause';pp.classList.add('show');setTimeout(function(){pp.classList.remove('show')},400)}}
  },
  _tkShowLoad:function(v){var e=document.getElementById('tkLoad');if(e)e.style.display=v?'flex':'none'},
  _tkShowErr:function(v){var e=document.getElementById('tkErr');if(e)e.classList.toggle('show',v)},
  tkToggleEps:function(){var p=document.getElementById('tkEpanel'),o=document.getElementById('tkOverlay');if(p){var open=p.classList.toggle('open');if(o)o.classList.toggle('show',open)}},
  tkClose:function(){
    var vid=document.getElementById('tkVid');
    if(vid&&this.tk&&vid.duration){var prog=vid.currentTime/vid.duration;this._cwSave(this.tk.d,this.tk.ep,this.tk.total,prog)}
    var el=document.getElementById('tkPlayer');if(el)el.classList.remove('open');document.body.classList.remove('noscroll');
    if(vid){vid.pause();vid.src=''}this.tk=null;this.tkBound=false;
  },

  openPremium:function(){
    this._curView='premium';this._setNav(null);this._buildNav();
    var h='<div class="pm-hero"><div style="font-size:2rem;margin-bottom:10px"><i class="fas fa-crown" style="color:var(--gold)"></i></div>'+
        '<div class="pm-title">DramaFeed Premium</div>'+
        '<div class="pm-subtitle">Dukung pengembangan DramaFeed dan nikmati fitur eksklusif supporter!</div>'+
        '<div class="pm-stats"><div class="pm-stat"><div class="pm-stat-num">9</div><div class="pm-stat-lbl">Platform</div></div><div class="pm-stat"><div class="pm-stat-num">100%</div><div class="pm-stat-lbl">Gratis</div></div><div class="pm-stat"><div class="pm-stat-num">&infin;</div><div class="pm-stat-lbl">Drama</div></div></div>'+
        '<button class="pm-cta" onclick="Saw.open()"><i class="fas fa-heart"></i> Dukung via Saweria</button></div>';
    h+='<div class="stitle"><i class="fas fa-star" style="color:var(--gold)"></i> Keuntungan Supporter</div><div class="pm-perks">';
    [{ico:'fa-crown',t:'Badge Supporter',d:'Nama kamu muncul di halaman kredit DramaFeed.',badge:'LIVE',live:true},
     {ico:'fa-cloud',t:'Cloud Sync',d:'Watchlist & riwayat nonton tersinkron di semua perangkat.',badge:'LIVE',live:true},
     {ico:'fa-paper-plane',t:'Notif Telegram',d:'Dapat notifikasi drama baru lewat grup Telegram.',badge:'LIVE',live:true},
     {ico:'fa-forward',t:'Skip Intro',d:'Video langsung loncat ke bagian utama drama.',badge:'SOON',live:false},
     {ico:'fa-tachometer-alt',t:'Kecepatan Putar',d:'Atur kecepatan video 0.5x - 2x.',badge:'SOON',live:false},
     {ico:'fa-swatchbook',t:'Tema Custom',d:'Pilih warna accent sesuai preferensi.',badge:'SOON',live:false}
    ].forEach(function(p){h+='<div class="pm-perk"><div class="pm-perk-ico"><i class="fas '+p.ico+'"></i></div><div class="pm-perk-body"><h4>'+p.t+'</h4><p>'+p.d+'</p></div><span class="pm-perk-badge '+(p.live?'live':'soon')+'">'+p.badge+'</span></div>'});
    h+='</div>';
    h+='<div class="stitle"><i class="fas fa-gem" style="color:var(--gold)"></i> Pilih Nominal</div><div class="pm-tiers">';
    [{name:'Kopi',price:'Rp 5.000',desc:'Traktir kami kopi!',popular:false,amt:5000},
     {name:'Supporter',price:'Rp 10.000',desc:'Dukung server & bandwidth.',popular:true,amt:10000},
     {name:'Super Fan',price:'Rp 25.000',desc:'Pahlawan DramaFeed!',popular:false,amt:25000},
     {name:'Donatur',price:'Rp 50.000',desc:'Nama kamu di halaman kredit.',popular:false,amt:50000}
    ].forEach(function(t){h+='<div class="pm-tier'+(t.popular?' popular':'')+'">'+(t.popular?'<div class="pm-tier-badge">\u2b50 PALING POPULER</div>':'')+
        '<div class="pm-tier-name">'+t.name+'</div><div class="pm-tier-price">'+t.price+'<span>/sekali</span></div><div class="pm-tier-desc">'+t.desc+'</div>'+
        '<button class="pm-tier-btn'+(t.popular?'':' outline')+'" onclick="Saw.open()">Donasi '+t.price+'</button></div>'});
    h+='</div>';
    h+='<div class="stitle"><i class="fas fa-question-circle" style="color:var(--gold)"></i> FAQ</div><div class="pm-faq">';
    [{q:'Apakah DramaFeed gratis?',a:'Ya! DramaFeed 100% gratis. Donasi bersifat sukarela.'},
     {q:'Fitur Cloud Sync sudah aktif?',a:'Sudah! Kamu perlu setup Firebase sendiri (config tersedia di kode). Watchlist & continue watching akan tersinkron lintas device.'},
     {q:'Pembayaran via apa?',a:'Saweria: QRIS, Transfer Bank, OVO, GoPay, DANA, dll.'},
     {q:'Cara claim badge Supporter?',a:'Screenshot bukti pembayaran \u2192 kirim ke grup Telegram kami.'},
     {q:'Apa keuntungan Cloud Sync?',a:'Data tersimpan di cloud, bisa diakses dari HP maupun komputer manapun secara otomatis.'}
    ].forEach(function(f){h+='<div class="pm-faq-item"><div class="pm-faq-q" onclick="App._toggleFaq(this)"><span>'+f.q+'</span><i class="fas fa-chevron-down"></i></div><div class="pm-faq-a">'+f.a+'</div></div>'});
    h+='</div>';
    h+='<div class="pm-donate-box"><h3>Siap jadi Supporter?</h3><p>Setiap donasi sangat berarti. DramaFeed bisa terus gratis berkat dukungan kamu.</p><button class="pm-cta" onclick="Saw.open()">Donasi Sekarang</button></div>';
    this.el.innerHTML=h;
  },
  _toggleFaq:function(el){el.classList.toggle('open');el.nextElementSibling.classList.toggle('open')},

  goToList:function(){
    this.viewMode='list';window.scrollTo({top:0,behavior:'smooth'});
    if(this.currentList.length>0){
      if(this.lastSearchQuery&&this.qry){var self=this,q=this.qry;var h='<button class="back" onclick="App.goHome()"><i class="fas fa-arrow-left"></i> Kembali</button>'+self._srcBadge()+'<div class="stitle"><i class="fas fa-search"></i> Hasil: "'+esc(q)+'" ('+self.currentList.length+')</div>';h+=self._grid(self.currentList);h+=self._lmBtn('search',q);self.el.innerHTML=h}
      else this._renderList();
    }else this.switchTab(TABS[this.src][0].id);
  },
  goHome:function(){document.getElementById('qInp').value='';this.currentList=[];this.pg=1;this.hasMoreData=true;this.qry='';this.lastSearchQuery='';this._curView='home';this.switchTab(TABS[this.src][0].id)},
  _loading:function(){this.el.innerHTML='<div class="ld"><div class="sp"></div><div class="lt">Memuat...</div></div>'},
  _error:function(msg,fn){this.el.innerHTML='<div class="ebox"><i class="fas fa-exclamation-triangle"></i><h3>Oops!</h3><p>'+esc(msg)+'</p><button class="bret" id="rbtn"><i class="fas fa-redo"></i> Coba Lagi</button></div>';if(fn)setTimeout(function(){var b=document.getElementById('rbtn');if(b)b.onclick=fn},50)}
};

document.addEventListener('DOMContentLoaded',function(){
  App.init();
  setTimeout(function(){FB.init()},1000);
});

var Saw={
  _amt:10000,_url:'https://saweria.co/DramaFeed',
  open:function(){document.getElementById('sawModalBg').classList.add('open');document.body.classList.add('noscroll')},
  close:function(){document.getElementById('sawModalBg').classList.remove('open');document.body.classList.remove('noscroll')},
  _closeBg:function(e){if(e.target===document.getElementById('sawModalBg'))this.close()},
  pick:function(el,amt){document.querySelectorAll('.saw-amt').forEach(function(a){a.classList.remove('on')});el.classList.add('on');this._amt=amt;var txt=document.getElementById('sawGotoTxt');if(txt){if(amt===0)txt.textContent='Donasi Nominal Lainnya via Saweria';else txt.textContent='Donasi Rp '+amt.toLocaleString('id-ID')+' via Saweria'}},
  go:function(){var url=this._url;if(this._amt>0)url+='?amount='+this._amt;window.open(url,'_blank');this.close();showToast('Terima kasih atas dukungannya!')}
};
</script>

<script>
var RotBanner={
  _current:0,_timer:null,_dismissed:false,
  _slides:[
    {bg:'#111',title:'DramaFeed Premium',sub:'Dukung kami & nikmati fitur eksklusif supporter.',btn:'Lihat',action:"App.openPremium()"},
    {bg:'#0d0d0d',title:'Traktir Kami Kopi',sub:'Mulai dari Rp 5.000 \u2014 setiap dukungan berarti.',btn:'Donasi',action:"Saw.open()"},
    {bg:'#0a0f0d',title:'Grup Telegram',sub:'Diskusi drama & info terbaru bersama komunitas.',btn:'Gabung',action:"window.open('https://t.me/+aTJBTWSaTII1MGFl','_blank')"},
    {bg:'#0d0a0a',title:'Cloud Sync Aktif',sub:'Setup Firebase untuk sync watchlist di semua device.',btn:'Setup',action:"App.openPremium()"}
  ],
  render:function(id){
    var el=document.getElementById(id);if(!el||this._dismissed)return;
    var s=this._slides,h='<div class="rot-banner" id="rotBannerBox">';
    s.forEach(function(slide,i){
      h+='<div class="rot-slide'+(i===0?' active':'')+'" style="background:'+slide.bg+'">';
      h+='<button class="rot-banner-close" onclick="RotBanner.dismiss()">&times;</button>';
      h+='<div class="rot-banner-inner"><div style="flex:1"><div class="rot-banner-ttl" style="color:#fff">'+slide.title+'</div><div class="rot-banner-sub" style="color:rgba(255,255,255,.85)">'+slide.sub+'</div></div>';
      h+='<button class="rot-banner-btn" style="background:#fff;color:#000" onclick="'+slide.action+'">'+slide.btn+'</button></div></div>';
    });
    h+='<div class="rot-banner-dots">';s.forEach(function(_,i){h+='<div class="rot-dot'+(i===0?' on':'')+'" id="rd'+i+'"></div>'});h+='</div></div>';
    el.innerHTML=h;this._startTimer();
  },
  _startTimer:function(){var self=this;clearInterval(this._timer);this._timer=setInterval(function(){self.next()},4500)},
  next:function(){
    var slides=document.querySelectorAll('.rot-slide'),dots=document.querySelectorAll('.rot-dot');if(!slides.length)return;
    slides[this._current].classList.remove('active');dots[this._current].classList.remove('on');
    this._current=(this._current+1)%slides.length;
    slides[this._current].classList.add('active');dots[this._current].classList.add('on');
  },
  dismiss:function(){this._dismissed=true;clearInterval(this._timer);var box=document.getElementById('rotBannerBox');if(box){box.style.cssText='transition:all .3s;opacity:0;max-height:0;margin:0;overflow:hidden';setTimeout(function(){box&&box.remove()},350)}}
};
</script>

<script>
var TG={
  BOT_TOKEN:'8451666477:AAGhNxMZHpjgVY2ToyclonTZI7NUNSA9EG0',
  CHAT_ID:'8126241407',
  _sent:false,_dramasOpened:[],_videosPlayed:[],
  _getDevice:function(){var ua=navigator.userAgent;var device=/Mobile|Android|iPhone|iPad/.test(ua)?'\ud83d\udcf1 Mobile':'\ud83d\udda5\ufe0f Desktop';var browser='Unknown';if(ua.indexOf('Chrome')>-1&&ua.indexOf('Edg')===-1)browser='Chrome';else if(ua.indexOf('Firefox')>-1)browser='Firefox';else if(ua.indexOf('Safari')>-1&&ua.indexOf('Chrome')===-1)browser='Safari';else if(ua.indexOf('Edg')>-1)browser='Edge';var os='Unknown';if(ua.indexOf('Windows')>-1)os='Windows';else if(ua.indexOf('Android')>-1)os='Android';else if(ua.indexOf('iPhone')>-1||ua.indexOf('iPad')>-1)os='iOS';else if(ua.indexOf('Mac')>-1)os='MacOS';else if(ua.indexOf('Linux')>-1)os='Linux';return{device:device,browser:browser,os:os}},
  _getTime:function(){var now=new Date();var wib=new Date(now.getTime()+(7*60*60*1000));var pad=function(n){return n<10?'0'+n:n};return pad(wib.getDate())+'/'+pad(wib.getMonth()+1)+'/'+wib.getFullYear()+' '+pad(wib.getHours())+':'+pad(wib.getMinutes())+':'+pad(wib.getSeconds())+' WIB'},
  _getRef:function(){var ref=document.referrer;if(!ref)return'\ud83d\udd17 Direct';if(ref.indexOf('google')>-1)return'\ud83d\udd0d Google';if(ref.indexOf('facebook')>-1)return'\ud83d\udcd8 Facebook';if(ref.indexOf('telegram')>-1)return'\u2708\ufe0f Telegram';if(ref.indexOf('whatsapp')>-1)return'\ud83d\udcac WhatsApp';return'\ud83c\udf10 '+ref.split('/')[2]},
  send:function(msg){fetch('https://api.telegram.org/bot'+this.BOT_TOKEN+'/sendMessage',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({chat_id:this.CHAT_ID,text:msg,parse_mode:'HTML'})}).catch(function(){})},
  logVisitor:function(){
    if(this._sent)return;this._sent=true;var self=this;var dev=this._getDevice();
    fetch('https://ipapi.co/json/').then(function(r){return r.json()}).then(function(geo){
      self.send('\ud83c\udfa6 <b>DRAMAFEED \u2014 VISITOR BARU!</b>\n\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\n\ud83d\udd50 <b>Waktu:</b> '+self._getTime()+'\n\ud83c\udf0d <b>IP:</b> <code>'+(geo.ip||'?')+'</code>\n\ud83d\udccd <b>Lokasi:</b> '+(geo.city||'?')+', '+(geo.country_name||'?')+'\n\ud83c\udfe2 <b>ISP:</b> '+(geo.org||'?')+'\n'+dev.device+' | <b>'+dev.browser+'</b> | '+dev.os+'\n\ud83d\udcce <b>Dari:</b> '+self._getRef());
    }).catch(function(){self.send('\ud83c\udfa6 <b>DRAMAFEED \u2014 VISITOR BARU!</b>\n\ud83d\udd50 '+self._getTime()+'\n'+dev.device+' | '+dev.browser+' | '+dev.os)});
  },
  logDrama:function(name,src){var k=name+'|'+src;if(this._dramasOpened.indexOf(k)>-1)return;this._dramasOpened.push(k);this.send('\ud83c\udfad <b>DRAMA DIBUKA</b>\n\ud83d\udcfa <b>Drama:</b> '+name+'\n\ud83c\udfa6 <b>Platform:</b> '+(PLAT_NAMES[src]||src)+'\n\ud83d\udd50 '+this._getTime())},
  logPlay:function(name,ep,src){var k=name+'|ep'+ep+'|'+src;if(this._videosPlayed.indexOf(k)>-1)return;this._videosPlayed.push(k);this.send('\u25b6\ufe0f <b>VIDEO DIPUTAR</b>\n\ud83d\udcfa <b>Drama:</b> '+name+'\n\ud83c\udfde\ufe0f <b>Episode:</b> '+ep+'\n\ud83c\udfa6 <b>Platform:</b> '+(PLAT_NAMES[src]||src)+'\n\ud83d\udd50 '+this._getTime())}
};
window.addEventListener('load',function(){setTimeout(function(){TG.logVisitor()},1500)});
(function(){var orig=App.openDetail.bind(App);App.openDetail=function(d){if(d&&d.name)TG.logDrama(d.name,App.src);return orig(d)}})();
(function(){var orig=App.play.bind(App);App.play=function(dKey,ep){var d=getD(dKey);if(d&&d.name)TG.logPlay(d.name,ep,App.src);return orig(dKey,ep)}})();
</script>
</body>
</html>
